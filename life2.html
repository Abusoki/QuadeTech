<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Companion</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar for dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Rotation Classes */
        .rotate-0 { transform: rotate(0deg); }
        .rotate-90 { transform: rotate(90deg); }
        .rotate-180 { transform: rotate(180deg); }
        .rotate-270 { transform: rotate(270deg); }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, addDoc, deleteDoc, serverTimestamp, query, orderBy, limit, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const { useState, useEffect, useRef, useMemo } = React;

        // --- Configuration & Global Variables ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E",
      authDomain: "mtg-life-tool.firebaseapp.com",
      projectId: "mtg-life-tool",
      storageBucket: "mtg-life-tool.appspot.com",
      messagingSenderId: "36730058988",
      appId: "1:36730058988:web:757e2d9620593b4f65022a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Icons ---
        const Icon = ({ path, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {path}
            </svg>
        );

        const Icons = {
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            Shield: (p) => <Icon {...p} path={<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>} />,
            Skull: (p) => <Icon {...p} path={<><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M15 22a1 1 0 0 0 1-1v-1a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20v1a1 1 0 0 0 1 1z"/><circle cx="15" cy="12" r="1"/><circle cx="9" cy="12" r="1"/></>} />,
            Menu: (p) => <Icon {...p} path={<><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Wifi: (p) => <Icon {...p} path={<><path d="M12 20h.01"/><path d="M2 8.82a15 15 0 0 1 20 0"/><path d="M5 12.859a10 10 0 0 1 14 0"/><path d="M8.5 16.429a5 5 0 0 1 7 0"/></>} />,
            RotateCcw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />,
            Crown: (p) => <Icon {...p} path={<path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7z"/>} />,
            ExternalLink: (p) => <Icon {...p} path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>} />,
            BarChart2: (p) => <Icon {...p} path={<><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />,
            Lightbulb: (p) => <Icon {...p} path={<><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-2.2-1.8-4-4-4s-4 1.8-4 4c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></>} />,
            Loader2: (p) => <Icon {...p} className={`${p.className || ''} animate-spin`} path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} />,
            Mail: (p) => <Icon {...p} path={<><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></>} />,
            Sliders: (p) => <Icon {...p} path={<><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="1" x2="7" y1="14" y2="14"/><line x1="9" x2="15" y1="8" y2="8"/><line x1="17" x2="23" y1="16" y2="16"/></>} />,
            Sword: (p) => <Icon {...p} path={<><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></>} />,
            Droplet: (p) => <Icon {...p} path={<path d="M12 22a7 7 0 0 0 7-7c0-2-2-3-2-3L12 2 7 12s-2 1-2 3a7 7 0 0 0 7 7z"/>} />,
            RotateCw: (p) => <Icon {...p} path={<><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>} />,
            Unlock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></>} />,
            Share: (p) => <Icon {...p} path={<><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></>} />,
            Copy: (p) => <Icon {...p} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />
        };

        // --- Gemini API Utility ---
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; 

        const geminiApiCall = async (userQuery, systemPrompt) => {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const MAX_RETRIES = 5;
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; 
                        }
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources };
                    }
                    throw new Error("Gemini API response missing text content.");
                } catch (error) {
                    console.error(`Gemini API call failed (Attempt ${attempt + 1}):`, error.message);
                    if (attempt === MAX_RETRIES - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        // --- Helpers ---
        // Helper to update persistent historical stats
        const updateCommanderStat = async (commander) => {
            if (!commander || !commander.name) return;
            // Reference to the persistent historical stats collection
            const statRef = doc(db, 'artifacts', appId, 'public', 'data', 'commander_stats', commander.name);
            try {
                // Using increment(1) for atomic updates
                await setDoc(statRef, {
                    name: commander.name,
                    image: commander.image, // Overwrite with latest image url if needed
                    fullImage: commander.fullImage,
                    artist: commander.artist || 'Unknown',
                    count: increment(1),
                    lastPlayed: serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.error("Error updating stats:", e);
            }
        };

        // --- Components ---

        // 1. Commander Search
        const CommanderSearch = ({ onSelect, onClose }) => {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const debounceRef = useRef(null);

            const searchScryfall = async (q) => {
                if (!q || q.length < 3) {
                    setResults([]);
                    return;
                }
                setLoading(true);
                try {
                    const response = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(q + ' (is:commander) (game:paper)')}`);
                    const data = await response.json();
                    if (data.data) {
                        setResults(data.data.slice(0, 20));
                    } else {
                        setResults([]);
                    }
                } catch (e) {
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            };

            const handleInput = (e) => {
                const val = e.target.value;
                setQuery(val);
                clearTimeout(debounceRef.current);
                debounceRef.current = setTimeout(() => searchScryfall(val), 500);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-slate-900 w-full max-w-lg rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="p-4 border-b border-slate-700 flex items-center gap-3">
                            <Icons.Search className="text-slate-400 w-5 h-5" />
                            <input
                                type="text"
                                placeholder="Search Commander..."
                                className="bg-transparent border-none outline-none text-white w-full placeholder:text-slate-500"
                                value={query}
                                onChange={handleInput}
                                autoFocus
                            />
                            <button onClick={onClose}><Icons.X className="text-slate-400 hover:text-white w-5 h-5" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                            {loading && <div className="text-center text-slate-500 py-8">Searching Scryfall...</div>}
                            {!loading && results.length === 0 && query.length > 2 && <div className="text-center text-slate-500 py-8">No commanders found.</div>}
                            {results.map((card) => (
                                <div
                                    key={card.id}
                                    onClick={() => onSelect({
                                        name: card.name,
                                        image: card.image_uris?.art_crop || card.card_faces?.[0]?.image_uris?.art_crop || '',
                                        fullImage: card.image_uris?.large || card.card_faces?.[0]?.image_uris?.large || '',
                                        artist: card.artist || card.card_faces?.[0]?.artist || 'Unknown'
                                    })}
                                    className="flex items-center gap-4 p-2 hover:bg-slate-800 rounded-lg cursor-pointer transition-colors group"
                                >
                                    <div className="w-12 h-12 rounded-full overflow-hidden bg-slate-800 shrink-0 border border-slate-700 group-hover:border-purple-500">
                                        {(card.image_uris?.art_crop || card.card_faces?.[0]?.image_uris?.art_crop) ? (
                                            <img src={card.image_uris?.art_crop || card.card_faces?.[0]?.image_uris?.art_crop} alt={card.name} className="w-full h-full object-cover" />
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center text-xs text-slate-600">?</div>
                                        )}
                                    </div>
                                    <div className="text-sm font-medium text-slate-200 group-hover:text-purple-400">{card.name}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Commander Assistant
        const CommanderAssistant = ({ commander, onClose }) => {
            const [strategyText, setStrategyText] = useState(null);
            const [loading, setLoading] = useState(true);
            const [sources, setSources] = useState([]);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchStrategy = async () => {
                    setLoading(true);
                    setError(null);
                    setStrategyText(null);
                    setSources([]);
                    
                    const userQuery = `Act as an expert Magic: The Gathering strategy guide writer. Provide a concise summary of the commander named ${commander.name}. Then, list the top 3 core strategies or win conditions typically employed by decks built around this commander. Include an example of a key synergistic card or combo piece for each strategy. Format the response purely as a paragraph followed by a list of three main strategies.`;
                    const systemPrompt = "You are a helpful and knowledgeable Magic: The Gathering commander strategy guide assistant. You must use Google Search to ground your answers in current MTG community knowledge.";

                    try {
                        const { text, sources } = await geminiApiCall(userQuery, systemPrompt);
                        setStrategyText(text);
                        setSources(sources);
                    } catch (err) {
                        setError("Failed to fetch strategy information. Please try again.");
                        console.error("Gemini Error:", err);
                    } finally {
                        setLoading(false);
                    }
                };

                if (commander?.name) {
                    fetchStrategy();
                }
            }, [commander.name]);

            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-slate-900 w-full max-w-2xl rounded-2xl border border-purple-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-purple-700 flex justify-between items-center bg-slate-800">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                <Icons.Lightbulb className="text-yellow-400 w-5 h-5" />
                                Commander Strategy Assistant
                            </h2>
                            <button onClick={onClose} className="p-1 rounded-full text-slate-400 hover:text-white hover:bg-slate-700 transition-colors"><Icons.X className="w-5 h-5" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="flex items-center mb-6 gap-4">
                                <div className="w-20 h-20 rounded-lg overflow-hidden border-2 border-purple-500 shadow-lg">
                                    <img src={commander.image || commander.fullImage} alt={commander.name} className="w-full h-full object-cover" />
                                </div>
                                <h3 className="text-2xl font-extrabold text-purple-400">{commander.name}</h3>
                            </div>
                            {loading && (
                                <div className="flex flex-col items-center justify-center py-12 text-purple-400">
                                    <Icons.Loader2 className="w-8 h-8 animate-spin mb-4" />
                                    <p>Analyzing the Commander Meta...</p>
                                </div>
                            )}
                            {error && (
                                <div className="text-red-400 bg-red-900/30 p-4 rounded-lg text-center">{error}</div>
                            )}
                            {strategyText && (
                                <div className="text-slate-300 space-y-6">
                                    <div className="prose prose-invert leading-relaxed">
                                        {strategyText.split('\n').map((line, index) => {
                                            if (line.trim().startsWith('*')) {
                                                return <li key={index} className="ml-5 mt-2 text-base text-white">{line.trim().substring(1).trim()}</li>;
                                            }
                                            return <p key={index}>{line}</p>;
                                        })}
                                    </div>
                                    {sources.length > 0 && (
                                        <div className="pt-4 border-t border-slate-700">
                                            <p className="text-xs font-semibold text-slate-500 mb-2">Grounded Sources:</p>
                                            <div className="space-y-1">
                                                {sources.map((source, index) => (
                                                    <a key={index} href={source.uri} target="_blank" rel="noopener noreferrer" className="flex items-center text-xs text-purple-400 hover:text-purple-300 truncate">
                                                        <Icons.ExternalLink className="w-3 h-3 mr-2 shrink-0" />
                                                        {source.title || source.uri}
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t border-slate-700 flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white font-medium">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Stats Page (Now pulls from persistent 'commander_stats')
        const StatsPage = ({ user }) => {
            const [stats, setStats] = useState({ topCommanders: [], topCommander: null });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) return;
                // Query the PERSISTENT historical stats collection
                const statsRef = collection(db, 'artifacts', appId, 'public', 'data', 'commander_stats');
                
                const unsubscribe = onSnapshot(statsRef, (snapshot) => {
                    const commanders = [];
                    snapshot.forEach(doc => {
                        commanders.push(doc.data());
                    });

                    // Sort by count descending
                    const sortedCommanders = commanders
                        .sort((a, b) => (b.count || 0) - (a.count || 0))
                        .slice(0, 5);

                    setStats({
                        topCommanders: sortedCommanders,
                        topCommander: sortedCommanders.length > 0 ? sortedCommanders[0] : null
                    });
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching stats:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            if (loading) return <div className="flex items-center justify-center h-full text-slate-400">Loading Stats...</div>;

            return (
                <div className="p-4 md:p-8 max-w-6xl mx-auto h-full overflow-y-auto">
                    <h1 className="text-3xl font-bold text-white mb-8 flex items-center gap-3">
                        <Icons.BarChart2 className="w-8 h-8 text-purple-500" />
                        Meta Statistics
                    </h1>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                        <div className="bg-slate-900/50 p-6 rounded-2xl border border-slate-700/50 backdrop-blur-sm">
                            <h2 className="text-xl font-semibold text-purple-300 mb-6 flex items-center justify-between">
                                <span>Top 5 Commanders</span>
                                <span className="text-xs font-normal text-slate-500 bg-slate-800 px-2 py-1 rounded-full">All Time</span>
                            </h2>
                            <div className="space-y-4">
                                {stats.topCommanders.length === 0 ? (
                                    <div className="text-slate-500 text-center py-10">No stats recorded yet. Play a game!</div>
                                ) : (
                                    stats.topCommanders.map((cmd, index) => (
                                        <div key={cmd.name} className="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl hover:bg-slate-800 transition-all border border-transparent hover:border-purple-500/30 group">
                                            <div className={`w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm ${index === 0 ? 'bg-yellow-500 text-black' : index === 1 ? 'bg-slate-400 text-black' : index === 2 ? 'bg-orange-700 text-white' : 'bg-slate-700 text-slate-400'}`}>{index + 1}</div>
                                            <div className="w-12 h-12 rounded-full overflow-hidden bg-black shrink-0">
                                                <img src={cmd.image} alt={cmd.name} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />
                                            </div>
                                            <div className="flex-1">
                                                <div className="text-white font-medium truncate">{cmd.name}</div>
                                                <div className="text-xs text-slate-400">{cmd.count} plays</div>
                                            </div>
                                            {index === 0 && <Icons.Crown className="w-5 h-5 text-yellow-500" />}
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                        <div className="relative group rounded-2xl overflow-hidden shadow-2xl border-4 border-slate-900 min-h-[400px] flex items-center justify-center bg-slate-900">
                            {stats.topCommander ? (
                                <>
                                    <img src={stats.topCommander.image} alt={stats.topCommander.name} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-90"></div>
                                    <div className="absolute bottom-0 left-0 right-0 p-8">
                                        <div className="flex items-center gap-2 text-yellow-500 mb-2 font-bold tracking-wider text-sm uppercase">
                                            <Icons.Crown className="w-4 h-4" />
                                            Most Popular Commander
                                        </div>
                                        <h2 className="text-4xl md:text-5xl font-black text-white leading-tight drop-shadow-lg">{stats.topCommander.name}</h2>
                                        <div className="mt-4 inline-flex items-center gap-2 bg-purple-600/90 text-white px-4 py-2 rounded-full backdrop-blur-md font-medium shadow-lg">
                                            {stats.topCommander.count} Total Picks
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div className="flex flex-col items-center justify-center text-slate-600 gap-4">
                                    <Icons.Shield className="w-20 h-20 opacity-20" />
                                    <p>Play games to reveal the top commander!</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Player Card (Updated with Rotation & Counters)
        const PlayerCard = ({ id, name, life, commander, color, poison = 0, commanderDamage = {}, onUpdate, onDead, isDead, isLocal, players = [] }) => {
            const [showCmdrSearch, setShowCmdrSearch] = useState(false);
            const [showAssistant, setShowAssistant] = useState(false);
            const [showTools, setShowTools] = useState(false);
            const [rotation, setRotation] = useState(0);

            const adjustLife = (amount) => {
                if (isDead) return;
                const newLife = life + amount;
                onUpdate(id, { life: newLife });
                if (newLife <= 0) onDead(id);
            };

            const adjustPoison = (amount) => {
                if (isDead) return;
                const newPoison = Math.max(0, (poison || 0) + amount);
                onUpdate(id, { poison: newPoison });
                if (newPoison >= 10) onDead(id);
            };

            const adjustCmdrDamage = (sourceId, amount) => {
                if (isDead) return;
                const current = commanderDamage[sourceId] || 0;
                const newDmg = Math.max(0, current + amount);
                const newMap = { ...commanderDamage, [sourceId]: newDmg };
                onUpdate(id, { commanderDamage: newMap });
                if (newDmg >= 21) onDead(id); // Commander damage kill rule
            };

            const toggleRotation = () => {
                setRotation(prev => (prev + 90) % 360);
            };

            // Calculate rotation style
            const rotateClass = `rotate-${rotation}`;

            return (
                <div className={`relative flex flex-col h-full rounded-2xl overflow-hidden transition-all duration-300 ${isDead ? 'opacity-50 grayscale' : ''} ${color}`}>
                    {/* Background Image Layer */}
                    {commander?.image && (
                        <div className="absolute inset-0 z-0">
                            <img src={commander.image} alt="bg" className="w-full h-full object-cover opacity-30 mix-blend-overlay" />
                            <div className="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/80" />
                        </div>
                    )}

                    {/* Static Rotation Button (Absolutely Positioned) */}
                    {isLocal && (
                        <div className="absolute top-4 right-4 z-50">
                            <button onClick={toggleRotation} className="p-2 bg-black/40 hover:bg-black/60 rounded-full text-white/90 transition-colors shadow-lg border border-white/10">
                                <Icons.RotateCcw className="w-4 h-4" />
                            </button>
                        </div>
                    )}

                    {/* Content Layer with Rotation Wrapper */}
                    <div className={`relative z-10 flex flex-col h-full p-4 transition-transform duration-300 ${rotateClass}`}>
                        
                        {/* Header */}
                        <div className="flex justify-between items-start">
                            <div className="flex flex-col items-start gap-1">
                                <div className="text-xs font-bold text-purple-300 drop-shadow-md px-1 max-w-[140px] truncate">{name}</div>
                                <button onClick={() => setShowCmdrSearch(true)} className="flex items-center gap-2 bg-black/20 hover:bg-black/40 px-3 py-1.5 rounded-full backdrop-blur-md transition-colors text-white group">
                                    {commander?.name ? (
                                        <span className="font-semibold text-sm truncate max-w-[120px]">{commander.name}</span>
                                    ) : (
                                        <span className="flex items-center gap-1 text-xs uppercase tracking-wide font-bold opacity-80"><Icons.Search className="w-3 h-3"/> Commander</span>
                                    )}
                                </button>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {/* Spacer for rotation button to avoid overlap if needed */}
                                {isLocal && <div className="w-8 h-8"></div>}
                                {isDead && <Icons.Skull className="text-red-500 w-6 h-6 animate-pulse" />}
                            </div>
                        </div>

                        {/* Main Life Counter */}
                        <div className="flex-1 flex flex-col items-center justify-center py-4">
                            <div className="flex items-center gap-6">
                                <button onClick={() => adjustLife(-1)} className="w-12 h-12 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-full text-white backdrop-blur-sm active:scale-95 transition-all"><span className="text-3xl font-light mb-1">-</span></button>
                                <div className="flex flex-col items-center">
                                    <div className="text-7xl font-black text-white tabular-nums tracking-tighter drop-shadow-2xl">{life}</div>
                                    {(poison > 0) && (
                                        <div className="flex items-center gap-1 text-green-400 font-bold mt-1 bg-black/50 px-2 py-0.5 rounded-full text-xs">
                                            <Icons.Droplet className="w-3 h-3" /> {poison}/10
                                        </div>
                                    )}
                                </div>
                                <button onClick={() => adjustLife(1)} className="w-12 h-12 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-full text-white backdrop-blur-sm active:scale-95 transition-all"><span className="text-3xl font-light mb-1">+</span></button>
                            </div>
                        </div>

                        {/* Footer Actions */}
                        <div className="flex flex-col items-center space-y-3 relative">
                            <div className="flex justify-center gap-3">
                                {[-5, 5].map(amt => (
                                    <button key={amt} onClick={() => adjustLife(amt)} className="px-3 py-1 bg-black/20 hover:bg-black/40 rounded-lg text-white/80 text-xs font-bold backdrop-blur-sm">{amt > 0 ? '+' : ''}{amt}</button>
                                ))}
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {commander?.name && (
                                    <button onClick={() => setShowAssistant(true)} className="flex items-center gap-1 text-xs bg-purple-600/90 hover:bg-purple-500/90 text-white font-bold px-3 py-2 rounded-xl backdrop-blur-md transition-colors shadow-md hover:shadow-lg">
                                        Strategy ✨
                                    </button>
                                )}
                                <button onClick={() => setShowTools(true)} className="flex items-center gap-1 text-xs bg-slate-700/80 hover:bg-slate-600/80 text-white font-bold px-3 py-2 rounded-xl backdrop-blur-md transition-colors shadow-md">
                                    <Icons.Sliders className="w-4 h-4" /> Counters
                                </button>
                            </div>
                        </div>

                         {/* Artist & Copyright Info (Rotates with content) */}
                         {commander?.artist && (
                            <div className="absolute bottom-1 right-2 text-[10px] text-white/40 font-medium pointer-events-none text-right leading-tight">
                                <div>Art by {commander.artist}</div>
                                <div>™ & © Wizards of the Coast</div>
                            </div>
                        )}
                    </div>

                    {/* Modals & Overlays */}
                    {showCmdrSearch && <CommanderSearch onSelect={(c) => { onUpdate(id, { commander: c }); setShowCmdrSearch(false); }} onClose={() => setShowCmdrSearch(false)} />}
                    {commander?.name && showAssistant && <CommanderAssistant commander={commander} onClose={() => setShowAssistant(false)} />}
                    
                    {/* Tools / Counters Overlay */}
                    {showTools && (
                        <div className={`absolute inset-0 bg-slate-900/95 z-20 flex flex-col p-4 transition-transform duration-300 ${rotateClass}`}>
                            <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                                <h3 className="text-white font-bold flex items-center gap-2"><Icons.Sliders className="w-4 h-4 text-purple-400"/> Damage & Counters</h3>
                                <button onClick={() => setShowTools(false)}><Icons.X className="w-5 h-5 text-slate-400 hover:text-white" /></button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto space-y-4">
                                {/* Infect Section */}
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-semibold text-green-400 flex items-center gap-2"><Icons.Droplet className="w-4 h-4"/> Poison (Infect)</span>
                                        <span className="text-xs text-slate-500">Die at 10</span>
                                    </div>
                                    <div className="flex items-center justify-between bg-slate-900 rounded-lg p-2">
                                        <button onClick={() => adjustPoison(-1)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">-</button>
                                        <span className="font-mono text-xl text-white font-bold">{poison || 0}</span>
                                        <button onClick={() => adjustPoison(1)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">+</button>
                                    </div>
                                </div>

                                {/* Commander Damage Section */}
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-semibold text-red-400 flex items-center gap-2"><Icons.Sword className="w-4 h-4"/> Commander Damage</span>
                                        <span className="text-xs text-slate-500">Die at 21</span>
                                    </div>
                                    <div className="space-y-2">
                                        {players.filter(p => p.id !== id).map(opponent => {
                                            const dmg = commanderDamage[opponent.id] || 0;
                                            return (
                                                <div key={opponent.id} className="flex items-center justify-between bg-slate-900 rounded-lg p-2">
                                                    <div className="flex items-center gap-2 overflow-hidden mr-2">
                                                        <div className={`w-2 h-8 rounded-full ${opponent.id === id ? 'bg-purple-500' : 'bg-slate-600'}`}></div>
                                                        <div className="flex flex-col truncate">
                                                            <span className="text-xs font-bold text-white truncate">{opponent.commander?.name || opponent.name}</span>
                                                            <span className="text-[10px] text-slate-500 uppercase">From {opponent.name}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-3 shrink-0">
                                                        <button onClick={() => adjustCmdrDamage(opponent.id, -1)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">-</button>
                                                        <span className={`font-mono text-lg font-bold w-6 text-center ${dmg >= 21 ? 'text-red-500' : 'text-white'}`}>{dmg}</span>
                                                        <button onClick={() => adjustCmdrDamage(opponent.id, 1)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">+</button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {players.length <= 1 && <div className="text-xs text-slate-500 text-center py-2">Add players to track commander damage.</div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. Contact Page
        const ContactPage = () => (
             <div className="h-full flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-500">
                <div className="bg-slate-900/50 backdrop-blur-lg p-8 rounded-2xl border border-slate-700 shadow-2xl max-w-md w-full">
                    <div className="w-16 h-16 bg-purple-600/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Icons.Mail className="w-8 h-8 text-purple-500" />
                    </div>
                    <h1 className="text-3xl font-bold text-white mb-2">Get in Touch</h1>
                    <p className="text-slate-400 mb-8">Have feedback or feature requests? We'd love to hear from you.</p>
                    
                    <a href="mailto:CardboardBonFire@gmail.com" className="block w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-medium py-4 px-6 rounded-xl transition-all hover:border-purple-500 group">
                        <span className="text-xs text-slate-500 uppercase tracking-wider block mb-1 group-hover:text-purple-400">Email Us At</span>
                        <span className="text-lg break-all">CardboardBonFire@gmail.com</span>
                    </a>
                </div>
            </div>
        );

        // 6. Online Room (Updated with Timeout & Stat Recording)
        const OnlineRoom = ({ user, onLeave }) => {
            const [joinedRoom, setJoinedRoom] = useState(null);
            const [error, setError] = useState('');
            const [players, setPlayers] = useState([]);
            const [showCopiedToast, setShowCopiedToast] = useState(false);
            
            // Lobby State
            const [rooms, setRooms] = useState([]);
            const [playerName, setPlayerName] = useState('');
            const [hostName, setHostName] = useState('');
            const [hostPassword, setHostPassword] = useState('');
            const [joinPassword, setJoinPassword] = useState('');
            const [selectedRoomId, setSelectedRoomId] = useState(null);
            
            const TIMEOUT_INACTIVITY = 20 * 60 * 1000; // 20 minutes
            const TIMEOUT_DURATION = 12 * 60 * 60 * 1000; // 12 hours

            const getMillis = (ts) => {
                if (!ts) return Date.now();
                return ts.toMillis ? ts.toMillis() : Date.now();
            };

            // Fetch Rooms for Lobby & Check Query Params
            useEffect(() => {
                if(joinedRoom) return; 
                
                const params = new URLSearchParams(window.location.search);
                const roomParam = params.get('room');
                if (roomParam) {
                    setSelectedRoomId(roomParam);
                }

                const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms');
                const unsub = onSnapshot(roomsRef, (snap) => {
                    const r = [];
                    const now = Date.now();
                    snap.forEach(d => {
                        const data = d.data();
                        const created = getMillis(data.createdAt);
                        const lastActive = getMillis(data.lastActivity);
                        
                        // Filter out timed out rooms from lobby view
                        if (now - lastActive < TIMEOUT_INACTIVITY && now - created < TIMEOUT_DURATION) {
                            r.push({id: d.id, ...data});
                        }
                    });
                    setRooms(r);
                });
                return () => unsub();
            }, [joinedRoom]);

            const createRoom = async () => {
                if (!hostName || !playerName) {
                    setError("Room Name and Player Name are required.");
                    return;
                }
                if (!user) {
                    setError("Authenticating... Please wait.");
                    return;
                }
                try {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', hostName);
                    const playerData = { 
                        id: user.uid, 
                        name: playerName, 
                        life: 40, 
                        commander: null, 
                        isDead: false, 
                        poison: 0,
                        commanderDamage: {},
                        lastActive: Date.now() 
                    };
                    
                    await setDoc(roomRef, { 
                        name: hostName, 
                        password: hostPassword, 
                        createdAt: serverTimestamp(),
                        lastActivity: serverTimestamp(),
                        players: [playerData], 
                        log: [] 
                    });
                    
                    // Count host's commander if they somehow start with one (unlikely but safe)
                    if (playerData.commander && hostName !== "Test") {
                        updateCommanderStat(playerData.commander);
                    }

                    setJoinedRoom(hostName);
                } catch (err) { setError(err.message); }
            };

            const joinRoom = async () => {
                if (!selectedRoomId && !hostName) {
                    setError("Select a room or enter a name.");
                    return;
                }
                const rName = selectedRoomId || hostName;
                
                if (!playerName) {
                    setError("Enter your Display Name.");
                    return;
                }

                const roomData = rooms.find(r => r.id === rName);
                if (roomData && roomData.password && roomData.password !== joinPassword) {
                    setError("Incorrect Password");
                    return;
                }

                setJoinedRoom(rName);
            };

            const copyRoomLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${encodeURIComponent(joinedRoom)}`;
                const el = document.createElement('textarea');
                el.value = url;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                
                setShowCopiedToast(true);
                setTimeout(() => setShowCopiedToast(false), 2000);
            };

            // In-Game Logic
            useEffect(() => {
                if (!joinedRoom || !user) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);
                const unsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Check Timeouts inside room
                        const now = Date.now();
                        const created = getMillis(data.createdAt);
                        const lastActive = getMillis(data.lastActivity);

                        if (now - lastActive > TIMEOUT_INACTIVITY) {
                            setJoinedRoom(null);
                            setError("Room closed due to inactivity (20m).");
                            return;
                        }
                        if (now - created > TIMEOUT_DURATION) {
                            setJoinedRoom(null);
                            setError("Room closed (12h limit reached).");
                            return;
                        }

                        let currentPlayers = data.players || [];
                        const amIIn = currentPlayers.find(p => p.id === user.uid);
                        
                        if (!amIIn) {
                            if (data.password && data.password !== joinPassword && !selectedRoomId) {
                                setError("Room is locked.");
                                setJoinedRoom(null);
                                return;
                            }

                            const newPlayer = { 
                                id: user.uid, 
                                name: playerName || `Player ${currentPlayers.length + 1}`, 
                                life: 40, 
                                commander: null, 
                                isDead: false,
                                poison: 0,
                                commanderDamage: {}
                            };
                            updateDoc(roomRef, { 
                                players: [...currentPlayers, newPlayer],
                                lastActivity: serverTimestamp()
                            });
                        } else {
                            setPlayers(currentPlayers);
                        }
                    } else {
                        setError('Room does not exist!');
                        setJoinedRoom(null);
                    }
                }, (err) => setError(err.message));
                return () => unsubscribe();
            }, [joinedRoom, user]);

            const updateSelf = async (updates) => {
                if (!joinedRoom) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);
                const newPlayers = players.map(p => p.id === user.uid ? { ...p, ...updates } : p);
                await updateDoc(roomRef, { 
                    players: newPlayers,
                    lastActivity: serverTimestamp() // Update activity on any change
                });

                // Record stat if commander changed and room is not Test
                if (updates.commander && joinedRoom !== "Test") {
                    updateCommanderStat(updates.commander);
                }
            };

            // Game View
            if (joinedRoom) {
                return (
                    <div className="h-full flex flex-col relative">
                        {/* Copied Toast */}
                        {showCopiedToast && (
                            <div className="absolute top-16 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-full shadow-lg z-50 animate-bounce">
                                Link Copied!
                            </div>
                        )}

                        <div className="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <Icons.Wifi className="text-green-500 w-4 h-4 animate-pulse" />
                                    <span className="text-white font-bold">{joinedRoom}</span>
                                    <span className="text-slate-500 text-sm">({players.length})</span>
                                </div>
                                <button 
                                    onClick={copyRoomLink} 
                                    className="flex items-center gap-1 text-xs bg-purple-600/20 text-purple-400 hover:bg-purple-600 hover:text-white px-3 py-1.5 rounded-full transition-colors font-medium border border-purple-500/50"
                                >
                                    <Icons.Share className="w-3 h-3" /> Share Room
                                </button>
                            </div>
                            <button onClick={() => { setJoinedRoom(null); onLeave(); }} className="text-red-400 hover:text-red-300 text-sm font-medium">Leave Room</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-fr h-full min-h-[500px]">
                                {players.map(p => (
                                    <PlayerCard 
                                        key={p.id} 
                                        {...p} 
                                        players={players} 
                                        isLocal={false}
                                        color={p.id === user.uid ? 'bg-slate-800 ring-2 ring-purple-500' : 'bg-slate-800'} 
                                        onUpdate={(id, updates) => { if (id === user.uid) updateSelf(updates); }} 
                                        onDead={(id) => { if (id === user.uid) updateSelf({ isDead: true }); }} 
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // Lobby View
            return (
                <div className="h-full flex flex-col p-4 md:p-8 overflow-y-auto">
                    <div className="max-w-4xl mx-auto w-full space-y-8">
                        
                        {/* Header & Player Name */}
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-slate-900 p-6 rounded-2xl border border-slate-700">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-purple-600/20 rounded-xl">
                                    <Icons.Users className="w-8 h-8 text-purple-500" />
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-white">Multiplayer Lobby</h2>
                                    <p className="text-slate-400 text-sm">Join a game or host your own.</p>
                                </div>
                            </div>
                            <div className="w-full md:w-auto">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Your Display Name</label>
                                <input 
                                    type="text" 
                                    placeholder="Enter Your Name..." 
                                    className="w-full md:w-64 bg-slate-800 border border-slate-600 text-white p-3 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none font-bold"
                                    value={playerName}
                                    onChange={(e) => setPlayerName(e.target.value)}
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            
                            {/* Left: Active Rooms List */}
                            <div className="space-y-4">
                                <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                    <Icons.Wifi className="w-5 h-5 text-green-500" /> Active Rooms
                                </h3>
                                <div className="bg-slate-900 rounded-2xl border border-slate-700 overflow-hidden min-h-[300px] flex flex-col">
                                    {rooms.length === 0 ? (
                                        <div className="flex-1 flex flex-col items-center justify-center text-slate-500 p-8">
                                            <p>No active rooms found.</p>
                                            <p className="text-sm">Be the first to host one!</p>
                                        </div>
                                    ) : (
                                        <div className="divide-y divide-slate-800">
                                            {rooms.map(room => (
                                                <div 
                                                    key={room.id}
                                                    onClick={() => {
                                                        setSelectedRoomId(room.id);
                                                        setHostName(''); // Clear manual entry
                                                    }}
                                                    className={`p-4 flex items-center justify-between cursor-pointer transition-colors ${selectedRoomId === room.id ? 'bg-purple-900/20 border-l-4 border-purple-500' : 'hover:bg-slate-800 border-l-4 border-transparent'}`}
                                                >
                                                    <div>
                                                        <div className="font-bold text-white">{room.name}</div>
                                                        <div className="text-xs text-slate-500">{(room.players || []).length} Players</div>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        {room.password && <Icons.Lock className="w-4 h-4 text-orange-400" />}
                                                        {!room.password && <Icons.Unlock className="w-4 h-4 text-green-400/50" />}
                                                        <Icons.User className="w-5 h-5 text-slate-600" />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Right: Actions */}
                            <div className="space-y-6">
                                {/* Join Selected Panel */}
                                {selectedRoomId && (
                                    <div className="bg-slate-800 p-6 rounded-2xl border border-purple-500/50 shadow-lg animate-in fade-in slide-in-from-right-4">
                                        <h3 className="text-lg font-bold text-white mb-4">Join "{selectedRoomId}"</h3>
                                        <div className="space-y-4">
                                            {rooms.find(r => r.id === selectedRoomId)?.password && (
                                                <div>
                                                    <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Room Password</label>
                                                    <input 
                                                        type="password" 
                                                        placeholder="Required" 
                                                        className="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg outline-none focus:border-purple-500"
                                                        value={joinPassword}
                                                        onChange={(e) => setJoinPassword(e.target.value)}
                                                    />
                                                </div>
                                            )}
                                            <button 
                                                onClick={joinRoom}
                                                disabled={!user || !playerName}
                                                className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                Join Game
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Host New Panel */}
                                <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700">
                                    <h3 className="text-lg font-bold text-white mb-4">Host New Room</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Room Name</label>
                                            <input 
                                                type="text" 
                                                placeholder="e.g. Friday Night Magic" 
                                                className="w-full bg-slate-800 border border-slate-600 text-white p-3 rounded-lg outline-none focus:border-purple-500"
                                                value={hostName}
                                                onChange={(e) => {
                                                    setHostName(e.target.value);
                                                    setSelectedRoomId(null);
                                                }}
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Password (Optional)</label>
                                            <input 
                                                type="text" 
                                                placeholder="Leave empty for open room" 
                                                className="w-full bg-slate-800 border border-slate-600 text-white p-3 rounded-lg outline-none focus:border-purple-500"
                                                value={hostPassword}
                                                onChange={(e) => setHostPassword(e.target.value)}
                                            />
                                        </div>
                                        <button 
                                            onClick={createRoom}
                                            disabled={!user || !hostName || !playerName}
                                            className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Create & Host
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                        
                        {error && <div className="p-4 bg-red-900/50 border border-red-500 text-red-200 rounded-xl text-center font-bold animate-pulse">{error}</div>}
                    </div>
                </div>
            );
        };

        // 7. Changelog
        const Changelog = () => (
            <div className="p-8 max-w-3xl mx-auto text-slate-300 space-y-8 h-full overflow-y-auto">
                <h1 className="text-3xl font-bold text-white mb-8">Patch Notes</h1>
                <div className="relative pl-8 border-l-2 border-slate-700">
                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-purple-500 ring-4 ring-slate-900" />
                    <div className="mb-1 text-purple-400 font-mono text-sm">v2.7.0 - Persistent Data</div>
                    <h3 className="text-xl font-bold text-white mb-2">Historical Statistics</h3>
                    <ul className="list-disc pl-4 space-y-2 text-slate-400">
                        <li><strong className="text-slate-200">Permanent Tracking:</strong> Commander stats are now saved permanently. When a room times out, the usage data is preserved.</li>
                        <li><strong className="text-slate-200">Historical Leaderboard:</strong> The Stats page now shows the most popular commanders of all time, rather than just currently active ones.</li>
                    </ul>
                </div>
                {/* ... existing changelogs ... */}
            </div>
        );

        // --- Main App ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('local');
            const [localPlayers, setLocalPlayers] = useState([
                { id: 1, name: 'P1', life: 40, commander: null, color: 'bg-slate-800', poison: 0, commanderDamage: {} },
                { id: 2, name: 'P2', life: 40, commander: null, color: 'bg-slate-800', poison: 0, commanderDamage: {} },
                { id: 3, name: 'P3', life: 40, commander: null, color: 'bg-slate-800', poison: 0, commanderDamage: {} },
                { id: 4, name: 'P4', life: 40, commander: null, color: 'bg-slate-800', poison: 0, commanderDamage: {} }
            ]);
            const [isMenuOpen, setIsMenuOpen] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            const resetLocalGame = () => {
                setLocalPlayers(localPlayers.map(p => ({ ...p, life: 40, commander: null, isDead: false, poison: 0, commanderDamage: {} })));
            };

            const updateLocalPlayer = (id, updates) => {
                setLocalPlayers(prev => prev.map(p => p.id === id ? { ...p, ...updates } : p));
            };

            const NavItem = ({ id, label, icon: Icon }) => (
                <button onClick={() => { setView(id); setIsMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === id ? 'bg-purple-600 text-white font-bold' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                    <Icon className="w-5 h-5" />
                    {label}
                </button>
            );

            return (
                <div className="bg-slate-950 min-h-screen text-slate-200 font-sans selection:bg-purple-500/30 overflow-hidden flex flex-col">
                    <div className="md:hidden bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center z-20">
                        <div className="flex items-center gap-2 text-white font-bold text-lg">
                            <Icons.Shield className="text-purple-500 fill-current w-6 h-6" />
                            <span>Companion</span>
                        </div>
                        <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="p-2 text-white">
                            {isMenuOpen ? <Icons.X className="w-6 h-6"/> : <Icons.Menu className="w-6 h-6"/>}
                        </button>
                    </div>

                    <div className="flex flex-1 overflow-hidden relative">
                        <div className={`fixed md:relative inset-y-0 left-0 w-64 bg-slate-900 border-r border-slate-800 transform transition-transform duration-300 z-30 flex flex-col ${isMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                            <div className="p-6 border-b border-slate-800 hidden md:flex items-center gap-3">
                                <div className="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/20">
                                    <Icons.Shield className="text-white w-6 h-6" />
                                </div>
                                <div>
                                    <h1 className="font-bold text-white text-lg leading-tight">Commander</h1>
                                    <div className="text-xs text-purple-400 font-medium">Companion App</div>
                                </div>
                            </div>

                            <div className="p-4 space-y-2 flex-1">
                                <div className="text-xs font-bold text-slate-500 uppercase tracking-wider px-4 mb-2 mt-4">Game Modes</div>
                                <NavItem id="local" label="Local Game" icon={Icons.Users} />
                                <NavItem id="online" label="Online Room" icon={Icons.Wifi} />
                                <div className="text-xs font-bold text-slate-500 uppercase tracking-wider px-4 mb-2 mt-6">Data & Info</div>
                                <NavItem id="stats" label="Global Stats" icon={Icons.BarChart2} />
                                <NavItem id="contact" label="Contact" icon={Icons.Mail} />
                                <NavItem id="changes" label="Changelog" icon={Icons.FileText} />
                            </div>

                            <div className="p-4 border-t border-slate-800">
                                {view === 'local' && (
                                    <button onClick={resetLocalGame} className="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-red-900/30 text-slate-300 hover:text-red-400 p-3 rounded-lg transition-colors border border-slate-700 hover:border-red-800">
                                        <Icons.RotateCcw className="w-4 h-4" />
                                        <span>Reset Game</span>
                                    </button>
                                )}
                                <div className="mt-4 text-center text-xs text-slate-600">
                                    {user ? `ID: ${user.uid.slice(0, 6)}...` : 'Connecting...'}
                                </div>
                            </div>
                        </div>

                        {isMenuOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" onClick={() => setIsMenuOpen(false)} />}

                        <main className="flex-1 relative overflow-hidden bg-slate-950">
                            {view === 'local' && (
                                <div className="h-full grid grid-cols-1 sm:grid-cols-2 gap-1 p-1 md:p-4">
                                    {localPlayers.map(p => (
                                        <PlayerCard 
                                            key={p.id} 
                                            {...p} 
                                            isLocal={true}
                                            players={localPlayers}
                                            onUpdate={updateLocalPlayer} 
                                            onDead={(id) => updateLocalPlayer(id, { isDead: true })} 
                                        />
                                    ))}
                                </div>
                            )}
                            {view === 'online' && <OnlineRoom user={user} onLeave={() => setView('local')} />}
                            {view === 'stats' && <StatsPage user={user} />}
                            {view === 'contact' && <ContactPage />}
                            {view === 'changes' && <Changelog />}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
