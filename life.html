<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Life Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        #app-container {
            width: 100%;
            max-width: 450px;
            background-color: white;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 12px;
        }
        
        /* --- Room List Styles --- */
        #room-list-container {
            margin-top: 20px;
            border-top: 2px solid #f0f0f0;
            padding-top: 15px;
        }
        .room-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .room-info {
            display: flex;
            flex-direction: column;
        }
        .room-id {
            font-weight: bold;
            font-size: 1.1em;
        }
        .room-meta {
            font-size: 0.8em;
            color: #666;
        }
        
        /* --- Game View Styles --- */
        .player-counter {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .life-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .life-display {
            text-align: center;
        }
        .life-total {
            font-size: 2.5em;
            font-weight: 800;
            color: #2c3e50;
            display: block;
            line-height: 1;
        }
        .player-name {
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #7f8c8d;
        }
        
        /* Controls */
        .control-group {
            display: flex;
            gap: 5px;
        }
        button {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active {
            transform: scale(0.96);
        }
        .btn-life {
            padding: 8px 12px;
            font-size: 1em;
            background-color: #3498db;
            color: white;
        }
        .btn-damage {
            padding: 4px 8px;
            font-size: 0.9em;
            background-color: #e74c3c;
            color: white;
        }
        .btn-primary {
            width: 100%;
            padding: 12px;
            background-color: #2ecc71;
            color: white;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .btn-danger {
            width: 100%;
            padding: 12px;
            background-color: #e74c3c;
            color: white;
            margin-top: 5px;
        }
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
            padding: 8px;
            margin-left: 5px;
        }

        /* Damage Section */
        .damage-section {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .damage-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .damage-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        #status-message {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body>

    <div id="app-container">
        </div>

    <p id="status-message">Initializing...</p>

    <script type="module">
        // ----------------------------------------------------------------------
        // 1. CONFIGURATION
        // ----------------------------------------------------------------------
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E", 
            authDomain: "mtg-life-tool.firebaseapp.com",
            projectId: "mtg-life-tool", 
            storageBucket: "mtg-life-tool.appspot.com",
            messagingSenderId: "36730058988",
            appId: "1:36730058988:web:757e2d9620593b4f65022a"
        };
        
        // ----------------------------------------------------------------------
        // 2. IMPORTS
        // ----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, collection, getDocs, query, limit, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----------------------------------------------------------------------
        // 3. GLOBALS
        // ----------------------------------------------------------------------
        const app = initializeApp(USER_FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let roomId = null;
        let unsubscribe = null;
        const ROOM_COLLECTION = "mtg_rooms";
        const TIMEOUT_MINUTES = 25; 

        // ----------------------------------------------------------------------
        // 4. HELPERS
        // ----------------------------------------------------------------------
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
        }

        async function checkAndDeleteIfExpired(id, roomData) {
            const lastActive = roomData.lastActive?.toDate();
            if (lastActive) {
                const elapsed = (new Date() - lastActive) / (1000 * 60);
                if (elapsed > TIMEOUT_MINUTES) {
                    console.log(`Deleting expired room: ${id}`);
                    try { await deleteDoc(doc(db, ROOM_COLLECTION, id)); } catch(e){}
                    return true;
                }
            }
            return false;
        }

        // ----------------------------------------------------------------------
        // 5. GAME LOGIC & RENDERING
        // ----------------------------------------------------------------------

        function renderRoomView(roomData) {
            const appContainer = document.getElementById("app-container");
            const statusMessage = document.getElementById("status-message");

            statusMessage.innerHTML = `Connected as: <strong>${userId.substring(0,6)}</strong>`;
            
            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0;">Room: ${roomId}</h2>
                    <button id="refresh-btn" class="btn-secondary">â†»</button>
                </div>
            `;
            
            const playerIds = Object.keys(roomData.players);

            // Sort players: Put current user first, then others
            playerIds.sort((a, b) => (a === userId ? -1 : b === userId ? 1 : 0));

            playerIds.forEach(playerId => {
                const player = roomData.players[playerId];
                const isMe = playerId === userId;
                
                // LIFE SECTION
                let lifeControls = '';
                if (isMe) {
                    lifeControls = `
                        <div class="control-group">
                            <button class="btn-life" data-pid="${playerId}" data-type="life" data-val="-1">-1</button>
                            <button class="btn-life" data-pid="${playerId}" data-type="life" data-val="-5">-5</button>
                            <button class="btn-life" data-pid="${playerId}" data-type="life" data-val="+1">+1</button>
                            <button class="btn-life" data-pid="${playerId}" data-type="life" data-val="+5">+5</button>
                        </div>
                    `;
                }

                // DAMAGE SECTION
                let damageRows = '';
                const opponents = playerIds.filter(id => id !== playerId);
                
                if (opponents.length > 0) {
                    damageRows = `<div class="damage-section"><h4 style="margin:0 0 10px 0; font-size:0.9em; color:#555;">Commander Damage Taken</h4>`;
                    opponents.forEach(oppId => {
                        const dmg = player.commanderDamage?.[oppId] || 0;
                        let dmgControls = '';
                        
                        // Only show controls if I am the player taking damage
                        if (isMe) {
                            dmgControls = `
                                <div class="control-group">
                                    <button class="btn-damage" data-pid="${playerId}" data-opp="${oppId}" data-type="cmd" data-val="-1">-</button>
                                    <button class="btn-damage" data-pid="${playerId}" data-opp="${oppId}" data-type="cmd" data-val="+1">+</button>
                                </div>
                            `;
                        }
                        
                        damageRows += `
                            <div class="damage-row">
                                <span style="font-size:0.9em;">vs ${oppId.substring(0,4)}...</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <strong style="color:${dmg >= 21 ? 'red' : 'black'}">${dmg}</strong>
                                    ${dmgControls}
                                </div>
                            </div>
                        `;
                    });
                    damageRows += `</div>`;
                }

                html += `
                    <div class="player-counter" style="${isMe ? 'border: 2px solid #3498db;' : ''}">
                        <div class="life-section">
                            <div class="life-display">
                                <span class="player-name">${isMe ? 'YOU' : 'OPPONENT'} (${playerId.substring(0,4)})</span>
                                <span class="life-total">${player.life}</span>
                            </div>
                            ${lifeControls}
                        </div>
                        ${damageRows}
                    </div>
                `;
            });

            html += `<button id="leave-room-btn" class="btn-danger">Leave Room</button>`;
            appContainer.innerHTML = html;
            
            // --- FIX: ATTACH LISTENERS AFTER HTML IS INJECTED ---
            
            // Life Buttons
            document.querySelectorAll('.btn-life').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const delta = parseInt(e.target.dataset.val);
                    updateLife(delta);
                });
            });

            // Commander Damage Buttons
            document.querySelectorAll('.btn-damage').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const oppId = e.target.dataset.opp;
                    const delta = parseInt(e.target.dataset.val);
                    updateCmdDamage(oppId, delta);
                });
            });

            document.getElementById('leave-room-btn').addEventListener('click', () => {
                if(unsubscribe) unsubscribe();
                roomId = null;
                renderSetupView();
            });
            
            document.getElementById('refresh-btn').addEventListener('click', () => {
                // Manual refresh in case of desync
                if(roomId) listenToRoom(roomId);
            });
        }

        // --- DATA UPDATES ---

        async function updateLife(delta) {
            if (!roomId || !userId) return;
            const ref = doc(db, ROOM_COLLECTION, roomId);
            try {
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data();
                    const cur = data.players[userId]?.life ?? 40;
                    
                    await setDoc(ref, {
                        players: { [userId]: { life: cur + delta } },
                        lastActive: serverTimestamp()
                    }, { merge: true });
                }
            } catch(e) { console.error(e); }
        }

        async function updateCmdDamage(oppId, delta) {
            if (!roomId || !userId) return;
            const ref = doc(db, ROOM_COLLECTION, roomId);
            try {
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data();
                    const cur = data.players[userId]?.commanderDamage?.[oppId] ?? 0;
                    const newVal = Math.max(0, cur + delta);

                    // Firestore dot notation for nested map update
                    const fieldPath = `players.${userId}.commanderDamage.${oppId}`;
                    
                    await setDoc(ref, {
                        [fieldPath]: newVal, // Using computed property name
                        lastActive: serverTimestamp()
                    }, { merge: true });
                }
            } catch(e) { console.error(e); }
        }

        // --- SETUP & LIST VIEWS ---

        async function renderSetupView() {
            const appContainer = document.getElementById("app-container");
            const statusMessage = document.getElementById("status-message");
            roomId = null;

            statusMessage.textContent = "Browse rooms or create a new one.";

            // 1. Fetch Rooms (FIXED: Simplified logic to ensure list renders)
            let listHtml = '<p>Loading active rooms...</p>';
            appContainer.innerHTML = `
                <h2>MTG Lobby</h2>
                <div style="margin-bottom:20px;">
                    <input type="text" id="search-input" placeholder="Enter Room ID to Create/Search">
                    <button id="search-btn" class="btn-primary">Find or Create Room</button>
                </div>
                <h3>Active Rooms</h3>
                <div id="room-list-container">${listHtml}</div>
            `;

            try {
                const q = query(collection(db, ROOM_COLLECTION), limit(15));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    listHtml = '<p>No active rooms. Create one above!</p>';
                } else {
                    listHtml = '';
                    snap.forEach(docSnap => {
                        const rData = docSnap.data();
                        const rId = docSnap.id;
                        const pCount = Object.keys(rData.players || {}).length;
                        
                        // We do NOT delete here to prevent blocking the UI.
                        // We just list them. Deletion happens on join attempt.
                        
                        listHtml += `
                            <div class="room-item">
                                <div class="room-info">
                                    <span class="room-id">${rId}</span>
                                    <span class="room-meta">${pCount} Player(s)</span>
                                </div>
                                <button class="join-btn btn-secondary" data-rid="${rId}">Join</button>
                            </div>
                        `;
                    });
                }
            } catch (e) {
                console.error("List error:", e);
                listHtml = `<p style="color:red">Error loading rooms. Permissions might be initializing...</p>`;
            }

            // Update just the container part
            const listContainer = document.getElementById("room-list-container");
            if(listContainer) listContainer.innerHTML = listHtml;

            // --- ATTACH LISTENERS ---
            
            // List Join Buttons
            if(listContainer) {
                listContainer.querySelectorAll('.join-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const rid = e.target.dataset.rid;
                        promptPassword(rid, 'join');
                    });
                });
            }

            // Search/Create Button
            const searchBtn = document.getElementById("search-btn");
            if(searchBtn) {
                searchBtn.addEventListener('click', async () => {
                    const val = document.getElementById("search-input").value.trim().toLowerCase();
                    if(!val) return;
                    
                    const ref = doc(db, ROOM_COLLECTION, val);
                    const snap = await getDoc(ref);
                    
                    if(snap.exists()) {
                        promptPassword(val, 'join');
                    } else {
                        promptPassword(val, 'create');
                    }
                });
            }
        }

        function promptPassword(rid, mode) {
            const appContainer = document.getElementById("app-container");
            const title = mode === 'join' ? `Join ${rid}` : `Create ${rid}`;
            const btnText = mode === 'join' ? "Enter Game" : "Create Room";
            
            appContainer.innerHTML = `
                <h2>${title}</h2>
                <p>${mode === 'create' ? 'Set a password for this room:' : 'Enter room password:'}</p>
                <input type="password" id="pwd-input" placeholder="Password">
                <button id="action-btn" class="btn-primary">${btnText}</button>
                <button id="cancel-btn" class="btn-danger">Cancel</button>
                <p id="err-msg" style="color:red"></p>
            `;
            
            document.getElementById("cancel-btn").onclick = renderSetupView;
            
            document.getElementById("action-btn").onclick = async () => {
                const pwd = document.getElementById("pwd-input").value;
                if(!pwd) return;
                
                if (mode === 'join') {
                    // Check logic
                    const ref = doc(db, ROOM_COLLECTION, rid);
                    const snap = await getDoc(ref);
                    if(snap.exists()) {
                        const data = snap.data();
                        
                        // Check expiry BEFORE joining
                        if(await checkAndDeleteIfExpired(rid, data)) {
                            document.getElementById("err-msg").textContent = "Room expired and was deleted.";
                            setTimeout(renderSetupView, 2000);
                            return;
                        }

                        if(data.passwordHash === hashPassword(pwd)) {
                            listenToRoom(rid);
                        } else {
                            document.getElementById("err-msg").textContent = "Wrong password.";
                        }
                    } else {
                        document.getElementById("err-msg").textContent = "Room no longer exists.";
                    }
                } else {
                    // Create logic
                    if(pwd.length < 3) {
                        document.getElementById("err-msg").textContent = "Password too short.";
                        return;
                    }
                    createRoom(rid, pwd);
                }
            };
        }

        async function createRoom(rid, pwd) {
            if(!userId) return;
            const ref = doc(db, ROOM_COLLECTION, rid);
            try {
                await setDoc(ref, {
                    ownerId: userId,
                    passwordHash: hashPassword(pwd),
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                    players: {
                        [userId]: { life: 40, commanderDamage: {} }
                    }
                });
                listenToRoom(rid);
            } catch(e) {
                console.error(e);
            }
        }

        function listenToRoom(rid) {
            if(unsubscribe) unsubscribe();
            const ref = doc(db, ROOM_COLLECTION, rid);
            
            unsubscribe = onSnapshot(ref, (snap) => {
                if(snap.exists()) {
                    roomId = rid;
                    const data = snap.data();
                    
                    // If I am not in the player list, add myself
                    if(!data.players[userId]) {
                        // Auto-join
                        setDoc(ref, {
                            players: { [userId]: { life: 40, commanderDamage: {} } },
                            lastActive: serverTimestamp()
                        }, { merge: true });
                    }
                    
                    renderRoomView(data);
                } else {
                    renderSetupView();
                }
            });
        }

        // ----------------------------------------------------------------------
        // 6. INIT
        // ----------------------------------------------------------------------
        onAuthStateChanged(auth, user => {
            if(user) {
                userId = user.uid;
                renderSetupView();
            } else {
                signInAnonymously(auth).catch(e => {
                    document.getElementById("status-message").textContent = "Auth Error: " + e.message;
                });
            }
        });

    </script>
</body>
</html>
