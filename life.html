<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Life Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f4f4;
        }
        #app-container {
            width: 100%;
            max-width: 400px;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        /* Room List Styling */
        #room-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .room-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .room-item:last-child {
            border-bottom: none;
        }
        .room-item:hover {
            background-color: #e9e9e9;
        }
        .room-item button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        /* General Input/Button Styling */
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        #cancel-btn {
            background-color: #f44336;
        }
        .life-control button {
            width: auto;
            padding: 5px 10px;
            font-size: 1.2em;
            margin: 0 2px;
        }
        .life-total {
            font-size: 2em;
            font-weight: bold;
        }
        #status-message {
            color: #333;
            margin-top: 10px;
            text-align: center;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body>

    <div id="app-container">
        </div>

    <p id="status-message">Initializing...</p>

    <script type="module">
        // ----------------------------------------------------------------------
        // üîë 1. CONFIGURATION (REPLACE WITH YOUR ACTUAL FIREBASE VALUES)
        // ----------------------------------------------------------------------
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E", 
            authDomain: "mtg-life-tool.firebaseapp.com",
            projectId: "mtg-life-tool", 
            storageBucket: "mtg-life-tool.appspot.com",
            messagingSenderId: "36730058988",
            appId: "1:36730058988:web:757e2d9620593b4f65022a",
            measurementId: "G-GGL1Q6R00X"
        };
        
        // ----------------------------------------------------------------------
        // üìö 2. IMPORTS
        // ----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot, 
            serverTimestamp,
            collection,
            getDocs,
            query,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----------------------------------------------------------------------
        // ‚öôÔ∏è 3. GLOBALS
        // ----------------------------------------------------------------------
        const app = initializeApp(USER_FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let roomId = null;
        let unsubscribe = null;
        const ROOM_COLLECTION = "mtg_rooms";

        // ----------------------------------------------------------------------
        // üîí 4. PASSWORD HASHING FUNCTION
        // ----------------------------------------------------------------------

        /** Calculates a simple SHA256 hash of the password (for front-end validation only). */
        function hashPassword(password) {
            // CryptoJS is available globally because it was included in a script tag
            return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
        }

        // ----------------------------------------------------------------------
        // üß© 5. CORE FUNCTIONS (Modified)
        // ----------------------------------------------------------------------

        function getStartingLife() {
            return 40; 
        }

        function renderRoomView(roomData) {
            const appContainer = document.getElementById("app-container");
            const statusMessage = document.getElementById("status-message");

            if (!roomData || !roomData.players) {
                appContainer.innerHTML = '<h2>Room Data Error</h2><p>Could not load player data.</p>';
                return;
            }

            statusMessage.innerHTML = `Room ID: <strong>${roomId}</strong> | ${roomData.ownerId === userId ? 'You are the Owner' : 'Connected'}`;
            
            let html = `<h2>Current Game State</h2>`;

            Object.keys(roomData.players).forEach(playerId => {
                const player = roomData.players[playerId];
                const isCurrentPlayer = playerId === userId;
                
                html += `
                    <div class="player-counter" id="player-${playerId}">
                        <div>
                            <p><strong>${isCurrentPlayer ? 'You' : `Player (${playerId.substring(0, 4)}...)`}</strong></p>
                            <p>Life: <span class="life-total">${player.life}</span></p>
                        </div>
                        ${isCurrentPlayer ? `
                            <div class="life-control">
                                <button data-player-id="${playerId}" data-delta="-5">-5</button>
                                <button data-player-id="${playerId}" data-delta="-1">-1</button>
                                <button data-player-id="${playerId}" data-delta="+1">+1</button>
                                <button data-player-id="${playerId}" data-delta="+5">+5</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            // Add button to return to setup (e.g., to join another room)
            html += `<button id="leave-room-btn" style="background-color: #6c757d;">Leave Room</button>`;

            appContainer.innerHTML = html;
            
            if (document.querySelector('.life-control')) {
                document.querySelectorAll('.life-control button').forEach(button => {
                    button.addEventListener('click', handleLifeChange);
                });
            }

            document.getElementById('leave-room-btn').addEventListener('click', () => {
                if (unsubscribe) unsubscribe();
                roomId = null;
                renderSetupView();
            });
        }

        function handleLifeChange(e) {
            const delta = parseInt(e.target.dataset.delta, 10);
            updateLife(delta);
        }
        
        async function updateLife(delta) {
            if (!roomId || !userId) {
                console.error("Room or User ID is missing.");
                return;
            }

            const roomRef = doc(db, ROOM_COLLECTION, roomId);

            try {
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.exists()) {
                    const roomData = roomSnap.data();
                    const currentLife = roomData.players[userId]?.life ?? getStartingLife(); 
                    const newLife = currentLife + delta;
                    
                    const updatePayload = {};
                    updatePayload[`players.${userId}.life`] = newLife;
                    updatePayload.lastUpdated = serverTimestamp();

                    await setDoc(roomRef, updatePayload, { merge: true });
                }
            } catch (error) {
                console.error("Error updating life:", error);
            }
        }
        
        // NEW VIEW: Prompts user for password to join selected room
        function promptForPassword(id) {
            const appContainer = document.getElementById("app-container");
            document.getElementById("status-message").innerHTML = `Enter password for <strong>${id}</strong>.`;
            
            appContainer.innerHTML = `
                <h2>Join Room: ${id}</h2>
                <input type="password" id="room-password" placeholder="Enter Room Password">
                <button id="submit-password-btn">Join Game</button>
                <button id="cancel-btn">Cancel</button>
                <p id="password-error" style="color: red;"></p>
            `;

            document.getElementById('submit-password-btn').addEventListener('click', async () => {
                const password = document.getElementById('room-password').value;
                if (!password) return;

                const roomRef = doc(db, ROOM_COLLECTION, id);
                const roomSnap = await getDoc(roomRef);

                if (roomSnap.exists()) {
                    const roomData = roomSnap.data();
                    // üîí Check password hash
                    if (roomData.passwordHash === hashPassword(password)) {
                        // Password correct! Start listening and join.
                        listenToRoom(id); 
                    } else {
                        document.getElementById('password-error').textContent = "Incorrect password.";
                    }
                } else {
                    document.getElementById('password-error').textContent = "Room not found.";
                }
            });

            document.getElementById('cancel-btn').addEventListener('click', () => {
                renderSetupView();
            });
        }

        // MODIFIED: When creating, now prompts for password
        function promptToCreateRoom(id) {
            const appContainer = document.getElementById("app-container");
            document.getElementById("status-message").innerHTML = `Room <strong>${id}</strong> not found. Set up a new one.`;

            appContainer.innerHTML = `
                <h2>Create Room: ${id}</h2>
                <input type="password" id="new-room-password" placeholder="Set Room Password">
                <button id="create-new-room-btn">Create Room ${id}</button>
                <button id="cancel-btn">Cancel</button>
            `;

            document.getElementById('create-new-room-btn').addEventListener('click', async () => {
                const password = document.getElementById('new-room-password').value;
                if (password.length >= 4) {
                    await createNewRoom(id, password); 
                } else {
                    document.getElementById("status-message").innerHTML = "Password must be at least 4 characters.";
                }
            });
            
            document.getElementById('cancel-btn').addEventListener('click', () => {
                renderSetupView();
            });
        }

        // MODIFIED: Now requires user to enter password *before* listenToRoom is called
        function listenToRoom(id) {
            if (unsubscribe) {
                unsubscribe();
            }

            const roomRef = doc(db, ROOM_COLLECTION, id);
            
            unsubscribe = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const roomData = docSnap.data();
                    
                    if (roomData.players && roomData.players[userId]) {
                        roomId = id;
                        renderRoomView(roomData);
                    } else {
                        // Room exists, but user isn't in it. Add them automatically.
                        roomId = id;
                        joinRoom(id); 
                    }
                } else {
                    // This should only happen if a room is deleted while listening
                    if (unsubscribe) unsubscribe();
                    roomId = null; 
                    renderSetupView();
                }
            }, (error) => {
                console.error("Firestore listener error:", error);
                document.getElementById("status-message").innerHTML = `Error accessing room: ${error.message}`;
                renderSetupView(); 
            });
        }
        
        async function joinRoom(id) {
            if (!userId) return;
            
            const roomRef = doc(db, ROOM_COLLECTION, id);
            const playerPayload = {
                life: getStartingLife(),
                joinedAt: serverTimestamp()
            };

            const updatePayload = {};
            updatePayload[`players.${userId}`] = playerPayload;

            try {
                await setDoc(roomRef, updatePayload, { merge: true });
            } catch (error) {
                console.error("Error joining room:", error);
                document.getElementById("status-message").innerHTML = "Error joining room. Try again.";
            }
        }
        
        // MODIFIED: Fetches and displays room list, and changes interaction flow
        async function renderSetupView() {
            const appContainer = document.getElementById("app-container");
            roomId = null; 
            document.getElementById("status-message").innerHTML = "Select a room below or search to create a new one.";

            // 1. Fetch available rooms
            const roomsQuery = query(collection(db, ROOM_COLLECTION), limit(20));
            let roomListHtml = '';
            try {
                const querySnapshot = await getDocs(roomsQuery);
                if (querySnapshot.empty) {
                    roomListHtml = '<p>No active rooms found.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const roomData = doc.data();
                        const roomID = doc.id;
                        const playerCount = Object.keys(roomData.players || {}).length;
                        roomListHtml += `
                            <div class="room-item" data-room-id="${roomID}">
                                <span>${roomID} (${playerCount} players)</span>
                                <button data-room-id="${roomID}">Join</button>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error("Error fetching rooms:", error);
                roomListHtml = '<p style="color:red;">Error loading rooms. Try refreshing.</p>';
            }

            appContainer.innerHTML = `
                <h2>MTG Commander Tracker</h2>

                <input type="text" id="room-search" placeholder="Search for or enter new Room ID">
                <button id="search-btn">Search / Create</button>
                
                <h3>Active Rooms</h3>
                <div id="room-list">${roomListHtml}</div>
            `;

            // 2. Add Event Listeners for room list and search
            
            // Listeners for the Join buttons on the list
            document.getElementById('room-list').querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const selectedRoomId = e.target.dataset.roomId;
                    promptForPassword(selectedRoomId);
                });
            });

            // Listener for the main search/create button
            document.getElementById('search-btn').addEventListener('click', async () => {
                const input = document.getElementById('room-search').value.trim().toLowerCase();
                if (!input) {
                    document.getElementById("status-message").innerHTML = "Please enter a Room ID.";
                    return;
                }
                
                // Check if room exists
                const roomRef = doc(db, ROOM_COLLECTION, input);
                const roomSnap = await getDoc(roomRef);

                if (roomSnap.exists()) {
                    // Room exists, go to password prompt
                    promptForPassword(input);
                } else {
                    // Room does not exist, go to create prompt
                    promptToCreateRoom(input);
                }
            });
        }

        // MODIFIED: Now saves a hashed password
        async function createNewRoom(id, password) {
            if (!userId) return;

            const roomRef = doc(db, ROOM_COLLECTION, id);
            
            const initialRoomData = {
                roomId: id,
                ownerId: userId,
                // üîí NEW: Store the hash of the password
                passwordHash: hashPassword(password), 
                createdAt: serverTimestamp(),
                lastUpdated: serverTimestamp(),
                players: {
                    [userId]: {
                        life: getStartingLife(),
                        joinedAt: serverTimestamp()
                    }
                }
            };
            
            try {
                await setDoc(roomRef, initialRoomData, { merge: false });
                // If successful, start listening to the room
                listenToRoom(id); 
            } catch (error) {
                console.error("Error creating room:", error);
                document.getElementById("status-message").innerHTML = "Error creating room. The ID might be taken.";
            }
        }
        
        function renderApp() {
            // No longer check URL parameters, always start at the setup view.
            renderSetupView();
        }

        // ----------------------------------------------------------------------
        // üöÄ 6. INITIALIZATION
        // ----------------------------------------------------------------------

        function initializeFirebase() {
            document.getElementById("status-message").innerHTML = "Connecting to Firebase...";

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    renderApp();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous Sign-In Failed:", error);
                        document.getElementById("status-message").innerHTML = "Authentication failed. Check Firebase config.";
                    }
                }
            });
        }

        initializeFirebase();

    </script>
</body>
</html>
