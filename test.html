<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTG Life Tracker</title>
  <style>
    :root{
      --bg:#0f1113;--card:#16181a;--muted:#9aa3ad;--text:#e6eef6;
      --accent:#2980b9;--accent-strong:#1f6fa8;--green:#27ae60;--red:#c0392b;
      --dark-border:#22272a;--input-bg:#1f2326;
    }
    /* Prevent layout overflow and ensure predictable sizing */
    *,*::before,*::after{ box-sizing:border-box }
    html,body{height:100%;margin:0}
    body{
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background:var(--bg);color:var(--text);display:flex;flex-direction:column;
      align-items:center;padding:20px;box-sizing:border-box;min-height:100vh;
      overflow-x:hidden; /* stop right-side clipping on mobile */
    }
    header.app-header{width:100%;max-width:1100px;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .app-title{margin:0;font-size:1.25rem;color:var(--text)}
    .app-subtitle{margin:0;font-size:0.8rem;color:var(--muted);font-style:italic}
    nav.site-nav{display:flex;gap:8px;flex-wrap:wrap}
    nav.site-nav button{background:transparent;color:var(--text);border:1px solid transparent;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    nav.site-nav button.active{background:rgba(41,128,185,0.10);border-color:var(--accent)}
    #app-container{width:100%;max-width:1100px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);box-sizing:border-box;position:relative}
    input,textarea,select{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid var(--dark-border);background:var(--input-bg);color:var(--text);box-sizing:border-box}
    textarea{min-height:120px;resize:vertical}
    input,button,textarea,select{-webkit-appearance:none;appearance:none;-webkit-tap-highlight-color:transparent}
    *:focus,*:focus-visible,*:focus-within{outline:none!important;box-shadow:none!important}
    button{
      cursor:pointer;border-radius:8px;padding:10px 12px;border:none;font-weight:700;
      transition:transform .03s ease,opacity .06s;
    }
    button:active,.tapped{transform:scale(.96)}
    .btn-primary{background:linear-gradient(180deg,var(--green),#1f8a4a);color:#fff}
    .btn-danger{background:linear-gradient(180deg,var(--red),#9b2b24);color:#fff}
    .btn-secondary{background:linear-gradient(180deg,#3a3a3a,#2f2f2f);color:#fff}
    button:disabled, input:disabled { opacity: .45; cursor: not-allowed; filter: grayscale(.2); }
    .player-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:12px}
    @media(max-width:900px){.player-grid{grid-template-columns:1fr}}
    .player-panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border:1px solid var(--dark-border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;box-shadow:0 6px 18px rgba(0,0,0,0.6);transform-origin:center center;transition:transform .18s ease,opacity .12s ease}
    .player-eliminated{opacity:.5}
    .player-header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .player-name{font-weight:800;font-size:1rem;color:var(--text)}
    .player-sub{font-size:.85rem;color:var(--muted)}
    .life-big{font-size:3.2rem;font-weight:900;color:var(--text);letter-spacing:-1px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .control-btn{padding:8px 12px;border-radius:8px;font-weight:800;min-width:56px;text-align:center;background:linear-gradient(180deg,#2b2b2b,#232323);color:var(--text);border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .control-btn.positive{background:linear-gradient(180deg,#2ecc71,#27ae60);color:#04260a}
    .control-btn.negative{background:linear-gradient(180deg,#ff6b6b,#c0392b);color:#2b0706}
    .cmd-block{display:flex;justify-content:space-between;align-items:center;gap:8px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    .cmd-label{font-size:.9rem;color:var(--muted)}
    .cmd-value{font-weight:800;color:#ffb3b3}
    .you-badge{background:linear-gradient(90deg,var(--accent),var(--accent-strong));color:#fff;padding:6px 8px;border-radius:999px;font-weight:800;font-size:.8rem}
    .cmd-controls{display:none;margin-top:10px}
    .cmd-controls.open{display:block}
    .cmd-controls.persistent{display:block;border:1px dashed rgba(255,255,255,0.03);padding:8px;border-radius:8px}
    .per-opp-container{margin-top:10px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto;border-top:1px solid rgba(255,255,255,0.02);padding-top:8px}
    .per-opp-row{height:44px;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);box-sizing:border-box}
    .per-opp-left{font-size:0.9em;color:var(--muted);font-weight:700}
    .per-opp-controls{display:flex;align-items:center;gap:8px}
    .outgoing-cmd-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .outgoing-cmd-item{font-size:0.95rem;color:var(--text);display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .infect-block{margin-top:8px;display:flex;align-items:center;gap:8px}
    .infect-label{font-size:0.85rem;color:var(--muted)}
    .infect-value{font-weight:800;color:#bfe6a8;min-width:36px;text-align:center}
    .small-btn{padding:6px 8px;font-size:0.85rem;min-width:36px;border-radius:6px}
    #chat-log{height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,0.03);padding:10px;margin-bottom:10px;border-radius:8px;background:#0f1113;font-size:.95em}
    .chat-message{margin-bottom:6px;display:flex;gap:8px;align-items:center}
    .chat-sender{font-weight:800;color:#74b9ff;margin-right:6px}
    .chat-sender.system{color:#ffd166;font-weight:900}
    .chat-card{display:inline-block;position:relative;cursor:pointer;color:var(--text);text-decoration:underline dotted rgba(255,255,255,0.08)}
    #chat-card-preview{position:fixed;top:50%;right:20px;transform:translateY(-50%);width:300px;max-width:40vw;border:3px solid var(--accent);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.7);background:#0b0d0f;z-index:1500;display:none;padding:8px}
    #chat-card-preview img{display:block;width:100%;border-radius:6px}
    #chat-card-preview .card-title{margin-top:8px;font-weight:800;color:var(--text);text-align:center}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:2000;padding:16px}
    .modal-content{background:#16181a;color:var(--text);padding:20px;border-radius:10px;width:100%;max-width:520px;box-shadow:0 12px 40px rgba(0,0,0,.7);position:relative}
    .suggestions-list{position:absolute;width:100%;background:var(--input-bg);border:1px solid var(--dark-border);border-top:none;max-height:150px;overflow-y:auto;z-index:100;border-radius:0 0 8px 8px;box-shadow:0 6px 18px rgba(0,0,0,0.6);margin-top:-10px}
    .suggestions-list:empty{display:none!important;border:none!important;box-shadow:none!important;margin-top:0!important}
    .suggestion-item{padding:8px 12px;cursor:pointer;color:var(--text)}
    .suggestion-item:hover{background:rgba(41,128,185,.08)}
    #lobby-card-preview{position:fixed;top:50%;left:20px;transform:translateY(-50%);width:260px;border:3px solid var(--accent);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.8);z-index:999;display:none;background:#0b0d0f}
    #lobby-card-preview img{display:block;width:100%;border-radius:6px}
    #lobby-features{margin-top:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #room-footer{margin-top:14px;color:var(--muted);font-size:.9rem;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    /* Chat full width container */
    #chat-container{width:100%;margin-top:18px}
    #chat-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    /* Mobile-specific layout fixes */
    @media(max-width:720px){
      header.app-header{flex-direction:column;align-items:flex-start;gap:8px}
      #lobby-card-preview{display:none!important}
      #chat-card-preview{display:none!important}
      /* Stack the inner player panel columns vertically to avoid horizontal overflow */
      .player-panel > div[style*="display:flex"][style*="justify-content:space-between"]{
        flex-direction:column!important;align-items:stretch!important;gap:12px!important
      }
      /* Make the right-side controls full width on mobile */
      .player-panel .controls{width:100%}
      .player-panel div[style*="min-width:220px"]{min-width:0!important;width:100%!important}
      /* Reduce container padding slightly */
      #app-container{padding:14px}
      body{padding:14px}
    }

    /* Rotation controls */
    .panel-rotate-controls{display:flex;gap:6px;align-items:center}
    .rotate-btn{padding:6px 8px;border-radius:6px;background:linear-gradient(180deg,#2b2b2b,#232323);color:var(--text);font-weight:800;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .rotate-indicator{font-size:0.85rem;color:var(--muted);min-width:36px;text-align:center}
    .rotate-hint{font-size:0.8rem;color:var(--muted);margin-left:6px}
    /* Ensure rotated panels don't overflow their grid cell */
    .player-panel-wrapper{display:flex;justify-content:center;align-items:center;min-height:120px}
    /* When panel is rotated 90 or 270, allow it to scale down slightly to fit */
    .player-panel.rotated-90, .player-panel.rotated-270{transform-origin:center center;transition:transform .18s ease}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="brand">
      <h1 class="app-title">Cardboard Bonfire</h1>
      <div class="app-subtitle">Life tracker for keeping life and bringing people together.</div>
    </div>
    <nav class="site-nav" role="navigation" aria-label="Main">
      <button id="nav-home" class="nav-btn">Home</button>
      <button id="nav-local" class="nav-btn">Local</button>
      <button id="nav-changes" class="nav-btn">Changes</button>
      <button id="nav-contact" class="nav-btn">Contact</button>
    </nav>
  </header>

  <main id="app-container" role="main"></main>

  <div id="lobby-card-preview" aria-hidden="true"><img id="preview-img" alt="Commander Preview"></div>
  <div id="chat-card-preview" aria-hidden="true"><img id="chat-preview-img" alt="Card Preview"><div class="card-title" id="chat-preview-title"></div></div>
  <p id="status-message" class="muted">Initializing...</p>

  <div id="card-search-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 style="margin-top:0">Card Search (Scryfall)</h3>
      <input type="text" id="modal-card-name" placeholder="Enter card name" autocomplete="off">
      <div id="modal-suggestions-list" class="suggestions-list"></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="modal-search-btn" class="btn-primary">Search & Post</button>
        <button id="modal-close-btn" class="btn-secondary">Close</button>
      </div>
      <div id="search-results" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="edit-commander-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 style="margin-top:0">Edit Commander</h3>
      <input type="text" id="edit-commander-name" placeholder="Commander name">
      <div id="edit-commander-suggestions" class="suggestions-list"></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="edit-commander-save" class="btn-primary">Save</button>
        <button id="edit-commander-cancel" class="btn-secondary">Cancel</button>
      </div>
      <div id="edit-commander-result" style="margin-top:12px"></div>
    </div>
  </div>

  <script type="module">
    // ----------------------------------------------------------------------
    // CONFIG
    // ----------------------------------------------------------------------
    const USER_FIREBASE_CONFIG = {
      apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E",
      authDomain: "mtg-life-tool.firebaseapp.com",
      projectId: "mtg-life-tool",
      storageBucket: "mtg-life-tool.appspot.com",
      messagingSenderId: "36730058988",
      appId: "1:36730058988:web:757e2d9620593b4f65022a"
    };

    // TIMEOUT: set to 20 minutes per request
    const TIMEOUT_MINUTES = 20;

    const SCRYFALL_API = "https://api.scryfall.com/cards/named?exact=";
    const SCRYFALL_AUTOCOMPLETE_API = "https://api.scryfall.com/cards/autocomplete?q=";
    const DELETE_ALL_PWD = "DeleteAllRooms";
    const AUTOCOMPLETE_DEBOUNCE_MS = 100;

    // ----------------------------------------------------------------------
    // IMPORTS
    // ----------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp,
      arrayUnion, deleteDoc, collection, getDocs, query, limit, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ----------------------------------------------------------------------
    // GLOBALS
    // ----------------------------------------------------------------------
    const app = initializeApp(USER_FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userId = null;
    let roomId = null;
    let unsubscribe = null;
    let autocompleteTimeout = null;
    const ROOM_COLLECTION = "mtg_rooms";

    // Track which players' CMD controls are open (persist across renders)
    const openCmdControls = new Set();

    // ----------------------------------------------------------------------
    // HELPERS
    // ----------------------------------------------------------------------
    function hashPassword(password){ return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex); }
    function getStartingLife(){ return 40; }

    async function validateCommander(name){
      if(!name) return null;
      try{
        const response = await fetch(`${SCRYFALL_API}${encodeURIComponent(name)}`);
        const data = await response.json();
        if(response.ok){
          const imageUrl = data.image_uris?.normal || data.card_faces?.[0]?.image_uris?.normal;
          if(imageUrl) return { validatedName: data.name, imageUrl };
        }
        return null;
      }catch(e){ console.error("Scryfall validation error:", e); return null; }
    }

    async function fetchAutocompleteSuggestions(query, listId, inputId){
      const suggestionsList = document.getElementById(listId);
      const inputField = document.getElementById(inputId);
      if(!suggestionsList || !inputField) return;
      suggestionsList.innerHTML = '';
      if(query.length < 2) return;
      try{
        const response = await fetch(`${SCRYFALL_AUTOCOMPLETE_API}${encodeURIComponent(query)}`);
        const data = await response.json();
        if(response.ok && data.data && data.data.length){
          data.data.slice(0,5).forEach(suggestion=>{
            const item = document.createElement('div');
            item.classList.add('suggestion-item');
            item.textContent = suggestion;
            item.onclick = () => { inputField.value = suggestion; suggestionsList.innerHTML = ''; };
            suggestionsList.appendChild(item);
          });
        }
      }catch(e){ console.error("Autocomplete error:", e); }
    }

    // compute outgoing map for a source player (what this player's commander has done to others)
    function computeOutgoingCmdDamage(roomData, sourcePlayerId){
      const players = roomData.players || {};
      const order = Array.isArray(roomData.playersOrder) && roomData.playersOrder.length ? roomData.playersOrder : Object.keys(players || {});
      const result = [];
      order.forEach(pid => {
        if(pid === sourcePlayerId) return;
        const dmg = (players[sourcePlayerId]?.commanderDamage || {})[pid] || 0;
        const name = players[pid]?.name || 'Player';
        result.push({ oppId: pid, oppName: name, dmg });
      });
      return result;
    }

    // compute outgoing total for a source player (sum of their commanderDamage map)
    function computeOutgoingTotal(roomData, sourcePlayerId){
      const dmgMap = (roomData.players?.[sourcePlayerId]?.commanderDamage) || {};
      return Object.keys(dmgMap).reduce((s,k)=> s + (parseInt(dmgMap[k])||0), 0);
    }

    // compute incoming total for a target player
    function computeIncomingCmdDamage(roomData, targetPlayerId){
      let total = 0;
      const players = roomData.players || {};
      Object.keys(players).forEach(pid=>{
        const dmgMap = players[pid]?.commanderDamage || {};
        const val = dmgMap[targetPlayerId] || 0;
        total += val;
      });
      return total;
    }

    // compute max incoming from a single opponent to target (for 21+ elimination)
    function computeMaxSingleIncomingCmdDamage(roomData, targetPlayerId){
      let maxVal = 0;
      const players = roomData.players || {};
      Object.keys(players).forEach(pid=>{
        const dmgMap = players[pid]?.commanderDamage || {};
        const val = dmgMap[targetPlayerId] || 0;
        if(val > maxVal) maxVal = val;
      });
      return maxVal;
    }

    // ----------------------------------------------------------------------
    // ROUTING & PAGES
    // ----------------------------------------------------------------------
    const navButtons = {
      home: document.getElementById('nav-home'),
      local: document.getElementById('nav-local'),
      changes: document.getElementById('nav-changes'),
      contact: document.getElementById('nav-contact')
    };
    function setActiveNav(page){
      Object.values(navButtons).forEach(b=>b.classList.remove('active'));
      if(navButtons[page]) navButtons[page].classList.add('active');
    }
    function navigateTo(page){
      if(location.hash !== `#${page}`) history.pushState(null,'',`#${page}`);
      setActiveNav(page);
      if(page === 'home') renderHome();
      else if(page === 'local') renderLocal();
      else if(page === 'changes') renderChanges();
      else if(page === 'contact') renderContact();
    }
    navButtons.home.addEventListener('click', ()=>navigateTo('home'));
    navButtons.local.addEventListener('click', ()=>navigateTo('local'));
    navButtons.changes.addEventListener('click', ()=>navigateTo('changes'));
    navButtons.contact.addEventListener('click', ()=>navigateTo('contact'));
    window.addEventListener('popstate', ()=>{
      const page = (location.hash || '#home').replace('#','') || 'home';
      setActiveNav(page);
      if(page === 'home') renderHome();
      else if(page === 'local') renderLocal();
      else if(page === 'changes') renderChanges();
      else if(page === 'contact') renderContact();
    });

    async function renderHome(){ await renderSetupView(); }

    const CHANGELOG = [
      { version: "0.9.8", date: "2025-12-08", notes: "Show CMD labels, persist lobby on refresh, 20-minute timeout based on life changes, lobby timestamps." },
      { version: "0.9.7", date: "2025-12-07", notes: "Show CMD DMG to/from on each panel; incoming editor updates opponent's outgoing." }
    ];

    function renderChanges(){
      const appContainer = document.getElementById('app-container');
      let html = `<h2 style="margin-top:0;color:var(--text)">Changes</h2><div style="display:flex;flex-direction:column;gap:12px">`;
      CHANGELOG.forEach(entry=>{
        html += `<div style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border)"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700;color:var(--text)">${entry.version}</div><div class="muted">${entry.date}</div></div><div style="margin-top:8px;color:var(--text)">${entry.notes}</div></div>`;
      });
      html += `</div>`;
      appContainer.innerHTML = html;
    }

    function renderContact(){
      const appContainer = document.getElementById('app-container');
      appContainer.innerHTML = `
        <h2 style="margin-top:0;color:var(--text)">Contact</h2>
        <p class="muted">To contact me, please use your email client. Click the button below to open a new message addressed to <strong>CardboardBonfire@gmail.com</strong>.</p>
        <div style="max-width:640px">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="contact-mailto" class="btn-primary">Email CardboardBonfire@gmail.com</button>
            <button id="contact-copy" class="btn-secondary">Copy Email</button>
          </div>
          <p id="contact-status" class="muted" style="margin-top:8px"></p>
        </div>
      `;
      document.getElementById('contact-mailto').addEventListener('click', ()=>{
        const subject = encodeURIComponent("Contact from MTG Life Tracker");
        const body = encodeURIComponent("Hi,\n\nI'd like to get in touch regarding...");
        window.location.href = `mailto:CardboardBonfire@gmail.com?subject=${subject}&body=${body}`;
      });
      document.getElementById('contact-copy').addEventListener('click', async ()=>{
        const status = document.getElementById('contact-status');
        try{ await navigator.clipboard.writeText('CardboardBonfire@gmail.com'); status.textContent = 'Email address copied to clipboard.'; }
        catch(e){ console.error(e); status.textContent = 'Unable to copy automatically — please copy: CardboardBonfire@gmail.com'; }
      });
    }

    // ----------------------------------------------------------------------
    // LOCAL PAGE (offline life tracker; single add box; no lobby name)
    // ----------------------------------------------------------------------
    const LOCAL_STORAGE_KEY = 'localRoom_v2';

    function getLocalData(){
      const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
      try { return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function setLocalData(data){
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
    }
    function resetLocalRoom(){
      localStorage.removeItem(LOCAL_STORAGE_KEY);
    }
    function uid(){ return 'p' + Math.random().toString(36).slice(2,9); }

    // Helper to ensure player rotation and cmd persistence defaults
    function ensurePlayerDefaults(player){
      if(typeof player.rotation === 'undefined') player.rotation = 0; // degrees: 0,90,180,270
      if(typeof player.cmdPersistent === 'undefined') player.cmdPersistent = false;
      if(typeof player.life === 'undefined') player.life = getStartingLife();
      if(typeof player.infect === 'undefined') player.infect = 0;
      if(typeof player.commanderDamage === 'undefined') player.commanderDamage = {};
      if(typeof player.commanderName === 'undefined') player.commanderName = '';
    }

    function renderLocal(){
      const appContainer = document.getElementById('app-container');
      const cached = getLocalData();

      let html = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          <div>
            <h2 style="margin:0;color:var(--text)">Local Game</h2>
            <div class="muted" style="font-size:.9rem;margin-top:6px">Offline life tracking. Data stays in your browser.</div>
          </div>
          <div class="row">
            <button id="local-new-btn" class="btn-secondary">New Local Session</button>
            ${cached ? `<button id="local-reset-btn" class="btn-danger">Clear Local Data</button>` : ``}
          </div>
        </div>
      `;

      // Single add-player box (no lobby name)
      html += `
        <div id="local-setup" style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border);margin-bottom:12px">
          <div class="row" style="gap:12px">
            <div style="flex:1"><input type="text" id="local-player-name" placeholder="Player name"></div>
            <div style="width:220px"><input type="text" id="local-commander-name" placeholder="Commander (optional)"></div>
            <div style="width:160px"><button id="local-add-player-btn" class="btn-primary" style="width:100%">Add Player</button></div>
          </div>
          <p id="local-status" class="muted" style="margin-top:8px"></p>
        </div>
      `;

      html += `<div id="local-room-container"></div>`;
      appContainer.innerHTML = html;

      // Header actions
      document.getElementById('local-new-btn').addEventListener('click', ()=>{
        resetLocalRoom();
        const init = { roomName: 'Local Lobby', createdAt: Date.now(), playersOrder: [], players: {} };
        setLocalData(init);
        const status = document.getElementById('local-status');
        if(status) status.textContent = 'New local session started. Add players below.';
        renderLocalRoom(init);
      });
      const resetBtn = document.getElementById('local-reset-btn');
      if(resetBtn){
        resetBtn.addEventListener('click', ()=>{
          if(!confirm('Clear all local game data? This cannot be undone.')) return;
          resetLocalRoom();
          renderLocal();
        });
      }

      // Initial render: ensure a local session exists (no name needed)
      let data = cached || { roomName: 'Local Lobby', createdAt: Date.now(), playersOrder: [], players: {} };
      // Ensure defaults for existing players
      Object.values(data.players || {}).forEach(p => ensurePlayerDefaults(p));
      setLocalData(data);
      renderLocalRoom(data);

      // Add player from single box
      document.getElementById('local-add-player-btn').addEventListener('click', ()=>{
        const playerName = (document.getElementById('local-player-name').value || '').trim();
        const commander = (document.getElementById('local-commander-name').value || '').trim();
        if(!playerName){
          const status = document.getElementById('local-status');
          if(status) status.textContent = 'Enter a player name.';
          return;
        }
        const d = getLocalData() || data;
        const pid = uid();
        d.players[pid] = {
          name: playerName,
          life: getStartingLife(),
          infect: 0,
          commanderName: commander || '',
          commanderDamage: {},
          rotation: 0,
          cmdPersistent: false
        };
        d.playersOrder.push(pid);
        setLocalData(d);
        document.getElementById('local-player-name').value = '';
        document.getElementById('local-commander-name').value = '';
        renderLocalRoom(d);
      });
    }

    function renderLocalRoom(roomData){
      const container = document.getElementById('local-room-container');
      if(!container) return;

      const playerIds = Array.isArray(roomData.playersOrder) && roomData.playersOrder.length
        ? [...roomData.playersOrder]
        : Object.keys(roomData.players || {});

      let html = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          <div>
            <h3 style="margin:0;color:var(--text)">Lobby: ${roomData.roomName || 'Local Lobby'}</h3>
            <div class="muted" style="font-size:.9rem;margin-top:6px">Players: ${playerIds.length}</div>
          </div>
          <div class="row">
            <button id="local-restart-btn" class="btn-secondary">Restart Game</button>
          </div>
        </div>
      `;

      html += `<div class="player-grid">`;

      playerIds.forEach(pid=>{
        const p = roomData.players[pid];
        if(!p) return;
        ensurePlayerDefaults(p);

        // Elimination: life <= 0 or incoming CMD from any single opponent >= 21
        const maxSingleIncoming = (() => {
          let maxVal = 0;
          Object.keys(roomData.players || {}).forEach(oppId=>{
            const dmgMap = roomData.players[oppId]?.commanderDamage || {};
            const val = dmgMap[pid] || 0;
            if(val > maxVal) maxVal = val;
          });
          return maxVal;
        })();
        const isEliminated = (p.life <= 0) || (maxSingleIncoming >= 21);

        const outgoingTotal = computeOutgoingTotal(roomData, pid);
        const outgoingBreakdown = computeOutgoingCmdDamage(roomData, pid);

        let outgoingBreakdownHtml = '<div class="outgoing-cmd-list">';
        if(outgoingBreakdown.length === 0){
          outgoingBreakdownHtml += `<div class="outgoing-cmd-item" style="justify-content:center;color:var(--muted)">No opponents yet</div>`;
        }else{
          outgoingBreakdown.forEach(item=>{
            outgoingBreakdownHtml += `<div class="outgoing-cmd-item"><div style="font-weight:700;color:var(--muted)">${item.oppName}: </div><div style="font-weight:900;color:#ffb3b3">${item.dmg}</div></div>`;
          });
        }
        outgoingBreakdownHtml += '</div>';

        // Per-opponent incoming editor (local): always editable
        let perOppRows = '';
        const opponents = playerIds.filter(id => id !== pid);
        opponents.forEach(oppId=>{
          const dmg = (roomData.players[oppId]?.commanderDamage || {})[pid] || 0;
          const oppName = roomData.players[oppId]?.name || 'Player';
          perOppRows += `
            <div class="per-opp-row" data-target="${pid}" data-opp="${oppId}">
              <div class="per-opp-left">From <strong>${oppName}</strong></div>
              <div class="per-opp-controls">
                <button class="control-btn negative small-btn" data-local-action="cmd-target-sub" data-target="${pid}" data-opp="${oppId}">-</button>
                <input type="number" value="${dmg}" data-target="${pid}" data-opp="${oppId}" class="cmd-target-input" style="width:64px;padding:6px;border-radius:6px;border:1px solid var(--dark-border);background:var(--input-bg);color:var(--text);text-align:center">
                <button class="control-btn negative small-btn" data-local-action="cmd-target-add" data-target="${pid}" data-opp="${oppId}">+</button>
              </div>
            </div>
          `;
        });

        const infectControlsHtml = `
          <div style="display:flex;align-items:center;gap:6px">
            <button class="control-btn small-btn" data-local-action="infect-sub" data-player="${pid}">-</button>
            <div class="infect-value" id="local-infect-${pid}">${p.infect || 0}</div>
            <button class="control-btn small-btn" data-local-action="infect-add" data-player="${pid}">+</button>
          </div>
        `;

        // Rotation controls: cycle 0 -> 90 -> 180 -> 270 -> 0
        const rotation = p.rotation || 0;
        const rotationLabel = `${rotation}°`;

        // CMD controls open state: if persistent flag true, show as open
        const cmdOpenClass = p.cmdPersistent ? 'open persistent' : '';

        html += `
          <div class="player-panel-wrapper">
            <div class="player-panel" id="panel-${pid}" data-player="${pid}" style="transform: rotate(${rotation}deg);">
              <div class="player-header">
                <div style="display:flex;gap:8px;align-items:center">
                  <div class="player-name">${p.name}</div>
                  ${p.commanderName ? `<div class="player-sub">— ${p.commanderName}</div>` : ''}
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <div class="panel-rotate-controls" title="Rotate panel for table viewing">
                    <button class="rotate-btn" data-local-action="rotate-prev" data-player="${pid}">⟲</button>
                    <div class="rotate-indicator" id="rotate-ind-${pid}">${rotationLabel}</div>
                    <button class="rotate-btn" data-local-action="rotate-next" data-player="${pid}">⟳</button>
                  </div>
                  <div style="width:8px"></div>
                  <div class="row">
                    <button class="control-btn small-btn" data-local-action="life-sub" data-player="${pid}">-</button>
                    <div style="min-width:80px;text-align:center">
                      <div class="life-big" id="local-life-${pid}">${p.life}</div>
                      <div class="muted" style="font-size:.85rem">Life</div>
                    </div>
                    <button class="control-btn small-btn positive" data-local-action="life-add" data-player="${pid}">+</button>
                  </div>
                </div>
              </div>

              <div class="cmd-block" style="margin-top:6px">
                <div style="display:flex;flex-direction:column">
                  <div class="cmd-label">Outgoing CMD DMG</div>
                  <div class="cmd-value" id="local-cmd-to-${pid}">${outgoingTotal}</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <button class="control-btn small-btn" data-local-action="toggle-cmd-controls" data-player="${pid}">${p.cmdPersistent ? 'CMD (Pinned)' : 'CMD'}</button>
                  <button class="control-btn small-btn" data-local-action="edit-commander" data-player="${pid}">Edit CMD</button>
                </div>
              </div>

              <div class="cmd-controls ${cmdOpenClass}" id="cmd-controls-${pid}">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                  <div style="font-weight:700;color:var(--muted)">Incoming CMD From Opponents</div>
                  <div style="font-weight:900;color:#ffb3b3" id="local-cmd-incoming-${pid}">${computeIncomingCmdDamage(roomData, pid)}</div>
                </div>

                <div class="per-opp-container" id="per-opp-${pid}">
                  ${perOppRows || `<div class="muted">No opponents yet</div>`}
                </div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                  <div class="infect-block">
                    <div class="infect-label">Infect</div>
                    ${infectControlsHtml}
                  </div>
                  <div style="display:flex;gap:8px;align-items:center">
                    <button class="control-btn small-btn" data-local-action="reset-cmd" data-player="${pid}">Reset CMD</button>
                    <button class="control-btn small-btn btn-danger" data-local-action="eliminate" data-player="${pid}">Eliminate</button>
                  </div>
                </div>

                <div style="margin-top:8px">${outgoingBreakdownHtml}</div>
              </div>

            </div>
          </div>
        `;
      });

      html += `</div>`; // close player-grid

      container.innerHTML = html;

      // Attach event listeners for local controls
      document.getElementById('local-restart-btn').addEventListener('click', ()=>{
        if(!confirm('Restart game and reset all players to starting life?')) return;
        const d = getLocalData() || roomData;
        Object.keys(d.players || {}).forEach(pid=>{
          d.players[pid].life = getStartingLife();
          d.players[pid].infect = 0;
          d.players[pid].commanderDamage = {};
          d.players[pid].cmdPersistent = false;
          d.players[pid].rotation = 0;
        });
        setLocalData(d);
        renderLocalRoom(d);
      });

      // Generic delegation for local actions
      container.querySelectorAll('[data-local-action]').forEach(el=>{
        el.addEventListener('click', (ev)=>{
          const action = el.getAttribute('data-local-action');
          const player = el.getAttribute('data-player');
          const target = el.getAttribute('data-target');
          const opp = el.getAttribute('data-opp');
          handleLocalAction(action, player, target, opp);
        });
      });

      // Inputs for per-opp numeric edits
      container.querySelectorAll('.cmd-target-input').forEach(input=>{
        input.addEventListener('change', (ev)=>{
          const t = input.getAttribute('data-target');
          const o = input.getAttribute('data-opp');
          const val = parseInt(input.value) || 0;
          const d = getLocalData();
          if(!d || !d.players) return;
          if(!d.players[o]) return;
          if(!d.players[o].commanderDamage) d.players[o].commanderDamage = {};
          d.players[o].commanderDamage[t] = val;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });

      // Small +/- buttons for per-opp
      container.querySelectorAll('[data-local-action="cmd-target-add"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const t = btn.getAttribute('data-target');
          const o = btn.getAttribute('data-opp');
          const d = getLocalData();
          if(!d || !d.players) return;
          if(!d.players[o]) return;
          if(!d.players[o].commanderDamage) d.players[o].commanderDamage = {};
          d.players[o].commanderDamage[t] = (parseInt(d.players[o].commanderDamage[t])||0) + 1;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });
      container.querySelectorAll('[data-local-action="cmd-target-sub"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const t = btn.getAttribute('data-target');
          const o = btn.getAttribute('data-opp');
          const d = getLocalData();
          if(!d || !d.players) return;
          if(!d.players[o]) return;
          if(!d.players[o].commanderDamage) d.players[o].commanderDamage = {};
          d.players[o].commanderDamage[t] = Math.max(0, (parseInt(d.players[o].commanderDamage[t])||0) - 1);
          setLocalData(d);
          renderLocalRoom(d);
        });
      });

      // Life +/- handlers
      container.querySelectorAll('[data-local-action="life-add"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          d.players[pid].life = (parseInt(d.players[pid].life)||0) + 1;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });
      container.querySelectorAll('[data-local-action="life-sub"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          d.players[pid].life = (parseInt(d.players[pid].life)||0) - 1;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });

      // Infect +/- handlers
      container.querySelectorAll('[data-local-action="infect-add"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          d.players[pid].infect = (parseInt(d.players[pid].infect)||0) + 1;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });
      container.querySelectorAll('[data-local-action="infect-sub"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          d.players[pid].infect = Math.max(0, (parseInt(d.players[pid].infect)||0) - 1);
          setLocalData(d);
          renderLocalRoom(d);
        });
      });

      // Reset CMD
      container.querySelectorAll('[data-local-action="reset-cmd"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          // Clear outgoing commander damage from this player
          d.players[pid].commanderDamage = {};
          setLocalData(d);
          renderLocalRoom(d);
        });
      });

      // Eliminate
      container.querySelectorAll('[data-local-action="eliminate"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          d.players[pid].life = -999;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });

      // Edit commander (open modal)
      container.querySelectorAll('[data-local-action="edit-commander"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          openEditCommanderModal(pid);
        });
      });

      // Toggle CMD controls persistent/open
      container.querySelectorAll('[data-local-action="toggle-cmd-controls"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          // Toggle persistent flag
          d.players[pid].cmdPersistent = !d.players[pid].cmdPersistent;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });

      // Rotation controls
      container.querySelectorAll('[data-local-action="rotate-next"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          const current = d.players[pid].rotation || 0;
          const next = (current + 90) % 360;
          d.players[pid].rotation = next;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });
      container.querySelectorAll('[data-local-action="rotate-prev"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pid = btn.getAttribute('data-player');
          const d = getLocalData();
          if(!d || !d.players || !d.players[pid]) return;
          const current = d.players[pid].rotation || 0;
          const next = (current - 90 + 360) % 360;
          d.players[pid].rotation = next;
          setLocalData(d);
          renderLocalRoom(d);
        });
      });

      // Also attach change handlers for numeric inputs inside per-opp rows (already done above)
    }

    // Edit commander modal logic (local)
    function openEditCommanderModal(pid){
      const modal = document.getElementById('edit-commander-modal');
      const nameInput = document.getElementById('edit-commander-name');
      const saveBtn = document.getElementById('edit-commander-save');
      const cancelBtn = document.getElementById('edit-commander-cancel');
      const suggestions = document.getElementById('edit-commander-suggestions');
      const result = document.getElementById('edit-commander-result');

      const d = getLocalData();
      if(!d || !d.players || !d.players[pid]) return;
      nameInput.value = d.players[pid].commanderName || '';
      suggestions.innerHTML = '';
      result.innerHTML = '';

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');

      const closeModal = ()=>{
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
      };

      cancelBtn.onclick = ()=>{ closeModal(); };
      saveBtn.onclick = async ()=>{
        const newName = (nameInput.value || '').trim();
        // Optionally validate via Scryfall (non-blocking)
        if(newName){
          const validated = await validateCommander(newName);
          if(validated){
            d.players[pid].commanderName = validated.validatedName;
            // we don't store image in local for now, but could
            setLocalData(d);
            result.textContent = `Commander set to "${validated.validatedName}".`;
            renderLocalRoom(d);
            setTimeout(()=> closeModal(), 600);
            return;
          }else{
            // If validation fails, still allow saving the raw name
            d.players[pid].commanderName = newName;
            setLocalData(d);
            result.textContent = `Saved "${newName}" (validation not found).`;
            renderLocalRoom(d);
            setTimeout(()=> closeModal(), 600);
            return;
          }
        }else{
          d.players[pid].commanderName = '';
          setLocalData(d);
          result.textContent = 'Cleared commander name.';
          renderLocalRoom(d);
          setTimeout(()=> closeModal(), 600);
        }
      };
    }

    // ----------------------------------------------------------------------
    // SETUP / HOME VIEW (simple)
    // ----------------------------------------------------------------------
    async function renderSetupView(){
      const appContainer = document.getElementById('app-container');
      appContainer.innerHTML = `
        <h2 style="margin-top:0;color:var(--text)">Welcome</h2>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:280px">
            <div style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border)">
              <h3 style="margin-top:0;color:var(--text)">Start a Local Game</h3>
              <p class="muted">Quickly set up an offline game for friends around a table.</p>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="start-local-btn" class="btn-primary">Open Local Game</button>
                <button id="learn-more-btn" class="btn-secondary">How it works</button>
              </div>
            </div>
          </div>
          <div style="flex:1;min-width:280px">
            <div style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border)">
              <h3 style="margin-top:0;color:var(--text)">Online Rooms (coming soon)</h3>
              <p class="muted">Create a lobby and share with friends. (This demo focuses on local mode.)</p>
            </div>
          </div>
        </div>
      `;

      document.getElementById('start-local-btn').addEventListener('click', ()=>navigateTo('local'));
      document.getElementById('learn-more-btn').addEventListener('click', ()=>alert('Local mode stores data in your browser. Use rotate controls on each panel to orient them for players around a table. Use the CMD button to pin/unpin the commander damage editor for each player.'));
    }

    // ----------------------------------------------------------------------
    // INITIALIZE
    // ----------------------------------------------------------------------
    (function init(){
      const page = (location.hash || '#home').replace('#','') || 'home';
      setActiveNav(page);
      if(page === 'home') renderHome();
      else if(page === 'local') renderLocal();
      else if(page === 'changes') renderChanges();
      else if(page === 'contact') renderContact();
    })();

    // ----------------------------------------------------------------------
    // LOCAL ACTION HANDLER (delegated)
    // ----------------------------------------------------------------------
    function handleLocalAction(action, player, target, opp){
      const d = getLocalData();
      if(!d) return;
      switch(action){
        case 'cmd-target-add':
          if(!d.players[opp]) return;
          if(!d.players[opp].commanderDamage) d.players[opp].commanderDamage = {};
          d.players[opp].commanderDamage[target] = (parseInt(d.players[opp].commanderDamage[target])||0) + 1;
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'cmd-target-sub':
          if(!d.players[opp]) return;
          if(!d.players[opp].commanderDamage) d.players[opp].commanderDamage = {};
          d.players[opp].commanderDamage[target] = Math.max(0, (parseInt(d.players[opp].commanderDamage[target])||0) - 1);
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'life-add':
          if(!d.players[player]) return;
          d.players[player].life = (parseInt(d.players[player].life)||0) + 1;
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'life-sub':
          if(!d.players[player]) return;
          d.players[player].life = (parseInt(d.players[player].life)||0) - 1;
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'infect-add':
          if(!d.players[player]) return;
          d.players[player].infect = (parseInt(d.players[player].infect)||0) + 1;
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'infect-sub':
          if(!d.players[player]) return;
          d.players[player].infect = Math.max(0, (parseInt(d.players[player].infect)||0) - 1);
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'reset-cmd':
          if(!d.players[player]) return;
          d.players[player].commanderDamage = {};
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'eliminate':
          if(!d.players[player]) return;
          d.players[player].life = -999;
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'edit-commander':
          openEditCommanderModal(player);
          break;
        case 'toggle-cmd-controls':
          if(!d.players[player]) return;
          // Toggle persistent flag. This makes the CMD controls remain open until toggled again.
          d.players[player].cmdPersistent = !d.players[player].cmdPersistent;
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'rotate-next':
          if(!d.players[player]) return;
          d.players[player].rotation = (d.players[player].rotation + 90) % 360;
          setLocalData(d);
          renderLocalRoom(d);
          break;
        case 'rotate-prev':
          if(!d.players[player]) return;
          d.players[player].rotation = (d.players[player].rotation - 90 + 360) % 360;
          setLocalData(d);
          renderLocalRoom(d);
          break;
        default:
          // no-op
          break;
      }
    }

    // ----------------------------------------------------------------------
    // NOTES:
    // 1) Commander damage box persistence:
    //    - Each local player object now has a boolean `cmdPersistent`.
    //    - Clicking the "CMD" button toggles that flag.
    //    - When `cmdPersistent` is true the `.cmd-controls` element is rendered with classes `open persistent`
    //      which keeps it visible until the user clicks the CMD button again.
    //test
    // 2) Panel rotation:
    //    - Each local player object now has a numeric `rotation` property (0,90,180,270).
    //    - Two rotate buttons cycle the rotation forward/backward.
    //    - The panel element receives an inline `transform: rotate(Xdeg)` style so players can orient their panel.
    //    - Rotation is persisted in localStorage with the rest of the local room data.
    //
    // Implementation is intentionally limited to the local/offline mode as requested.
    // ----------------------------------------------------------------------
  </script>
</body>
</html>
