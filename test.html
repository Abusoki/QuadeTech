<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTG Life Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#0f1113;--card:#16181a;--muted:#9aa3ad;--text:#e6eef6;
      --accent:#2980b9;--accent-strong:#1f6fa8;--green:#27ae60;--red:#c0392b;
      --dark-border:#22272a;--input-bg:#1f2326;
    }
    html,body{height:100%;margin:0}
    body{
      font-family: "Inter", sans-serif;
      background:var(--bg);color:var(--text);display:flex;flex-direction:column;
      align-items:center;padding:20px;box-sizing:border-box;min-height:100vh;
    }
    header.app-header{width:100%;max-width:1100px;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .app-title{font-size:1.8rem;font-weight:700;color:var(--accent)}
    .app-subtitle{font-size:.7rem;color:var(--muted)}
    main{width:100%;max-width:1100px;flex-grow:1}
    #game-container{display:grid;gap:20px;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr))}
    .player-card{
      background-color:var(--card);border-radius:12px;overflow:hidden;
      box-shadow:0 10px 15px rgba(0,0,0,.2);transition:all .3s ease;
      position:relative;/* Needed for commander image */
      border:1px solid var(--dark-border);
    }
    .commander-image-container{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background-size:cover;background-position:center;
      transition:opacity 0.3s ease;
    }
    .commander-image-container::before{
      content:'';position:absolute;top:0;left:0;width:100%;height:100%;
      /* Dark overlay for readability */
      background:rgba(0,0,0,0.5); 
      backdrop-filter: blur(2px);
    }
    .player-content{
      position:relative;z-index:10;
      padding:20px;
      display:flex;flex-direction:column;
      align-items:center;justify-content:space-between;
      height:100%; /* Ensure content takes up full height */
    }
    .commander-info{
      font-size:.7rem;color:rgba(255,255,255,0.7);text-align:center;
      margin-top:10px;padding:0 5px;
    }

    /* Card Status/Info area */
    .card-info{display:flex;justify-content:space-between;width:100%;margin-bottom:10px}
    .player-id{font-size:.75rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:calc(100% - 100px);margin-right:10px;}
    .host-badge{background:var(--accent);padding:2px 6px;border-radius:6px;font-size:.7rem;font-weight:600}

    /* Life Display */
    .life-display{font-size:6rem;font-weight:900;margin:15px 0 10px;line-height:1}
    .life-display.danger{color:var(--red)}
    .life-display.safe{color:var(--green)}

    /* Poison and Commander Damage */
    .status-trackers{display:flex;gap:15px;margin-bottom:15px}
    .status-tracker{font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:5px}
    .status-value{font-size:1.5rem;color:var(--accent)}

    /* Control Buttons */
    .control-group{display:flex;gap:10px;width:100%;justify-content:center;margin-bottom:15px}
    .control-btn{padding:10px 15px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:background-color .2s, transform .1s;flex-grow:1;border:none}
    .life-btn{background:var(--accent);color:var(--text)}
    .life-btn:hover{background:var(--accent-strong);transform:translateY(-1px)}
    .life-btn:active{transform:translateY(0)}

    .utility-btns{display:flex;gap:10px;width:100%;justify-content:center;margin-top:10px}
    .utility-btn{background:var(--input-bg);color:var(--muted);padding:8px 12px;border-radius:8px;font-size:.8rem;cursor:pointer;transition:background-color .2s}
    .utility-btn:hover{background:var(--dark-border);color:var(--text)}

    /* Utility Bar */
    .utility-bar{width:100%;max-width:1100px;margin-bottom:20px;display:flex;gap:10px;justify-content:flex-start}
    .room-info{font-size:.9rem;color:var(--muted);padding:8px 12px;background:var(--card);border-radius:8px;display:flex;align-items:center}
    .room-id-display{font-weight:700;color:var(--accent);margin-left:5px;cursor:copy;}

    /* Modal Styling */
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:var(--card);padding:25px;border-radius:12px;width:90%;max-width:450px;box-shadow:0 15px 30px rgba(0,0,0,.5);display:flex;flex-direction:column;gap:15px}
    .modal-input{padding:12px;border-radius:8px;border:1px solid var(--dark-border);background:var(--input-bg);color:var(--text);width:100%;box-sizing:border-box}
    .modal-btn{background:var(--green);color:var(--text);padding:12px 20px;border-radius:8px;cursor:pointer;text-align:center;font-weight:600;border:none}
    .modal-btn.cancel{background:var(--red)}
    .modal-btn:hover{opacity:.9}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end}

    /* Home Page */
    #home-page{display:flex;flex-direction:column;align-items:center;gap:20px;padding-top:50px}
    .home-action-btn{background:var(--accent);color:var(--text);padding:15px 30px;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;transition:background .2s}
    .home-action-btn:hover{background:var(--accent-strong)}

    /* Responsive adjustments */
    @media (max-width: 600px) {
      body{padding:10px}
      .app-title{font-size:1.5rem}
      #game-container{grid-template-columns:1fr;gap:15px}
      .life-display{font-size:4rem}
      .control-btn{padding:8px 10px;font-size:.9rem}
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <h1 class="app-title">MTG Life Tracker</h1>
      <p class="app-subtitle">Commander Edition</p>
    </div>
    <div class="utility-bar">
      <button id="create-room-btn" class="utility-btn">Create New Room</button>
      <button id="join-room-btn" class="utility-btn">Join Room</button>
      <button id="card-search-btn" class="utility-btn">Card Search</button>
      <div id="room-info" class="room-info hidden">
        Room ID: <span id="room-id-display" class="room-id-display" title="Click to copy"></span>
        <button id="leave-room-btn" class="utility-btn ml-2">Leave</button>
      </div>
    </div>
  </header>

  <main id="app-content">
    <div id="game-view" class="hidden">
      <div id="game-container">
        <!-- Player Cards will be rendered here -->
      </div>
    </div>

    <div id="home-view">
      <div id="home-page" class="text-center">
        <h2 class="text-xl font-semibold mb-4">Welcome to the Commander Life Tracker!</h2>
        <p class="mb-6 max-w-md text-sm text-center text-gray-400">
          Create a new room to start a game, or join an existing one. Once in a room, you can set your Commander to display its beautiful art.
        </p>
        <button id="home-create-btn" class="home-action-btn">Create a New Game</button>
        <button id="home-join-btn" class="home-action-btn mt-4">Join an Existing Game</button>
      </div>
    </div>
  </main>

  <p id="status-message" class="text-red-400 text-sm mt-4"></p>

  <!-- Modals -->

  <!-- Password Prompt Modal -->
  <div id="password-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 class="text-xl font-bold" id="password-modal-title">Enter Room Password</h3>
      <input type="password" id="password-input" class="modal-input" placeholder="Password (leave blank for none)">
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="hideModal('password-modal')">Cancel</button>
        <button class="modal-btn" id="password-action-btn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Join Room Modal -->
  <div id="join-room-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 class="text-xl font-bold">Join Room</h3>
      <input type="text" id="join-room-id-input" class="modal-input" placeholder="Enter Room ID">
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="hideModal('join-room-modal')">Cancel</button>
        <button class="modal-btn" id="join-room-action-btn">Join</button>
      </div>
    </div>
  </div>

  <!-- Card Search Modal -->
  <div id="card-search-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:550px;">
      <h3 class="text-xl font-bold" id="search-modal-title">MTG Card Search</h3>
      <input type="text" id="card-name-input" class="modal-input" placeholder="Enter Card Name">
      <div id="search-results-div" class="max-h-64 overflow-y-auto p-2 bg-black/30 rounded-lg">
        <p style="color:var(--muted)">Start typing a card name to search.</p>
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="hideModal('card-search-modal')">Close</button>
        <button class="modal-btn" id="card-search-action-btn" style="background:var(--accent)">Search</button>
      </div>
    </div>
  </div>

  <!-- Message/Alert Modal -->
  <div id="message-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 class="text-xl font-bold" id="message-title">Alert</h3>
      <p id="message-body">This is a message.</p>
      <div class="modal-actions">
        <button class="modal-btn" onclick="hideModal('message-modal')" style="background:var(--accent)">OK</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, runTransaction, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('error'); // Set to 'debug' for detailed logging

    // Global Variables (Mandatory Canvas Environment Variables)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase Setup
    let app, db, auth;
    let userId = null;
    let currentRoomId = null;
    let currentRoomRef = null;
    let unsubscribeSnapshot = null;
    let commanderSetTargetPlayerId = null; // New state to track which player's commander is being set

    if (Object.keys(firebaseConfig).length > 0) {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
    } else {
      console.error("Firebase configuration is missing.");
    }

    // Utility Functions
    function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function hideModal(id) { document.getElementById(id).classList.add('hidden'); }
    function showMessage(title, body) {
      document.getElementById('message-title').textContent = title;
      document.getElementById('message-body').textContent = body;
      showModal('message-modal');
    }

    function setActiveView(viewId) {
      document.getElementById('game-view').classList.add('hidden');
      document.getElementById('home-view').classList.add('hidden');
      document.getElementById('room-info').classList.add('hidden');
      if (viewId === 'game-view') {
        document.getElementById('game-view').classList.remove('hidden');
        document.getElementById('room-info').classList.remove('hidden');
      } else {
        document.getElementById('home-view').classList.remove('hidden');
      }
    }

    // ----------------------------------------------------------------------
    // FIREBASE / ROOM LOGIC
    // ----------------------------------------------------------------------

    const privateDataPath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}`;
    const publicDataPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;
    const roomsCollectionRef = collection(db, publicDataPath('rooms'));

    function generateRoomId() {
      return Math.random().toString(36).substring(2, 6).toUpperCase();
    }

    // Helper to get a random color for a new player
    function getRandomColor() {
      const colors = ['#f39c12', '#9b59b6', '#3498db', '#e74c3c', '#1abc9c', '#f1c40f', '#e67e22', '#2ecc71'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    async function createNewRoom(password = '') {
      const newRoomId = generateRoomId();
      const roomRef = doc(roomsCollectionRef, newRoomId);

      const initialPlayer = {
        id: userId,
        life: 40,
        poison: 0,
        color: getRandomColor(),
        isHost: true,
        commanderName: null, // New field
        commanderImageUri: null, // New field
        commanderArtist: null, // New field
      };

      const roomData = {
        id: newRoomId,
        password: password,
        hostId: userId,
        players: [initialPlayer],
        createdAt: Date.now()
      };

      try {
        await setDoc(roomRef, roomData);
        listenToRoom(newRoomId);
      } catch (e) {
        showMessage('Error', `Could not create room: ${e.message}`);
        console.error("Error creating room: ", e);
      }
    }

    async function joinRoom(roomId, password = '') {
      const roomRef = doc(roomsCollectionRef, roomId);
      try {
        const docSnap = await getDoc(roomRef);

        if (!docSnap.exists()) {
          showMessage('Error', `Room ID "${roomId}" not found.`);
          return;
        }

        const roomData = docSnap.data();

        if (roomData.password && roomData.password !== password) {
          showMessage('Access Denied', 'Incorrect password for this room.');
          return;
        }

        const playerExists = roomData.players.some(p => p.id === userId);

        await runTransaction(db, async (transaction) => {
          const freshRoomSnap = await transaction.get(roomRef);
          if (!freshRoomSnap.exists) throw "Room does not exist (during transaction)";
          const freshRoomData = freshRoomSnap.data();

          if (!playerExists) {
            const newPlayer = {
              id: userId,
              life: 40,
              poison: 0,
              color: getRandomColor(),
              isHost: false,
              commanderName: null, // New field
              commanderImageUri: null, // New field
              commanderArtist: null, // New field
            };
            freshRoomData.players.push(newPlayer);
          }
          // Max 8 players
          if (freshRoomData.players.length > 8) {
             throw new Error("Room is full (max 8 players).");
          }

          transaction.set(roomRef, freshRoomData);
        });

        listenToRoom(roomId);

      } catch (e) {
        showMessage('Error', `Failed to join room: ${e.message}`);
        console.error("Error joining room: ", e);
      }
    }

    function listenToRoom(roomId) {
      if (unsubscribeSnapshot) unsubscribeSnapshot();

      currentRoomId = roomId;
      currentRoomRef = doc(roomsCollectionRef, roomId);
      localStorage.setItem('currentRoomId', roomId);
      document.getElementById('room-id-display').textContent = roomId;
      setActiveView('game-view');

      unsubscribeSnapshot = onSnapshot(currentRoomRef, (doc) => {
        if (doc.exists()) {
          renderGameUI(doc.data());
        } else {
          // Room deleted
          showMessage('Room Closed', 'The host has closed this room.');
          leaveRoom(false);
        }
      }, (error) => {
        showMessage('Error', 'Failed to listen to room updates.');
        console.error("Snapshot error: ", error);
        leaveRoom(false);
      });
    }

    async function leaveRoom(removePlayer = true) {
      if (!currentRoomId || !currentRoomRef) return;

      if (unsubscribeSnapshot) unsubscribeSnapshot();
      unsubscribeSnapshot = null;

      localStorage.removeItem('currentRoomId');
      setActiveView('home-view');
      const roomRef = currentRoomRef;
      currentRoomId = null;
      currentRoomRef = null;
      
      try {
        await runTransaction(db, async (transaction) => {
          const roomSnap = await transaction.get(roomRef);
          if (!roomSnap.exists) return; // Already deleted

          let roomData = roomSnap.data();
          let players = roomData.players;

          // If the player is the host, delete the room
          if (roomData.hostId === userId) {
            transaction.delete(roomRef);
            return;
          }

          // Otherwise, just remove the player if requested
          if (removePlayer) {
            roomData.players = players.filter(p => p.id !== userId);
            transaction.set(roomRef, roomData);
          }
        });
      } catch (e) {
        console.error("Error leaving or deleting room: ", e);
      }
    }

    // Update function (for life, poison, etc., and now Commander data)
    async function updateRoomData(updates) {
      if (!currentRoomRef) return;

      try {
        await runTransaction(db, async (transaction) => {
          const roomSnap = await transaction.get(currentRoomRef);
          if (!roomSnap.exists) throw new Error("Room does not exist.");

          let roomData = roomSnap.data();
          const playerIndex = roomData.players.findIndex(p => p.id === userId);

          if (playerIndex === -1) throw new Error("Player not found in room data.");

          // Apply updates
          Object.assign(roomData.players[playerIndex], updates);

          // Update the room document
          transaction.set(currentRoomRef, roomData);
        });
      } catch (e) {
        showMessage('Update Failed', `Could not update life/status: ${e.message}`);
        console.error("Transaction failed: ", e);
      }
    }

    // ----------------------------------------------------------------------
    // UI RENDERING
    // ----------------------------------------------------------------------

    function renderGameUI(roomData) {
      const container = document.getElementById('game-container');
      container.innerHTML = '';
      
      const isHost = roomData.hostId === userId;
      
      roomData.players.forEach(player => {
        const isCurrentPlayer = player.id === userId;
        const lifeColor = player.life <= 10 ? 'danger' : 'safe';
        
        // Use commanderImageUri for background, falling back to player color
        const cardStyle = player.commanderImageUri 
            ? `background-color: transparent;` 
            : `background-color: ${player.color};`;
        
        const commanderImageStyle = player.commanderImageUri
            ? `background-image: url('${player.commanderImageUri}');`
            : `opacity: 0;`;

        container.innerHTML += `
          <div class="player-card" style="${cardStyle}">
            <div class="commander-image-container" style="${commanderImageStyle}"></div>
            <div class="player-content">
              
              <!-- Top Info -->
              <div class="card-info">
                <span class="player-id" title="${player.id}">ID: ${player.id}</span>
                ${player.isHost ? '<span class="host-badge">Host</span>' : ''}
              </div>

              <!-- Commander Display -->
              <div class="w-full text-center mb-4">
                <p class="text-sm font-semibold truncate" title="${player.commanderName || 'No Commander Set'}">
                  Commander: ${player.commanderName || 'N/A'}
                </p>
                ${isCurrentPlayer ? `
                  <button onclick="openCommanderSearch('${player.id}')" class="utility-btn mt-1 text-xs">
                    ${player.commanderName ? 'Change Commander' : 'Set Commander'}
                  </button>
                ` : ''}
              </div>

              <!-- Life Total -->
              <div class="life-display ${lifeColor}">${player.life}</div>

              <!-- Status Trackers -->
              <div class="status-trackers">
                <div class="status-tracker">
                  Poison: <span class="status-value" style="color:#d35400">${player.poison}</span>
                  ${isCurrentPlayer ? `
                    <button onclick="adjustStatus('${player.id}', 'poison', 1)" class="ml-1 text-lg leading-none">+</button>
                    <button onclick="adjustStatus('${player.id}', 'poison', -1)" class="text-lg leading-none">-</button>
                  ` : ''}
                </div>
              </div>

              <!-- Life Adjust Controls -->
              <div class="control-group">
                ${isCurrentPlayer ? `
                  <button class="control-btn life-btn" onclick="adjustLife('${player.id}', -5)">-5</button>
                  <button class="control-btn life-btn" onclick="adjustLife('${player.id}', -1)">-1</button>
                  <button class="control-btn life-btn" onclick="adjustLife('${player.id}', 1)">+1</button>
                  <button class="control-btn life-btn" onclick="adjustLife('${player.id}', 5)">+5</button>
                ` : `<span class="text-xs text-muted">Awaiting Player Actions...</span>`}
              </div>
              
              <!-- Copyright Info -->
              ${player.commanderImageUri ? `
              <div class="commander-info">
                Art by ${player.commanderArtist || 'Unknown'} | Images provided by Scryfall | ${player.commanderCopyright || 'Â© Wizards of the Coast'}
              </div>` : ''}
            </div>
          </div>
        `;
      });
    }

    // ----------------------------------------------------------------------
    // GAME ACTIONS
    // ----------------------------------------------------------------------

    window.adjustLife = (targetPlayerId, delta) => {
      if (targetPlayerId !== userId) return;
      // This is a transaction, so we fetch the current state first
      getDoc(currentRoomRef).then(docSnap => {
        if (docSnap.exists()) {
          const roomData = docSnap.data();
          const player = roomData.players.find(p => p.id === targetPlayerId);
          if (player) {
            updateRoomData({ life: Math.max(0, player.life + delta) });
          }
        }
      });
    }

    window.adjustStatus = (targetPlayerId, status, delta) => {
      if (targetPlayerId !== userId) return;
      getDoc(currentRoomRef).then(docSnap => {
        if (docSnap.exists()) {
          const roomData = docSnap.data();
          const player = roomData.players.find(p => p.id === targetPlayerId);
          if (player) {
            const newStatusValue = Math.max(0, player[status] + delta);
            updateRoomData({ [status]: newStatusValue });
          }
        }
      });
    }

    // ----------------------------------------------------------------------
    // COMMANDER & CARD SEARCH LOGIC
    // ----------------------------------------------------------------------

    window.openCommanderSearch = (playerId) => {
      commanderSetTargetPlayerId = playerId;
      document.getElementById('card-name-input').value = '';
      document.getElementById('search-results-div').innerHTML = '<p style="color:var(--muted)">Search for your Commander by name.</p>';
      document.getElementById('search-modal-title').textContent = 'Set Commander for Player ' + playerId;
      showModal('card-search-modal');
    }

    // Generic function for card search or setting commander
    async function handleCardSearch(isCommanderSet = false) {
      const cardName = document.getElementById('card-name-input').value.trim();
      const resultsDiv = document.getElementById('search-results-div');
      
      if (!cardName) {
        resultsDiv.innerHTML = '<p style="color:var(--muted)">Please enter a card name.</p>';
        return;
      }
      
      resultsDiv.innerHTML = '<p style="color:var(--muted)">Searching Scryfall...</p>';

      try {
        // Use 'exact' search for commander setting for reliability, or 'fuzzy' for general search
        const searchType = isCommanderSet ? 'exact' : 'fuzzy';
        const scryfallUrl = `https://api.scryfall.com/cards/${searchType}?${searchType}=${encodeURIComponent(cardName)}`;
        
        // Add exponential backoff for Scryfall API calls
        const fetchWithBackoff = async (url, retries = 3, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                const response = await fetch(url);
                if (response.status !== 429) return response; // Not a rate limit error
                if (i < retries - 1) await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
            }
            throw new Error('Rate limit exceeded or failed after retries.');
        };

        const response = await fetchWithBackoff(scryfallUrl);
        
        if (!response.ok) {
          // Scryfall returns 404 for card not found
          if (response.status === 404) {
            resultsDiv.innerHTML = `<p style="color:var(--text)">Card not found. Check spelling or try a partial search (e.g., "Atraxa").</p>`;
          } else {
            throw new Error(`Scryfall API returned status ${response.status}`);
          }
          return;
        }

        const card = await response.json();
        
        // For Commander setting, we need specific fields
        if (isCommanderSet) {
          const imageUri = card.image_uris?.art_crop || card.image_uris?.normal;
          const artist = card.artist || 'Unknown Artist';
          const copyright = '(C) Wizards of the Coast'; // Standard WOTC Copyright

          if (imageUri) {
            await updateRoomData({
              commanderName: card.name,
              commanderImageUri: imageUri,
              commanderArtist: artist,
              commanderCopyright: copyright,
            });
            showMessage('Commander Set', `${card.name} is now your commander!`);
            hideModal('card-search-modal');
          } else {
            resultsDiv.innerHTML = `<p style="color:var(--text)">Found card, but could not get the image for Commander art.</p>`;
          }
          
        } else {
          // General Card Search Results
          const imageUri = card.image_uris?.normal || card.image_uris?.art_crop;

          resultsDiv.innerHTML = `
            <div class="bg-black/40 p-4 rounded-lg flex gap-4">
              ${imageUri ? `<img src="${imageUri}" onerror="this.src='https://placehold.co/150x200/222/FFF?text=Image+Error'" class="w-24 h-auto rounded-lg shadow-xl" alt="${card.name}">` : ''}
              <div>
                <h4 class="font-bold text-lg">${card.name}</h4>
                <p class="text-sm text-gray-300">Artist: ${card.artist || 'N/A'}</p>
                <p class="text-xs text-gray-400">Set: ${card.set_name} | Rarity: ${card.rarity}</p>
                <p class="text-xs text-gray-400 mt-2">
                    <a href="${card.scryfall_uri}" target="_blank" class="text-blue-400 hover:text-blue-300">View on Scryfall</a>
                </p>
              </div>
            </div>
          `;
        }

      } catch (e) {
        resultsDiv.innerHTML = `<p style="color:var(--red)">Error: ${e.message}</p>`;
        console.error("Scryfall Error: ", e);
      }
    }

    // ----------------------------------------------------------------------
    // EVENT LISTENERS
    // ----------------------------------------------------------------------
    
    // Global function used in modal
    window.promptPassword = (roomId, action) => {
      document.getElementById('password-modal-title').textContent = 
        action === 'create' ? 'Set Room Password (Optional)' : `Join Room ${roomId}`;
      document.getElementById('password-action-btn').onclick = () => {
        const password = document.getElementById('password-input').value;
        hideModal('password-modal');
        if (action === 'create') createNewRoom(password);
        else joinRoom(roomId, password);
      };
      showModal('password-modal');
    }

    document.getElementById('create-room-btn').addEventListener('click', () => promptPassword(null, 'create'));
    document.getElementById('home-create-btn').addEventListener('click', () => promptPassword(null, 'create'));
    document.getElementById('join-room-btn').addEventListener('click', () => showModal('join-room-modal'));
    document.getElementById('home-join-btn').addEventListener('click', () => showModal('join-room-modal'));
    document.getElementById('leave-room-btn').addEventListener('click', leaveRoom);

    document.getElementById('join-room-action-btn').addEventListener('click', () => {
      const roomId = document.getElementById('join-room-id-input').value.trim().toUpperCase();
      if (roomId) promptPassword(roomId, 'join');
    });

    // Toggle between general search and commander set action
    document.getElementById('card-search-btn').addEventListener('click', () => {
      commanderSetTargetPlayerId = null; // Clear target for general search
      document.getElementById('search-modal-title').textContent = 'MTG Card Search';
      document.getElementById('card-name-input').value = '';
      document.getElementById('search-results-div').innerHTML = '<p style="color:var(--muted)">Start typing a card name to search.</p>';
      showModal('card-search-modal');
    });

    document.getElementById('card-search-action-btn').addEventListener('click', () => {
      const isCommanderSet = commanderSetTargetPlayerId !== null;
      handleCardSearch(isCommanderSet);
    });

    document.getElementById('room-id-display').addEventListener('click', (e) => {
      const text = e.target.textContent;
      if (navigator.clipboard) {
          navigator.clipboard.writeText(currentRoomId).then(() => {
              const originalText = e.target.textContent;
              e.target.textContent = 'Copied!';
              setTimeout(() => {
                  e.target.textContent = originalText;
              }, 1000);
          }).catch(err => console.error('Could not copy text: ', err));
      } else {
          // Fallback for clipboard if not available (execCommand is deprecated but safer in iframes)
          const tempInput = document.createElement('input');
          tempInput.value = currentRoomId;
          document.body.appendChild(tempInput);
          tempInput.select();
          document.execCommand('copy');
          document.body.removeChild(tempInput);
          showMessage('Copied', `Room ID ${currentRoomId} copied to clipboard (fallback).`);
      }
    });

    // ----------------------------------------------------------------------
    // INIT: auth + initial route + persist join on refresh
    // ----------------------------------------------------------------------
    function initialRoute(){
      const params = new URLSearchParams(window.location.search);
      const idFromURL = params.get('roomID');
      const persistedRoom = localStorage.getItem('currentRoomId');

      if(idFromURL){ promptPassword(idFromURL,'join'); return; }

      if(persistedRoom){ listenToRoom(persistedRoom); return; }

      setActiveView('home-view');
    }

    onAuthStateChanged(auth, user=>{
      if(user){ userId = user.uid; initialRoute(); }
      else{ signInAnonymously(auth).catch(e=>{ document.getElementById("status-message").textContent = "Auth Error: " + e.message; }); }
    });
  </script>
</body>
</html>
