<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MTG Life Tracker</title>
<style>
:root{
  --bg:#0f1113;--card:#16181a;--muted:#9aa3ad;--text:#e6eef6;
  --accent:#2980b9;--accent-strong:#1f6fa8;--green:#27ae60;--red:#c0392b;
  --dark-border:#22272a;--input-bg:#1f2326;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:"Segoe UI",Tahoma, Geneva, Verdana, sans-serif;
  background:var(--bg);color:var(--text);display:flex;flex-direction:column;
  align-items:center;padding:20px;min-height:100vh;
}
header.app-header{width:100%;max-width:1100px;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
.brand{display:flex;flex-direction:column;gap:2px}
.app-title{margin:0;font-size:1.25rem}
.app-subtitle{margin:0;font-size:.8rem;color:var(--muted);font-style:italic}
nav.site-nav{display:flex;gap:8px}
nav.site-nav button{background:transparent;color:var(--text);border:1px solid transparent;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
nav.site-nav button.active{background:rgba(41,128,185,0.10);border-color:var(--accent)}
#app-container{width:100%;max-width:1100px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);position:relative}
input,textarea,select,button{font:inherit}
input,textarea,select{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid var(--dark-border);background:var(--input-bg);color:var(--text)}
textarea{min-height:120px;resize:vertical}
button{cursor:pointer;border-radius:8px;padding:10px 12px;border:none;font-weight:700;transition:transform .08s ease,opacity .12s}
button:active{transform:scale(.96)}
.btn-primary{background:linear-gradient(180deg,var(--green),#1f8a4a);color:#fff}
.btn-danger{background:linear-gradient(180deg,var(--red),#9b2b24);color:#fff}
.btn-secondary{background:linear-gradient(180deg,#3a3a3a,#2f2f2f);color:#fff}
button:disabled,input:disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.2)}
.player-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:12px}
@media(max-width:900px){.player-grid{grid-template-columns:1fr}}
.player-panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0));border:1px solid var(--dark-border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
.player-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
.player-name{font-weight:800;font-size:1rem}
.player-sub{font-size:.85rem;color:var(--muted)}
.life-big{font-size:3.2rem;font-weight:900}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.control-btn{padding:8px 12px;border-radius:8px;font-weight:800;min-width:56px;text-align:center;background:linear-gradient(180deg,#2b2b2b,#232323);color:var(--text);border:1px solid rgba(255,255,255,0.03)}
.control-btn.positive{background:linear-gradient(180deg,#2ecc71,#27ae60);color:#04260a}
.control-btn.negative{background:linear-gradient(180deg,#ff6b6b,#c0392b);color:#2b0706}
.cmd-block{display:flex;justify-content:space-between;align-items:center;gap:8px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.cmd-label{font-size:.9rem;color:var(--muted)}
.you-badge{background:linear-gradient(90deg,var(--accent),var(--accent-strong));color:#fff;padding:6px 8px;border-radius:999px;font-weight:800;font-size:.8rem}
.per-opp-container{margin-top:10px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto;border-top:1px solid rgba(255,255,255,0.02);padding-top:8px}
.per-opp-row{height:44px;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
.outgoing-cmd-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.infect-block{margin-top:8px;display:flex;align-items:center;gap:8px}
.small-btn{padding:6px 8px;font-size:.85rem;min-width:36px;border-radius:6px}
#chat-log{height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,0.03);padding:10px;margin-bottom:10px;border-radius:8px;background:#0f1113;font-size:.95em}
.chat-message{margin-bottom:6px;display:flex;gap:8px;align-items:center}
.chat-sender{font-weight:800;color:#74b9ff;margin-right:6px}
.chat-sender.system{color:#ffd166}
.chat-card{display:inline-block;position:relative;cursor:pointer;color:var(--text);text-decoration:underline dotted rgba(255,255,255,0.08)}
#chat-card-preview,#lobby-card-preview{position:fixed;top:50%;transform:translateY(-50%);border:3px solid var(--accent);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.7);background:#0b0d0f;z-index:1500;display:none;padding:8px}
#chat-card-preview{right:20px;width:300px;max-width:40vw}
#lobby-card-preview{left:20px;width:260px}
#chat-card-preview img,#lobby-card-preview img{display:block;width:100%;border-radius:6px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:2000}
.modal-content{background:#16181a;color:var(--text);padding:20px;border-radius:10px;width:92%;max-width:520px;box-shadow:0 12px 40px rgba(0,0,0,.7);position:relative}
.suggestions-list{position:absolute;width:100%;background:var(--input-bg);border:1px solid var(--dark-border);border-top:none;max-height:150px;overflow-y:auto;z-index:100;border-radius:0 0 8px 8px;box-shadow:0 6px 18px rgba(0,0,0,.6);margin-top:-10px}
.suggestion-item{padding:8px 12px;cursor:pointer;color:var(--text)}
.suggestion-item:hover{background:rgba(41,128,185,.08)}
#room-footer{margin-top:14px;color:var(--muted);font-size:.9rem;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.muted{color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}
@media(max-width:720px){header.app-header{flex-direction:column;align-items:flex-start;gap:8px}#lobby-card-preview,#chat-card-preview{display:none!important}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body>
<header class="app-header" role="banner">
  <div class="brand">
    <h1 class="app-title">Cardboard Bonfire</h1>
    <div class="app-subtitle">Life tracker for keeping life and bringing people together.</div>
  </div>
  <nav class="site-nav" role="navigation" aria-label="Main">
    <button id="nav-home">Home</button>
    <button id="nav-changes">Changes</button>
    <button id="nav-contact">Contact</button>
  </nav>
</header>

<main id="app-container" role="main"></main>

<div id="lobby-card-preview" aria-hidden="true"><img id="preview-img" alt="Commander Preview"></div>
<div id="chat-card-preview" aria-hidden="true"><img id="chat-preview-img" alt="Card Preview"><div class="card-title" id="chat-preview-title"></div></div>
<p id="status-message" class="muted">Initializing...</p>

<!-- Card search modal -->
<div id="card-search-modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3 style="margin-top:0">Card Search (Scryfall)</h3>
    <input id="modal-card-name" placeholder="Enter card name" autocomplete="off">
    <div id="modal-suggestions-list" class="suggestions-list"></div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="modal-search-btn" class="btn-primary">Search & Post</button>
      <button id="modal-close-btn" class="btn-secondary">Close</button>
    </div>
    <div id="search-results" style="margin-top:12px"></div>
  </div>
</div>

<!-- Edit commander modal -->
<div id="edit-commander-modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3 style="margin-top:0">Edit Commander</h3>
    <input id="edit-commander-name" placeholder="Commander name">
    <div id="edit-commander-suggestions" class="suggestions-list"></div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="edit-commander-save" class="btn-primary">Save</button>
      <button id="edit-commander-cancel" class="btn-secondary">Cancel</button>
    </div>
    <div id="edit-commander-result" style="margin-top:12px"></div>
  </div>
</div>

<script type="module">
/* ---------------- CONFIG ---------------- */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E",
  authDomain: "mtg-life-tool.firebaseapp.com",
  projectId: "mtg-life-tool",
  storageBucket: "mtg-life-tool.appspot.com",
  messagingSenderId: "36730058988",
  appId: "1:36730058988:web:757e2d9620593b4f65022a"
};
const TIMEOUT_MINUTES = 20;
const SCRYFALL_API = "https://api.scryfall.com/cards/named?exact=";
const SCRYFALL_AUTOCOMPLETE = "https://api.scryfall.com/cards/autocomplete?q=";
const ROOM_COLLECTION = "mtg_rooms";
const AUTOCOMPLETE_DEBOUNCE_MS = 100;

/* ---------------- IMPORTS & INIT ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp,
  arrayUnion, deleteDoc, collection, getDocs, query, limit, updateDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------- STATE ---------------- */
let userId = null, roomId = null, unsubscribeRoom = null;
const openCmdControls = new Set();
let autocompleteTimer = null;

/* ---------------- HELPERS ---------------- */
const hash = s => CryptoJS.SHA256(s||"").toString(CryptoJS.enc.Hex);
const startLife = () => 40;
const el = id => document.getElementById(id);
const now = () => Date.now();

async function scryValidate(name){
  if(!name) return null;
  try{
    const r = await fetch(`${SCRYFALL_API}${encodeURIComponent(name)}`);
    const d = await r.json();
    if(r.ok){
      const img = d.image_uris?.normal || d.card_faces?.[0]?.image_uris?.normal;
      return img ? { name: d.name, imageUrl: img } : null;
    }
  }catch(e){ console.error(e); }
  return null;
}

async function scryAutocomplete(q, listElId, inputId){
  const list = el(listElId), input = el(inputId);
  if(!list || !input) return;
  list.innerHTML = "";
  if((q||"").length < 2) return;
  try{
    const r = await fetch(`${SCRYFALL_AUTOCOMPLETE}${encodeURIComponent(q)}`);
    const d = await r.json();
    if(r.ok && d.data?.length){
      d.data.slice(0,5).forEach(s=>{
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.textContent = s;
        item.onclick = ()=>{ input.value = s; list.innerHTML = ''; };
        list.appendChild(item);
      });
    }
  }catch(e){ console.error(e); }
}

function computeOutgoing(room, src){
  const players = room.players || {};
  const order = Array.isArray(room.playersOrder) && room.playersOrder.length ? room.playersOrder : Object.keys(players||{});
  return order.filter(id=>id!==src).map(pid=>({ oppId: pid, oppName: players[pid]?.name||'Player', dmg: (players[src]?.commanderDamage||{})[pid]||0 }));
}
function sumOutgoing(room, src){ const map = room.players?.[src]?.commanderDamage||{}; return Object.keys(map).reduce((s,k)=>s+(parseInt(map[k])||0),0); }
function sumIncoming(room, tgt){ let t=0; Object.keys(room.players||{}).forEach(pid=>{ t += (room.players[pid]?.commanderDamage||{})[tgt]||0; }); return t; }

function formatTimeLeft(minutesLeft){
  if(minutesLeft <= 0) return 'closing soon';
  if(minutesLeft < 60) return `${Math.ceil(minutesLeft)}m left`;
  const hrs = Math.floor(minutesLeft/60), mins = Math.ceil(minutesLeft%60);
  return `${hrs}h ${mins}m left`;
}

/* ---------------- NAV & PAGES ---------------- */
const nav = { home: el('nav-home'), changes: el('nav-changes'), contact: el('nav-contact') };
Object.entries(nav).forEach(([k,btn])=>btn.addEventListener('click', ()=> navigate(k)));
function setActive(page){ Object.values(nav).forEach(b=>b.classList.remove('active')); if(nav[page]) nav[page].classList.add('active'); }
function navigate(page){
  if(location.hash !== `#${page}`) history.pushState(null,'',`#${page}`);
  setActive(page);
  if(page==='home') renderSetup();
  else if(page==='changes') renderChanges();
  else renderContact();
}
window.addEventListener('popstate', ()=>{ const p = (location.hash||'#home').replace('#','')||'home'; setActive(p); if(p==='home') renderSetup(); else if(p==='changes') renderChanges(); else renderContact(); });

const CHANGELOG = [
  {v:"0.9.8",d:"2025-12-08",n:"Show CMD labels, persist lobby on refresh, 20-minute timeout based on life changes, lobby timestamps."},
  {v:"0.9.7",d:"2025-12-07",n:"Show CMD DMG to/from on each panel; incoming editor updates opponent's outgoing."}
];

function renderChanges(){
  const c = el('app-container');
  c.innerHTML = `<h2 style="margin-top:0">Changes</h2><div style="display:flex;flex-direction:column;gap:12px">${CHANGELOG.map(e=>`<div style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border)"><div style="display:flex;justify-content:space-between"><div style="font-weight:700">${e.v}</div><div class="muted">${e.d}</div></div><div style="margin-top:8px">${e.n}</div></div>`).join('')}</div>`;
}

function renderContact(){
  const c = el('app-container');
  c.innerHTML = `
    <h2 style="margin-top:0">Contact</h2>
    <p class="muted">To contact me, please use your email client. Click the button below to open a new message addressed to <strong>CardboardBonfire@gmail.com</strong>.</p>
    <div style="max-width:640px">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="contact-mailto" class="btn-primary">Email CardboardBonfire@gmail.com</button>
        <button id="contact-copy" class="btn-secondary">Copy Email</button>
      </div>
      <p id="contact-status" class="muted" style="margin-top:8px"></p>
    </div>`;
  el('contact-mailto').addEventListener('click', ()=>{ const s=encodeURIComponent("Contact from MTG Life Tracker"); const b=encodeURIComponent("Hi,\n\nI'd like to get in touch regarding..."); window.location.href = `mailto:CardboardBonfire@gmail.com?subject=${s}&body=${b}`; });
  el('contact-copy').addEventListener('click', async ()=>{ const st = el('contact-status'); try{ await navigator.clipboard.writeText('CardboardBonfire@gmail.com'); st.textContent='Email address copied to clipboard.'; }catch(e){ st.textContent='Unable to copy automatically — please copy: CardboardBonfire@gmail.com'; } });
}

/* ---------------- SETUP (rooms list + create) ---------------- */
async function renderSetup(){
  roomId = null;
  el('lobby-card-preview').style.display = 'none';
  el('card-search-modal').style.display = 'none';
  el('status-message').textContent = "Browse rooms or create a new one.";
  el('status-message').style.color = "#9aa3ad";

  const container = el('app-container');
  container.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <div style="flex:1"><input type="text" id="search-input" placeholder="Enter Room ID to Create/Search"></div>
      <div style="width:160px"><button id="search-btn" class="btn-primary" style="width:100%">Find or Create Room</button></div>
    </div>
    <h3 style="color:var(--text);margin-top:0">Active Rooms</h3>
    <div id="room-list-container"><p style="color:var(--text)">Loading active rooms...</p></div>
    <div style="margin-top:12px"><button id="delete-all-rooms-btn" class="btn-danger">Delete All Rooms (Admin)</button></div>
  `;

  // load rooms
  try{
    const q = query(collection(db, ROOM_COLLECTION), limit(30));
    const snap = await getDocs(q);
    const list = el('room-list-container');
    if(snap.empty) list.innerHTML = '<p style="color:var(--text)">No active rooms. Create one above!</p>';
    else{
      list.innerHTML = '';
      snap.forEach(docSnap=>{
        const r = docSnap.data(), id = docSnap.id;
        const pCount = Object.keys(r.players||{}).length;
        const owner = r.players?.[r.ownerId] || {};
        const ownerCmd = owner.commanderName || owner.commander || 'N/A';
        let createdAt = null;
        if(r.createdAt){ if(typeof r.createdAt.toDate==='function') createdAt = r.createdAt.toDate(); else createdAt = new Date(r.createdAt); }
        let baseline = r.lastLifeChange ? (typeof r.lastLifeChange.toDate==='function' ? r.lastLifeChange.toDate() : new Date(r.lastLifeChange)) : createdAt;
        let timeLeft = 'N/A';
        if(baseline){ const elapsed = (Date.now()-baseline.getTime())/(1000*60); timeLeft = formatTimeLeft(Math.max(0, TIMEOUT_MINUTES - elapsed)); }
        const item = document.createElement('div');
        item.className = 'room-item';
        item.style.cssText = "display:flex;justify-content:space-between;align-items:center;background-color:#121416;padding:12px;margin-bottom:8px;border-radius:8px;border:1px solid var(--dark-border)";
        item.innerHTML = `
          <div class="room-info" style="flex:1">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="font-weight:800;color:var(--text);min-width:160px">${id}</div>
              <div style="font-size:.9em;color:var(--muted)">${pCount} Player(s) • Owner: ${owner.name||'Owner'}</div>
            </div>
            <div style="font-size:.85em;color:var(--muted);margin-top:6px;display:flex;gap:12px;align-items:center">
              <div>Commander: <strong style="color:var(--text)">${ownerCmd}</strong></div>
              <div>Created: <strong style="color:var(--text)">${createdAt ? createdAt.toLocaleString() : 'N/A'}</strong></div>
              <div>Expires: <strong style="color:var(--text)">${timeLeft}</strong></div>
            </div>
          </div>
          <div style="margin-left:12px"><button class="join-btn btn-secondary" data-rid="${id}" style="width:auto">Join</button></div>
        `;
        list.appendChild(item);
      });
    }
  }catch(e){ console.error("List error:",e); el('room-list-container').innerHTML = `<p style="color:#ff5555">Error loading rooms. Permissions might be initializing...</p>`; }

  // handlers
  el('search-btn').onclick = async ()=>{
    const val = (el('search-input').value||'').trim().toLowerCase();
    if(!val) return;
    const snap = await getDoc(doc(db, ROOM_COLLECTION, val));
    if(snap.exists()) promptPassword(val,'join'); else promptPassword(val,'create');
  };
  el('delete-all-rooms-btn').addEventListener('click', deleteAllRooms);
  document.querySelectorAll('.join-btn').forEach(b=>b.addEventListener('click', e=> promptPassword(e.target.dataset.rid,'join')));
}

/* ---------------- ROOM VIEW & CHAT ---------------- */
function renderChat(log, playerName){
  const chat = el('chat-log');
  if(!chat) return;
  chat.innerHTML = '';
  (log||[]).slice(-500).forEach(msg=>{
    const d = document.createElement('div'); d.className='chat-message';
    const s = document.createElement('span'); s.className='chat-sender'; s.textContent = msg.senderName === 'System' ? 'System:' : `${msg.senderName}:`; if(msg.senderName==='System') s.classList.add('system');
    d.appendChild(s);
    if(msg.cardImageUrl){
      const card = document.createElement('span'); card.className='chat-card'; card.textContent = ` ${msg.message} `;
      card.dataset.cardImageUrl = msg.cardImageUrl; card.dataset.cardName = msg.message;
      card.addEventListener('mouseenter', ()=> showChatCardPreview(card.dataset.cardImageUrl, card.dataset.cardName));
      card.addEventListener('mouseleave', ()=> hideChatCardPreviewWithDelay());
      card.addEventListener('click', ()=> { const p = el('chat-card-preview'); p.style.display==='block' ? hideChatCardPreviewImmediate() : showChatCardPreview(card.dataset.cardImageUrl, card.dataset.cardName); });
      d.appendChild(card);
    } else d.appendChild(document.createTextNode(' ' + msg.message));
    chat.appendChild(d);
  });
  chat.scrollTop = chat.scrollHeight;
}

let chatPreviewTimer = null;
function showChatCardPreview(img, title){
  if(chatPreviewTimer){ clearTimeout(chatPreviewTimer); chatPreviewTimer = null; }
  const p = el('chat-card-preview'), i = el('chat-preview-img'), t = el('chat-preview-title');
  i.src = img; t.textContent = title; p.style.display = 'block';
}
function hideChatCardPreviewWithDelay(){ if(chatPreviewTimer) clearTimeout(chatPreviewTimer); chatPreviewTimer = setTimeout(hideChatCardPreviewImmediate, 300); }
function hideChatCardPreviewImmediate(){ const p = el('chat-card-preview'), i = el('chat-preview-img'), t = el('chat-preview-title'); p.style.display='none'; i.src=''; t.textContent=''; if(chatPreviewTimer){ clearTimeout(chatPreviewTimer); chatPreviewTimer=null; } }

function renderRoom(room){
  const c = el('app-container');
  if(!room) return renderSetup();
  const players = room.players || {};
  const order = Array.isArray(room.playersOrder) && room.playersOrder.length ? room.playersOrder : Object.keys(players||{});
  const meId = userId;
  const meName = players[meId]?.name || 'You';
  // header + players
  let html = `<div style="display:flex;justify-content:space-between;align-items:center;gap:12px"><div><h2 style="margin:0">${roomId}</h2><div class="muted">Owner: ${players[room.ownerId]?.name||'N/A'}</div></div><div id="room-actions" class="row"><button id="open-card-search" class="btn-secondary small-btn">Post Card</button><button id="leave-room" class="btn-secondary small-btn">Leave</button></div></div>`;
  html += `<div class="player-grid">`;
  order.forEach(pid=>{
    const p = players[pid] || {};
    const isMe = pid === meId;
    const life = p.life ?? startLife();
    const cmdName = p.commanderName || p.commander || '';
    const cmdImg = p.commanderImageUrl || '';
    const incoming = sumIncoming(room, pid);
    const outgoingTotal = sumOutgoing(room, pid);
    html += `
      <div class="player-panel" data-pid="${pid}">
        <div class="player-header">
          <div>
            <div class="player-name">${p.name||'Player'}</div>
            <div class="player-sub">${cmdName ? `Commander: ${cmdName}` : ''}</div>
          </div>
          <div style="text-align:right">
            ${isMe ? '<div class="you-badge">YOU</div>' : ''}
            <div class="player-sub muted">Incoming: <strong style="color:var(--text)">${incoming}</strong></div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="life-big">${life}</div>
          <div class="controls">
            <button class="control-btn positive" data-action="+5" data-pid="${pid}">+5</button>
            <button class="control-btn positive" data-action="+1" data-pid="${pid}">+1</button>
            <button class="control-btn negative" data-action="-1" data-pid="${pid}">-1</button>
            <button class="control-btn negative" data-action="-5" data-pid="${pid}">-5</button>
          </div>
        </div>
        <div class="cmd-block">
          <div class="cmd-label">CMD DMG to others</div>
          <div class="cmd-value">${outgoingTotal}</div>
        </div>
        <div class="per-opp-container">
          ${computeOutgoing(room, pid).map(o=>`<div class="per-opp-row"><div class="per-opp-left">${o.oppName}</div><div class="per-opp-controls"><div style="font-weight:800">${o.dmg}</div></div></div>`).join('')}
        </div>
      </div>`;
  });
  html += `</div>`; // player-grid

  // chat + footer
  html += `
    <div id="chat-container" style="margin-top:18px">
      <h3 style="margin-top:0">Chat</h3>
      <div id="chat-log"></div>
      <div id="chat-controls" style="display:flex;gap:8px;align-items:center">
        <input id="chat-input" placeholder="Say something..." style="flex:1">
        <button id="chat-send" class="btn-primary">Send</button>
      </div>
    </div>
    <div id="room-footer"> <div class="muted">Room active</div> <div class="muted">Expires after inactivity</div> </div>
  `;
  c.innerHTML = html;

  // attach preview hover for commanders
  document.querySelectorAll('.player-panel').forEach(panel=>{
    const pid = panel.dataset.pid;
    const img = players[pid]?.commanderImageUrl;
    const name = players[pid]?.commanderName || players[pid]?.commander || '';
    if(img){
      panel.querySelector('.player-sub').addEventListener('mouseenter', ()=>{ el('preview-img').src = img; el('lobby-card-preview').style.display='block'; });
      panel.querySelector('.player-sub').addEventListener('mouseleave', ()=>{ el('lobby-card-preview').style.display='none'; el('preview-img').src=''; });
    }
  });

  // controls
  document.querySelectorAll('.control-btn').forEach(b=>{
    b.addEventListener('click', async (e)=>{
      const pid = e.currentTarget.dataset.pid, action = e.currentTarget.dataset.action;
      await applyLifeChange(pid, action);
    });
  });

  el('open-card-search').addEventListener('click', ()=> showModal('card-search-modal'));
  el('leave-room').addEventListener('click', leaveRoom);
  el('chat-send').addEventListener('click', sendChat);
  el('chat-input').addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') sendChat(); });

  // render chat
  renderChat(room.chat || [], meName);
}

/* ---------------- ROOM ACTIONS ---------------- */
async function applyLifeChange(pid, action){
  if(!roomId) return;
  const delta = parseInt(action.replace('+','')) * (action.startsWith('-') ? -1 : 1);
  const roomRef = doc(db, ROOM_COLLECTION, roomId);
  try{
    // simple optimistic update: fetch, modify, write
    const snap = await getDoc(roomRef);
    if(!snap.exists()) return;
    const data = snap.data();
    const players = data.players || {};
    players[pid] = players[pid] || { name: 'Player', life: startLife() };
    players[pid].life = (parseInt(players[pid].life)||startLife()) + delta;
    await updateDoc(roomRef, { players, lastLifeChange: serverTimestamp() });
  }catch(e){ console.error("life change error", e); }
}

async function sendChat(){
  const input = el('chat-input');
  const text = (input.value||'').trim();
  if(!text || !roomId) return;
  const roomRef = doc(db, ROOM_COLLECTION, roomId);
  try{
    const snap = await getDoc(roomRef);
    if(!snap.exists()) return;
    const data = snap.data();
    const chat = data.chat || [];
    // if text matches a validated card name, try to fetch image
    let cardImage = null;
    try{
      const r = await fetch(`${SCRYFALL_API}${encodeURIComponent(text)}`);
      const d = await r.json();
      if(r.ok) cardImage = d.image_uris?.normal || d.card_faces?.[0]?.image_uris?.normal || null;
    }catch(e){}
    chat.push({ senderId: userId, senderName: (data.players?.[userId]?.name)||'You', message: text, cardImageUrl: cardImage, ts: serverTimestamp() });
    await updateDoc(roomRef, { chat });
    input.value = '';
  }catch(e){ console.error("chat send error", e); }
}

/* ---------------- ROOM JOIN / CREATE / LEAVE ---------------- */
async function promptPassword(rid, mode){
  const pwd = prompt(`${mode==='create' ? 'Create' : 'Join'} room "${rid}". Enter a password (optional):`);
  if(pwd===null) return;
  if(mode==='create') await createRoom(rid, pwd);
  else await joinRoom(rid, pwd);
}

async function createRoom(rid, pwd){
  try{
    const ref = doc(db, ROOM_COLLECTION, rid);
    const snap = await getDoc(ref);
    if(snap.exists()){ alert('Room already exists.'); return; }
    const ownerId = userId || 'anon';
    const players = {};
    players[ownerId] = { name: 'Host', life: startLife(), commanderName: '', commanderImageUrl: '' };
    await setDoc(ref, { ownerId, players, playersOrder: [ownerId], createdAt: serverTimestamp(), lastLifeChange: serverTimestamp(), passwordHash: pwd ? hash(pwd) : null, chat: [] });
    joinRoom(rid, pwd);
  }catch(e){ console.error("create room error", e); }
}

async function joinRoom(rid, pwd){
  try{
    const ref = doc(db, ROOM_COLLECTION, rid);
    const snap = await getDoc(ref);
    if(!snap.exists()){ alert('Room not found'); return; }
    const data = snap.data();
    if(data.passwordHash && data.passwordHash !== hash(pwd||'')){ alert('Incorrect password'); return; }
    // add player
    const pid = userId || `anon_${Math.random().toString(36).slice(2,8)}`;
    const players = data.players || {};
    if(!players[pid]) players[pid] = { name: `Player ${Object.keys(players).length+1}`, life: startLife(), commanderName: '', commanderImageUrl: '' };
    const order = Array.isArray(data.playersOrder) ? [...new Set([...(data.playersOrder||[]), pid])] : Object.keys(players);
    await updateDoc(ref, { players, playersOrder: order, lastLifeChange: serverTimestamp() });
    enterRoom(rid);
  }catch(e){ console.error("join room error", e); }
}

async function enterRoom(rid){
  if(unsubscribeRoom) unsubscribeRoom();
  roomId = rid;
  const ref = doc(db, ROOM_COLLECTION, rid);
  unsubscribeRoom = onSnapshot(ref, snap=>{
    if(!snap.exists()){ alert('Room closed'); if(unsubscribeRoom){ unsubscribeRoom(); unsubscribeRoom=null; } renderSetup(); return; }
    const data = snap.data();
    renderRoom(data);
  });
  history.pushState(null,'',`#room-${rid}`);
  el('status-message').textContent = `In room ${rid}`;
}

async function leaveRoom(){
  if(!roomId) return renderSetup();
  if(unsubscribeRoom){ unsubscribeRoom(); unsubscribeRoom=null; }
  roomId = null;
  renderSetup();
}

/* ---------------- ADMIN: delete all rooms ---------------- */
async function deleteAllRooms(){
  if(!confirm('Delete all rooms? This is irreversible.')) return;
  try{
    const q = query(collection(db, ROOM_COLLECTION), limit(200));
    const snap = await getDocs(q);
    const deletes = [];
    snap.forEach(s=> deletes.push(deleteDoc(doc(db, ROOM_COLLECTION, s.id))));
    await Promise.all(deletes);
    alert('Deleted rooms (up to 200).');
    renderSetup();
  }catch(e){ console.error("delete all error", e); alert('Error deleting rooms'); }
}

/* ---------------- MODALS & AUTOCOMPLETE ---------------- */
function showModal(id){ el(id).style.display='flex'; el(id).setAttribute('aria-hidden','false'); }
function hideModal(id){ el(id).style.display='none'; el(id).setAttribute('aria-hidden','true'); }

el('modal-close-btn').addEventListener('click', ()=> hideModal('card-search-modal'));
el('modal-search-btn').addEventListener('click', async ()=>{
  const name = (el('modal-card-name').value||'').trim();
  if(!name) return;
  const v = await scryValidate(name);
  if(!v){ el('search-results').textContent = 'Card not found.'; return; }
  // post to chat as card
  if(roomId){
    const ref = doc(db, ROOM_COLLECTION, roomId);
    const snap = await getDoc(ref);
    const data = snap.data();
    const chat = data.chat || [];
    chat.push({ senderId: userId, senderName: data.players?.[userId]?.name||'You', message: v.name, cardImageUrl: v.imageUrl, ts: serverTimestamp() });
    await updateDoc(ref, { chat });
    hideModal('card-search-modal');
  } else alert('Join a room first.');
});

el('modal-card-name').addEventListener('input', (e)=>{
  clearTimeout(autocompleteTimer);
  autocompleteTimer = setTimeout(()=> scryAutocomplete(e.target.value, 'modal-suggestions-list', 'modal-card-name'), AUTOCOMPLETE_DEBOUNCE_MS);
});

/* ---------------- EDIT COMMANDER ---------------- */
el('edit-commander-cancel').addEventListener('click', ()=> hideModal('edit-commander-modal'));
el('edit-commander-save').addEventListener('click', async ()=>{
  const name = (el('edit-commander-name').value||'').trim();
  if(!name || !roomId) return;
  const v = await scryValidate(name);
  if(!v){ el('edit-commander-result').textContent = 'Commander not found.'; return; }
  const ref = doc(db, ROOM_COLLECTION, roomId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const players = data.players || {};
  if(players[userId]){ players[userId].commanderName = v.name; players[userId].commanderImageUrl = v.imageUrl; await updateDoc(ref, { players }); }
  hideModal('edit-commander-modal');
});

/* ---------------- AUTH ---------------- */
onAuthStateChanged(auth, user=>{
  if(user){ userId = user.uid; el('status-message').textContent = 'Signed in'; if((location.hash||'#home').startsWith('#room-')){ const rid = location.hash.replace('#room-',''); enterRoom(rid); } else renderSetup(); }
  else signInAnonymously(auth).catch(e=>console.error(e));
});
signInAnonymously(auth).catch(()=>{ /* ignore */ });

/* ---------------- BOOT ---------------- */
navigate((location.hash||'#home').replace('#','') || 'home');
</script>
</body>
</html>
