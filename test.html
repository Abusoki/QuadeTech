<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTG Life Tracker</title>
  <style>
    :root{
      --bg:#0f1113;--card:#16181a;--muted:#9aa3ad;--text:#e6eef6;
      --accent:#2980b9;--accent-strong:#1f6fa8;--green:#27ae60;--red:#c0392b;
      --dark-border:#22272a;--input-bg:#1f2326;
    }
    /* Prevent layout overflow and ensure predictable sizing */
    *,*::before,*::after{ box-sizing:border-box }
    html,body{height:100%;margin:0}
    body{
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background:var(--bg);color:var(--text);display:flex;flex-direction:column;
      align-items:center;padding:20px;box-sizing:border-box;min-height:100vh;
      overflow-x:hidden; /* stop right-side clipping on mobile */
    }
    header.app-header{width:100%;max-width:1100px;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .app-title{margin:0;font-size:1.25rem;color:var(--text)}
    .app-subtitle{margin:0;font-size:0.8rem;color:var(--muted);font-style:italic}
    nav.site-nav{display:flex;gap:8px;flex-wrap:wrap}
    nav.site-nav button{background:transparent;color:var(--text);border:1px solid transparent;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    nav.site-nav button.active{background:rgba(41,128,185,0.10);border-color:var(--accent)}
    #app-container{width:100%;max-width:1100px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);box-sizing:border-box;position:relative}
    input,textarea,select{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid var(--dark-border);background:var(--input-bg);color:var(--text);box-sizing:border-box}
    textarea{min-height:120px;resize:vertical}
    input,button,textarea,select{-webkit-appearance:none;appearance:none;-webkit-tap-highlight-color:transparent}
    *:focus,*:focus-visible,*:focus-within{outline:none!important;box-shadow:none!important}
    button{
      cursor:pointer;border-radius:8px;padding:10px 12px;border:none;font-weight:700;
      transition:transform .03s ease,opacity .06s;
    }
    button:active,.tapped{transform:scale(.96)}
    .btn-primary{background:linear-gradient(180deg,var(--green),#1f8a4a);color:#fff}
    .btn-danger{background:linear-gradient(180deg,var(--red),#9b2b24);color:#fff}
    .btn-secondary{background:linear-gradient(180deg,#3a3a3a,#2f2f2f);color:#fff}
    button:disabled, input:disabled { opacity: .45; cursor: not-allowed; filter: grayscale(.2); }
    .player-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:12px}
    @media(max-width:900px){.player-grid{grid-template-columns:1fr}}
    .player-panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border:1px solid var(--dark-border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;box-shadow:0 6px 18px rgba(0,0,0,0.6);transform-origin:center center;transition:transform .18s ease}
    .player-eliminated{opacity:.5}
    .player-header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .player-name{font-weight:800;font-size:1rem;color:var(--text)}
    .player-sub{font-size:.85rem;color:var(--muted)}
    .life-big{font-size:3.2rem;font-weight:900;color:var(--text);letter-spacing:-1px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .control-btn{padding:8px 12px;border-radius:8px;font-weight:800;min-width:56px;text-align:center;background:linear-gradient(180deg,#2b2b2b,#232323);color:var(--text);border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .control-btn.positive{background:linear-gradient(180deg,#2ecc71,#27ae60);color:#04260a}
    .control-btn.negative{background:linear-gradient(180deg,#ff6b6b,#c0392b);color:#2b0706}
    .cmd-block{display:flex;justify-content:space-between;align-items:center;gap:8px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    .cmd-label{font-size:.9rem;color:var(--muted)}
    .cmd-value{font-weight:800;color:#ffb3b3}
    .you-badge{background:linear-gradient(90deg,var(--accent),var(--accent-strong));color:#fff;padding:6px 8px;border-radius:999px;font-weight:800;font-size:.8rem}
    .cmd-controls{display:none;margin-top:10px}
    .cmd-controls.open{display:block}
    .per-opp-container{margin-top:10px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto;border-top:1px solid rgba(255,255,255,0.02);padding-top:8px}
    .per-opp-row{height:44px;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);box-sizing:border-box}
    .per-opp-left{font-size:0.9em;color:var(--muted);font-weight:700}
    .per-opp-controls{display:flex;align-items:center;gap:8px}
    .outgoing-cmd-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .outgoing-cmd-item{font-size:0.95rem;color:var(--text);display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .infect-block{margin-top:8px;display:flex;align-items:center;gap:8px}
    .infect-label{font-size:0.85rem;color:var(--muted)}
    .infect-value{font-weight:800;color:#bfe6a8;min-width:36px;text-align:center}
    .small-btn{padding:6px 8px;font-size:0.85rem;min-width:36px;border-radius:6px}
    #chat-log{height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,0.03);padding:10px;margin-bottom:10px;border-radius:8px;background:#0f1113;font-size:.95em}
    .chat-message{margin-bottom:6px;display:flex;gap:8px;align-items:center}
    .chat-sender{font-weight:800;color:#74b9ff;margin-right:6px}
    .chat-sender.system{color:#ffd166;font-weight:900}
    .chat-card{display:inline-block;position:relative;cursor:pointer;color:var(--text);text-decoration:underline dotted rgba(255,255,255,0.08)}
    #chat-card-preview{position:fixed;top:50%;right:20px;transform:translateY(-50%);width:300px;max-width:40vw;border:3px solid var(--accent);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.7);background:#0b0d0f;z-index:1500;display:none;padding:8px}
    #chat-card-preview img{display:block;width:100%;border-radius:6px}
    #chat-card-preview .card-title{margin-top:8px;font-weight:800;color:var(--text);text-align:center}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:2000;padding:16px}
    .modal-content{background:#16181a;color:var(--text);padding:20px;border-radius:10px;width:100%;max-width:520px;box-shadow:0 12px 40px rgba(0,0,0,.7);position:relative}
    .suggestions-list{position:absolute;width:100%;background:var(--input-bg);border:1px solid var(--dark-border);border-top:none;max-height:150px;overflow-y:auto;z-index:100;border-radius:0 0 8px 8px;box-shadow:0 6px 18px rgba(0,0,0,0.6);margin-top:-10px}
    .suggestions-list:empty{display:none!important;border:none!important;box-shadow:none!important;margin-top:0!important}
    .suggestion-item{padding:8px 12px;cursor:pointer;color:var(--text)}
    .suggestion-item:hover{background:rgba(41,128,185,.08)}
    #lobby-card-preview{position:fixed;top:50%;left:20px;transform:translateY(-50%);width:260px;border:3px solid var(--accent);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.8);z-index:999;display:none;background:#0b0d0f}
    #lobby-card-preview img{display:block;width:100%;border-radius:6px}
    #lobby-features{margin-top:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #room-footer{margin-top:14px;color:var(--muted);font-size:.9rem;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    /* Chat full width container */
    #chat-container{width:100%;margin-top:18px}
    #chat-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    /* Mobile-specific layout fixes */
    @media(max-width:720px){
      header.app-header{flex-direction:column;align-items:flex-start;gap:8px}
      #lobby-card-preview{display:none!important}
      #chat-card-preview{display:none!important}
      /* Stack the inner player panel columns vertically to avoid horizontal overflow */
      .player-panel > div[style*="display:flex"][style*="justify-content:space-between"]{
        flex-direction:column!important;align-items:stretch!important;gap:12px!important
      }
      /* Make the right-side controls full width on mobile */
      .player-panel .controls{width:100%}
      .player-panel div[style*="min-width:220px"]{min-width:0!important;width:100%!important}
      /* Reduce container padding slightly */
      #app-container{padding:14px}
      body{padding:14px}
    }

    /* Rotation helper classes (applied inline via style attribute for per-panel rotation) */
    .rotate-0{ transform: rotate(0deg); }
    .rotate-90{ transform: rotate(90deg); }
    .rotate-180{ transform: rotate(180deg); }
    .rotate-270{ transform: rotate(270deg); }

    /* Ensure rotated panels don't overflow container visually */
    .player-panel.rotated {
      transition: transform .18s ease;
    }

    /* Small rotate button */
    .rotate-btn {
      padding:6px 8px;border-radius:6px;background:linear-gradient(180deg,#2b2b2b,#232323);color:var(--text);border:1px solid rgba(255,255,255,0.03);font-weight:800;font-size:0.85rem;cursor:pointer;
    }

    /* Keep per-opp inputs readable when rotated by not changing their internal orientation (optional future improvement) */
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="brand">
      <h1 class="app-title">Cardboard Bonfire</h1>
      <div class="app-subtitle">Life tracker for keeping life and bringing people together.</div>
    </div>
    <nav class="site-nav" role="navigation" aria-label="Main">
      <button id="nav-home" class="nav-btn">Home</button>
      <button id="nav-local" class="nav-btn">Local</button>
      <button id="nav-changes" class="nav-btn">Changes</button>
      <button id="nav-contact" class="nav-btn">Contact</button>
    </nav>
  </header>

  <main id="app-container" role="main"></main>

  <div id="lobby-card-preview" aria-hidden="true"><img id="preview-img" alt="Commander Preview"></div>
  <div id="chat-card-preview" aria-hidden="true"><img id="chat-preview-img" alt="Card Preview"><div class="card-title" id="chat-preview-title"></div></div>
  <p id="status-message" class="muted">Initializing...</p>

  <div id="card-search-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 style="margin-top:0">Card Search (Scryfall)</h3>
      <input type="text" id="modal-card-name" placeholder="Enter card name" autocomplete="off">
      <div id="modal-suggestions-list" class="suggestions-list"></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="modal-search-btn" class="btn-primary">Search & Post</button>
        <button id="modal-close-btn" class="btn-secondary">Close</button>
      </div>
      <div id="search-results" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="edit-commander-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 style="margin-top:0">Edit Commander</h3>
      <input type="text" id="edit-commander-name" placeholder="Commander name">
      <div id="edit-commander-suggestions" class="suggestions-list"></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="edit-commander-save" class="btn-primary">Save</button>
        <button id="edit-commander-cancel" class="btn-secondary">Cancel</button>
      </div>
      <div id="edit-commander-result" style="margin-top:12px"></div>
    </div>
  </div>

  <script type="module">
    // ----------------------------------------------------------------------
    // CONFIG
    // ----------------------------------------------------------------------
    const USER_FIREBASE_CONFIG = {
      apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E",
      authDomain: "mtg-life-tool.firebaseapp.com",
      projectId: "mtg-life-tool",
      storageBucket: "mtg-life-tool.appspot.com",
      messagingSenderId: "36730058988",
      appId: "1:36730058988:web:757e2d9620593b4f65022a"
    };

    // TIMEOUT: set to 20 minutes per request
    const TIMEOUT_MINUTES = 20;

    const SCRYFALL_API = "https://api.scryfall.com/cards/named?exact=";
    const SCRYFALL_AUTOCOMPLETE_API = "https://api.scryfall.com/cards/autocomplete?q=";
    const DELETE_ALL_PWD = "DeleteAllRooms";
    const AUTOCOMPLETE_DEBOUNCE_MS = 100;

    // ----------------------------------------------------------------------
    // IMPORTS
    // ----------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp,
      arrayUnion, deleteDoc, collection, getDocs, query, limit, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ----------------------------------------------------------------------
    // GLOBALS
    // ----------------------------------------------------------------------
    const app = initializeApp(USER_FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userId = null;
    let roomId = null;
    let unsubscribe = null;
    let autocompleteTimeout = null;
    const ROOM_COLLECTION = "mtg_rooms";

    // Track which players' CMD controls are open (persist across renders)
    const openCmdControls = new Set();

    // ----------------------------------------------------------------------
    // HELPERS
    // ----------------------------------------------------------------------
    function hashPassword(password){ return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex); }
    function getStartingLife(){ return 40; }

    async function validateCommander(name){
      if(!name) return null;
      try{
        const response = await fetch(`${SCRYFALL_API}${encodeURIComponent(name)}`);
        const data = await response.json();
        if(response.ok){
          const imageUrl = data.image_uris?.normal || data.card_faces?.[0]?.image_uris?.normal;
          if(imageUrl) return { validatedName: data.name, imageUrl };
        }
        return null;
      }catch(e){ console.error("Scryfall validation error:", e); return null; }
    }

    async function fetchAutocompleteSuggestions(query, listId, inputId){
      const suggestionsList = document.getElementById(listId);
      const inputField = document.getElementById(inputId);
      if(!suggestionsList || !inputField) return;
      suggestionsList.innerHTML = '';
      if(query.length < 2) return;
      try{
        const response = await fetch(`${SCRYFALL_AUTOCOMPLETE_API}${encodeURIComponent(query)}`);
        const data = await response.json();
        if(response.ok && data.data && data.data.length){
          data.data.slice(0,5).forEach(suggestion=>{
            const item = document.createElement('div');
            item.classList.add('suggestion-item');
            item.textContent = suggestion;
            item.onclick = () => { inputField.value = suggestion; suggestionsList.innerHTML = ''; };
            suggestionsList.appendChild(item);
          });
        }
      }catch(e){ console.error("Autocomplete error:", e); }
    }

    // compute outgoing map for a source player (what this player's commander has done to others)
    function computeOutgoingCmdDamage(roomData, sourcePlayerId){
      const players = roomData.players || {};
      const order = Array.isArray(roomData.playersOrder) && roomData.playersOrder.length ? roomData.playersOrder : Object.keys(players || {});
      const result = [];
      order.forEach(pid => {
        if(pid === sourcePlayerId) return;
        const dmg = (players[sourcePlayerId]?.commanderDamage || {})[pid] || 0;
        const name = players[pid]?.name || 'Player';
        result.push({ oppId: pid, oppName: name, dmg });
      });
      return result;
    }

    // compute outgoing total for a source player (sum of their commanderDamage map)
    function computeOutgoingTotal(roomData, sourcePlayerId){
      const dmgMap = (roomData.players?.[sourcePlayerId]?.commanderDamage) || {};
      return Object.keys(dmgMap).reduce((s,k)=> s + (parseInt(dmgMap[k])||0), 0);
    }

    // compute incoming total for a target player
    function computeIncomingCmdDamage(roomData, targetPlayerId){
      let total = 0;
      const players = roomData.players || {};
      Object.keys(players).forEach(pid=>{
        const dmgMap = players[pid]?.commanderDamage || {};
        const val = dmgMap[targetPlayerId] || 0;
        total += val;
      });
      return total;
    }

    // compute max incoming from a single opponent to target (for 21+ elimination)
    function computeMaxSingleIncomingCmdDamage(roomData, targetPlayerId){
      let maxVal = 0;
      const players = roomData.players || {};
      Object.keys(players).forEach(pid=>{
        const dmgMap = players[pid]?.commanderDamage || {};
        const val = dmgMap[targetPlayerId] || 0;
        if(val > maxVal) maxVal = val;
      });
      return maxVal;
    }

    // ----------------------------------------------------------------------
    // ROUTING & PAGES
    // ----------------------------------------------------------------------
    const navButtons = {
      home: document.getElementById('nav-home'),
      local: document.getElementById('nav-local'),
      changes: document.getElementById('nav-changes'),
      contact: document.getElementById('nav-contact')
    };
    function setActiveNav(page){
      Object.values(navButtons).forEach(b=>b.classList.remove('active'));
      if(navButtons[page]) navButtons[page].classList.add('active');
    }
    function navigateTo(page){
      if(location.hash !== `#${page}`) history.pushState(null,'',`#${page}`);
      setActiveNav(page);
      if(page === 'home') renderHome();
      else if(page === 'local') renderLocal();
      else if(page === 'changes') renderChanges();
      else if(page === 'contact') renderContact();
    }
    navButtons.home.addEventListener('click', ()=>navigateTo('home'));
    navButtons.local.addEventListener('click', ()=>navigateTo('local'));
    navButtons.changes.addEventListener('click', ()=>navigateTo('changes'));
    navButtons.contact.addEventListener('click', ()=>navigateTo('contact'));
    window.addEventListener('popstate', ()=>{
      const page = (location.hash || '#home').replace('#','') || 'home';
      setActiveNav(page);
      if(page === 'home') renderHome();
      else if(page === 'local') renderLocal();
      else if(page === 'changes') renderChanges();
      else if(page === 'contact') renderContact();
    });

    async function renderHome(){ await renderSetupView(); }

    const CHANGELOG = [
      { version: "0.0.3", date: "2025-12-08", notes: "Added a local lobby to play with a single device. (Need to add panel rotations later.)" },
      { version: "0.0.2", date: "2025-12-08", notes: "Show CMD labels, persist lobby on refresh, 20-minute timeout based on life changes, lobby timestamps." },
      { version: "0.0.1", date: "2025-12-07", notes: "Fleshed out the UI, follow through on a design, set up the live portion." }
    ];

    function renderChanges(){
      const appContainer = document.getElementById('app-container');
      let html = `<h2 style="margin-top:0;color:var(--text)">Changes</h2><div style="display:flex;flex-direction:column;gap:12px">`;
      CHANGELOG.forEach(entry=>{
        html += `<div style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border)"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700;color:var(--text)">${entry.version}</div><div class="muted">${entry.date}</div></div><div style="margin-top:8px;color:var(--text)">${entry.notes}</div></div>`;
      });
      html += `</div>`;
      appContainer.innerHTML = html;
    }

    function renderContact(){
      const appContainer = document.getElementById('app-container');
      appContainer.innerHTML = `
        <h2 style="margin-top:0;color:var(--text)">Contact</h2>
        <p class="muted">To contact me, please use your email client. Click the button below to open a new message addressed to <strong>CardboardBonfire@gmail.com</strong>.</p>
        <div style="max-width:640px">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="contact-mailto" class="btn-primary">Email CardboardBonfire@gmail.com</button>
            <button id="contact-copy" class="btn-secondary">Copy Email</button>
          </div>
          <p id="contact-status" class="muted" style="margin-top:8px"></p>
        </div>
      `;
      document.getElementById('contact-mailto').addEventListener('click', ()=>{
        const subject = encodeURIComponent("Contact from MTG Life Tracker");
        const body = encodeURIComponent("Hi,\n\nI'd like to get in touch regarding...");
        window.location.href = `mailto:CardboardBonfire@gmail.com?subject=${subject}&body=${body}`;
      });
      document.getElementById('contact-copy').addEventListener('click', async ()=>{
        const status = document.getElementById('contact-status');
        try{ await navigator.clipboard.writeText('CardboardBonfire@gmail.com'); status.textContent = 'Email address copied to clipboard.'; }
        catch(e){ console.error(e); status.textContent = 'Unable to copy automatically â€” please copy: CardboardBonfire@gmail.com'; }
      });
    }

    // ----------------------------------------------------------------------
    // LOCAL PAGE (offline life tracker; single add box; no lobby name)
    // ----------------------------------------------------------------------
    const LOCAL_STORAGE_KEY = 'localRoom_v2';

    function getLocalData(){
      const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
      try { return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function setLocalData(data){
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
    }
    function resetLocalRoom(){
      localStorage.removeItem(LOCAL_STORAGE_KEY);
    }
    function uid(){ return 'p' + Math.random().toString(36).slice(2,9); }

    // ----------------------------------------------------------------------
    // NEW: helper to persist per-player UI state (cmd open + rotation) in localStorage
    // ----------------------------------------------------------------------
    function getLocalUiState(){
      try {
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY + '_ui');
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }
    function setLocalUiState(state){
      try { localStorage.setItem(LOCAL_STORAGE_KEY + '_ui', JSON.stringify(state)); } catch {}
    }
    function setPlayerUiState(pid, patch){
      const s = getLocalUiState();
      s[pid] = Object.assign({}, s[pid] || {}, patch);
      setLocalUiState(s);
    }
    function getPlayerUiState(pid){
      const s = getLocalUiState();
      return s[pid] || {};
    }

    function renderLocal(){
      const appContainer = document.getElementById('app-container');
      const cached = getLocalData();

      let html = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          <div>
            <h2 style="margin:0;color:var(--text)">Local Game</h2>
            <div class="muted" style="font-size:.9rem;margin-top:6px">Offline life tracking. Data stays in your browser.</div>
          </div>
          <div class="row">
            <button id="local-new-btn" class="btn-secondary">New Local Session</button>
            ${cached ? `<button id="local-reset-btn" class="btn-danger">Clear Local Data</button>` : ``}
          </div>
        </div>
      `;

      // Single add-player box (no lobby name)
      html += `
        <div id="local-setup" style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border);margin-bottom:12px">
          <div class="row" style="gap:12px">
            <div style="flex:1"><input type="text" id="local-player-name" placeholder="Player name"></div>
            <div style="width:220px"><input type="text" id="local-commander-name" placeholder="Commander (optional)"></div>
            <div style="width:160px"><button id="local-add-player-btn" class="btn-primary" style="width:100%">Add Player</button></div>
          </div>
          <p id="local-status" class="muted" style="margin-top:8px"></p>
        </div>
      `;

      html += `<div id="local-room-container"></div>`;
      appContainer.innerHTML = html;

      // Header actions
      document.getElementById('local-new-btn').addEventListener('click', ()=>{
        resetLocalRoom();
        const init = { roomName: 'Local Lobby', createdAt: Date.now(), playersOrder: [], players: {} };
        setLocalData(init);
        const status = document.getElementById('local-status');
        if(status) status.textContent = 'New local session started. Add players below.';
        renderLocalRoom(init);
      });
      const resetBtn = document.getElementById('local-reset-btn');
      if(resetBtn){
        resetBtn.addEventListener('click', ()=>{
          if(!confirm('Clear all local game data? This cannot be undone.')) return;
          resetLocalRoom();
          // also clear UI state
          try { localStorage.removeItem(LOCAL_STORAGE_KEY + '_ui'); } catch {}
          renderLocal();
        });
      }

      // Initial render: ensure a local session exists (no name needed)
      let data = cached || { roomName: 'Local Lobby', createdAt: Date.now(), playersOrder: [], players: {} };
      setLocalData(data);
      renderLocalRoom(data);

      // Add player from single box
      document.getElementById('local-add-player-btn').addEventListener('click', ()=>{
        const playerName = (document.getElementById('local-player-name').value || '').trim();
        const commander = (document.getElementById('local-commander-name').value || '').trim();
        if(!playerName){
          const status = document.getElementById('local-status');
          if(status) status.textContent = 'Enter a player name.';
          return;
        }
        const d = getLocalData() || data;
        const pid = uid();
        d.players[pid] = {
          name: playerName,
          life: getStartingLife(),
          infect: 0,
          commanderName: commander || '',
          commanderDamage: {},
          rotation: 0 // default rotation
        };
        d.playersOrder.push(pid);
        setLocalData(d);
        // initialize UI state for this player (closed cmd controls, rotation 0)
        setPlayerUiState(pid, { cmdOpen: false, rotation: 0 });
        document.getElementById('local-player-name').value = '';
        document.getElementById('local-commander-name').value = '';
        renderLocalRoom(d);
      });
    }

    function renderLocalRoom(roomData){
      const container = document.getElementById('local-room-container');
      if(!container) return;

      const playerIds = Array.isArray(roomData.playersOrder) && roomData.playersOrder.length
        ? [...roomData.playersOrder]
        : Object.keys(roomData.players || {});

      let html = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          <div>
            <h3 style="margin:0;color:var(--text)">Lobby: ${roomData.roomName || 'Local Lobby'}</h3>
            <div class="muted" style="font-size:.9rem;margin-top:6px">Players: ${playerIds.length}</div>
          </div>
          <div class="row">
            <button id="local-restart-btn" class="btn-secondary">Restart Game</button>
          </div>
        </div>
      `;

      html += `<div class="player-grid">`;

      playerIds.forEach(pid=>{
        const p = roomData.players[pid];
        if(!p) return;

        // Elimination: life <= 0 or incoming CMD from any single opponent >= 21
        const maxSingleIncoming = (() => {
          let maxVal = 0;
          Object.keys(roomData.players || {}).forEach(oppId=>{
            const dmgMap = roomData.players[oppId]?.commanderDamage || {};
            const val = dmgMap[pid] || 0;
            if(val > maxVal) maxVal = val;
          });
          return maxVal;
        })();
        const isEliminated = (p.life <= 0) || (maxSingleIncoming >= 21);

        const outgoingTotal = computeOutgoingTotal(roomData, pid);
        const outgoingBreakdown = computeOutgoingCmdDamage(roomData, pid);

        let outgoingBreakdownHtml = '<div class="outgoing-cmd-list">';
        if(outgoingBreakdown.length === 0){
          outgoingBreakdownHtml += `<div class="outgoing-cmd-item" style="justify-content:center;color:var(--muted)">No opponents yet</div>`;
        }else{
          outgoingBreakdown.forEach(item=>{
            outgoingBreakdownHtml += `<div class="outgoing-cmd-item"><div style="font-weight:700;color:var(--muted)">${item.oppName}: </div><div style="font-weight:900;color:#ffb3b3">${item.dmg}</div></div>`;
          });
        }
        outgoingBreakdownHtml += '</div>';

        // Per-opponent incoming editor (local): always editable
        let perOppRows = '';
        const opponents = playerIds.filter(id => id !== pid);
        opponents.forEach(oppId=>{
          const dmg = (roomData.players[oppId]?.commanderDamage || {})[pid] || 0;
          const oppName = roomData.players[oppId]?.name || 'Player';
          perOppRows += `
            <div class="per-opp-row" data-target="${pid}" data-opp="${oppId}">
              <div class="per-opp-left">From <strong>${oppName}</strong></div>
              <div class="per-opp-controls">
                <button class="control-btn negative small-btn" data-local-action="cmd-target-sub" data-target="${pid}" data-opp="${oppId}">-</button>
                <input type="number" value="${dmg}" data-target="${pid}" data-opp="${oppId}" class="cmd-target-input" style="width:64px;padding:6px;border-radius:6px;border:1px solid var(--dark-border);background:var(--input-bg);color:var(--text);text-align:center">
                <button class="control-btn negative small-btn" data-local-action="cmd-target-add" data-target="${pid}" data-opp="${oppId}">+</button>
              </div>
            </div>
          `;
        });

        const infectControlsHtml = `
          <div style="display:flex;align-items:center;gap:6px">
            <button class="control-btn small-btn" data-local-action="infect-sub" data-player="${pid}">-</button>
            <div class="infect-value" id="local-infect-${pid}">${p.infect || 0}</div>
            <button class="control-btn small-btn" data-local-action="infect-add" data-player="${pid}">+</button>
          </div>
        `;

        // Retrieve UI state for this player (cmd open + rotation)
        const uiState = getPlayerUiState(pid);
        const cmdOpen = !!uiState.cmdOpen;
        const rotation = (typeof uiState.rotation === 'number') ? uiState.rotation : (p.rotation || 0);
        const rotationClass = rotation === 0 ? 'rotate-0' : rotation === 90 ? 'rotate-90' : rotation === 180 ? 'rotate-180' : 'rotate-270';
        const rotatedClass = rotation !== 0 ? 'rotated' : '';

        // Build the player panel HTML. Note: we add a rotate button and a CMD DMG toggle button.
        html += `
          <div class="player-panel ${isEliminated ? 'player-eliminated' : ''} ${rotatedClass}" id="player-panel-${pid}" data-player="${pid}" style="transform: rotate(${rotation}deg);">
            <div class="player-header">
              <div style="display:flex;flex-direction:column;gap:4px">
                <div class="player-name">${p.name || 'Player'}</div>
                <div class="player-sub">Commander: ${p.commanderName || 'N/A'} <span style="margin-left:8px;color:var(--muted);font-weight:700">ID: ${pid}</span></div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="you-badge">${p.life}</div>
                <button class="rotate-btn" data-local-action="rotate-panel" data-player="${pid}">Rotate</button>
              </div>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
              <div style="min-width:220px">
                <div class="cmd-block">
                  <div>
                    <div class="cmd-label">Outgoing CMD DMG</div>
                    <div class="cmd-value">${outgoingTotal}</div>
                  </div>
                  <div style="display:flex;gap:8px;align-items:center">
                    <button class="control-btn small-btn" data-local-action="cmd-sub" data-player="${pid}" data-amt="5">-5</button>
                    <button class="control-btn small-btn" data-local-action="cmd-sub" data-player="${pid}" data-amt="1">-1</button>
                    <button class="control-btn small-btn" data-local-action="cmd-add" data-player="${pid}" data-amt="1">+1</button>
                    <button class="control-btn small-btn" data-local-action="cmd-add" data-player="${pid}" data-amt="5">+5</button>
                    <button class="control-btn small-btn" data-local-action="toggle-cmd-controls" data-player="${pid}">CMD DMG</button>
                    <button class="control-btn small-btn" data-local-action="edit-commander" data-player="${pid}">Edit Commander</button>
                    <button class="control-btn small-btn" data-local-action="remove-player" data-player="${pid}">Remove Player</button>
                  </div>
                </div>
                ${outgoingBreakdownHtml}
              </div>

              <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                <div style="display:flex;gap:8px;align-items:center">
                  ${infectControlsHtml}
                </div>
                <div style="display:flex;gap:8px">
                  <button class="btn-secondary" data-local-action="life-sub" data-player="${pid}" style="min-width:120px">-5 Life</button>
                  <button class="btn-primary" data-local-action="life-add" data-player="${pid}" style="min-width:120px">+5 Life</button>
                </div>
              </div>
            </div>

            <!-- CMD controls (incoming editor) -->
            <div class="cmd-controls ${cmdOpen ? 'open' : ''}" id="cmd-controls-${pid}">
              <div style="font-weight:800;color:var(--muted);margin-bottom:6px">Edit this player's incoming commander damage values</div>
              <div class="per-opp-container">
                ${perOppRows || `<div class="outgoing-cmd-item" style="justify-content:center;color:var(--muted)">No opponents yet</div>`}
              </div>
            </div>
          </div>
        `;
      });

      html += `</div>`; // close player-grid

      container.innerHTML = html;

      // Restart button
      const restartBtn = document.getElementById('local-restart-btn');
      if(restartBtn){
        restartBtn.addEventListener('click', ()=>{
          if(!confirm('Restart game and reset all life/infect/commander damage?')) return;
          const d = getLocalData() || roomData;
          Object.keys(d.players || {}).forEach(pid=>{
            d.players[pid].life = getStartingLife();
            d.players[pid].infect = 0;
            d.players[pid].commanderDamage = {};
            // keep rotation and commander name intact
          });
          setLocalData(d);
          renderLocalRoom(d);
        });
      }

      // ----------------------------------------------------------------------
      // Event delegation for local controls
      // ----------------------------------------------------------------------
      container.querySelectorAll('[data-local-action]').forEach(el=>{
        el.addEventListener('click', (ev)=>{
          const action = el.getAttribute('data-local-action');
          const player = el.getAttribute('data-player');
          const target = el.getAttribute('data-target');
          const opp = el.getAttribute('data-opp');
          const amt = parseInt(el.getAttribute('data-amt') || '0', 10);

          const d = getLocalData();
          if(!d) return;

          // Helper to persist and re-render
          function saveAndRerender(){
            setLocalData(d);
            renderLocalRoom(d);
          }

          if(action === 'remove-player'){
            if(!confirm('Remove this player?')) return;
            // remove player
            delete d.players[player];
            d.playersOrder = d.playersOrder.filter(id => id !== player);
            // also remove any commanderDamage entries referencing this player
            Object.keys(d.players || {}).forEach(pid=>{
              if(d.players[pid] && d.players[pid].commanderDamage){
                delete d.players[pid].commanderDamage[player];
              }
            });
            // remove UI state
            const ui = getLocalUiState();
            if(ui[player]){ delete ui[player]; setLocalUiState(ui); }
            saveAndRerender();
            return;
          }

          if(action === 'edit-commander'){
            const newName = prompt('Enter commander name (leave blank to clear):', d.players[player].commanderName || '');
            if(newName !== null){
              d.players[player].commanderName = (newName || '').trim();
              saveAndRerender();
            }
            return;
          }

          if(action === 'life-add' || action === 'life-sub'){
            const delta = action === 'life-add' ? 5 : -5;
            d.players[player].life = (parseInt(d.players[player].life) || 0) + delta;
            saveAndRerender();
            return;
          }

          if(action === 'infect-add' || action === 'infect-sub'){
            const delta = action === 'infect-add' ? 1 : -1;
            d.players[player].infect = Math.max(0, (parseInt(d.players[player].infect) || 0) + delta);
            saveAndRerender();
            return;
          }

          if(action === 'cmd-add' || action === 'cmd-sub'){
            // These buttons adjust the outgoing total by adding/subtracting to a "self" aggregate.
            // Implementation: add to a synthetic "self" entry in commanderDamage mapping keyed by 'self' or adjust nothing.
            // To keep original behavior intact, we'll increment a special outgoing counter stored on player as 'outgoingBuffer'
            const delta = (action === 'cmd-add' ? amt : -amt) || 0;
            d.players[player].outgoingBuffer = (d.players[player].outgoingBuffer || 0) + delta;
            // Note: outgoingBuffer is only a UI convenience; it does not change per-opponent commanderDamage.
            saveAndRerender();
            return;
          }

          if(action === 'cmd-target-add' || action === 'cmd-target-sub'){
            // Adjust incoming commander damage from opp -> target (target is data-target)
            const delta = action === 'cmd-target-add' ? 1 : -1;
            const targetId = target;
            const oppId = opp;
            if(!d.players[oppId]) return;
            d.players[oppId].commanderDamage = d.players[oppId].commanderDamage || {};
            d.players[oppId].commanderDamage[targetId] = Math.max(0, (parseInt(d.players[oppId].commanderDamage[targetId]) || 0) + delta);
            saveAndRerender();
            return;
          }

          if(action === 'toggle-cmd-controls'){
            // ----------------------------------------------------------------
            // NEW: Toggle persistent CMD controls for this player.
            // When toggled open, it stays open until toggled again. Persisted in local UI state.
            // ----------------------------------------------------------------
            const ui = getPlayerUiState(player);
            const newOpen = !ui.cmdOpen;
            setPlayerUiState(player, { cmdOpen: newOpen });
            // Re-render to reflect change
            renderLocalRoom(d);
            return;
          }

          if(action === 'rotate-panel'){
            // ----------------------------------------------------------------
            // NEW: Cycle rotation for this player's panel: 0 -> 90 -> 180 -> 270 -> 0
            // Persist rotation in local UI state and in room data (so it survives refresh)
            // ----------------------------------------------------------------
            const ui = getPlayerUiState(player);
            const current = (typeof ui.rotation === 'number') ? ui.rotation : (d.players[player].rotation || 0);
            const next = current === 0 ? 90 : current === 90 ? 180 : current === 180 ? 270 : 0;
            // persist both in UI state and in room data
            setPlayerUiState(player, { rotation: next, cmdOpen: ui.cmdOpen || false });
            d.players[player].rotation = next;
            saveAndRerender();
            return;
          }
        });
      });

      // ----------------------------------------------------------------------
      // Also wire up numeric inputs for per-opp direct edits
      // ----------------------------------------------------------------------
      container.querySelectorAll('.cmd-target-input').forEach(input=>{
        input.addEventListener('change', (ev)=>{
          const target = input.getAttribute('data-target');
          const opp = input.getAttribute('data-opp');
          const val = parseInt(input.value || '0', 10);
          const d = getLocalData();
          if(!d) return;
          d.players[opp].commanderDamage = d.players[opp].commanderDamage || {};
          d.players[opp].commanderDamage[target] = Math.max(0, val || 0);
          setLocalData(d);
          renderLocalRoom(d);
        });
      });
    }

    // ----------------------------------------------------------------------
    // Minimal placeholder for renderSetupView used by renderHome
    // (keeps original app behavior intact)
    // ----------------------------------------------------------------------
    async function renderSetupView(){
      const appContainer = document.getElementById('app-container');
      appContainer.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          <div>
            <h2 style="margin:0;color:var(--text)">Home</h2>
            <div class="muted" style="font-size:.9rem;margin-top:6px">Create or join a lobby, or use the Local game for offline play.</div>
          </div>
          <div class="row">
            <button id="home-local-btn" class="btn-primary">Open Local Game</button>
          </div>
        </div>
        <div style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border)">
          <p class="muted">This is the home view. Use the navigation to access Local, Changes, or Contact.</p>
        </div>
      `;
      document.getElementById('home-local-btn').addEventListener('click', ()=>navigateTo('local'));
    }

    // ----------------------------------------------------------------------
    // Initialize default route
    // ----------------------------------------------------------------------
    (function init(){
      const page = (location.hash || '#home').replace('#','') || 'home';
      setActiveNav(page);
      if(page === 'home') renderHome();
      else if(page === 'local') renderLocal();
      else if(page === 'changes') renderChanges();
      else if(page === 'contact') renderContact();
    })();

  </script>
</body>
</html>
