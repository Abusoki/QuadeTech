<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MTG Life Tracker</title>
<style>
:root{
  --bg:#0f1113;--card:#16181a;--muted:#9aa3ad;--text:#e6eef6;
  --accent:#2980b9;--accent-strong:#1f6fa8;--green:#27ae60;--red:#c0392b;
  --dark-border:#22272a;--input-bg:#1f2326;
}
html,body{height:100%;margin:0}
*{box-sizing:border-box}
body{
  font-family:"Segoe UI",Tahoma, Geneva, Verdana, sans-serif;
  background:var(--bg);color:var(--text);display:flex;flex-direction:column;
  align-items:center;padding:20px;min-height:100vh;
}
header.app-header{width:100%;max-width:1100px;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
.brand{display:flex;flex-direction:column;gap:2px}
.app-title{margin:0;font-size:1.25rem;color:var(--text)}
.app-subtitle{margin:0;font-size:0.8rem;color:var(--muted);font-style:italic}
nav.site-nav{display:flex;gap:8px}
nav.site-nav button{background:transparent;color:var(--text);border:1px solid transparent;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
nav.site-nav button.active{background:rgba(41,128,185,0.10);border-color:var(--accent)}
#app-container{width:100%;max-width:1100px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);box-sizing:border-box;position:relative}
input,textarea,select{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid var(--dark-border);background:var(--input-bg);color:var(--text);box-sizing:border-box}
textarea{min-height:120px;resize:vertical}
button{cursor:pointer;border-radius:8px;padding:10px 12px;border:none;font-weight:700;transition:transform .08s ease,opacity .12s}
button:active,.tapped{transform:scale(.96)}
.btn-primary{background:linear-gradient(180deg,var(--green),#1f8a4a);color:#fff}
.btn-danger{background:linear-gradient(180deg,var(--red),#9b2b24);color:#fff}
.btn-secondary{background:linear-gradient(180deg,#3a3a3a,#2f2f2f);color:#fff}
button:disabled, input:disabled { opacity: .45; cursor: not-allowed; filter: grayscale(.2); }
.player-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:12px}
@media(max-width:900px){.player-grid{grid-template-columns:1fr}}
.player-panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border:1px solid var(--dark-border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px;position:relative;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
.player-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
.player-name{font-weight:800;font-size:1rem;color:var(--text)}
.player-sub{font-size:.85rem;color:var(--muted)}
.life-big{font-size:3.2rem;font-weight:900;color:var(--text);letter-spacing:-1px}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.control-btn{padding:8px 12px;border-radius:8px;font-weight:800;min-width:56px;text-align:center;background:linear-gradient(180deg,#2b2b2b,#232323);color:var(--text);border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
.control-btn.positive{background:linear-gradient(180deg,#2ecc71,#27ae60);color:#04260a}
.control-btn.negative{background:linear-gradient(180deg,#ff6b6b,#c0392b);color:#2b0706}
.cmd-block{display:flex;justify-content:space-between;align-items:center;gap:8px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.cmd-label{font-size:.9rem;color:var(--muted)}
.cmd-value{font-weight:800;color:#ffb3b3}
.you-badge{background:linear-gradient(90deg,var(--accent),var(--accent-strong));color:#fff;padding:6px 8px;border-radius:999px;font-weight:800;font-size:.8rem}
.per-opp-container{margin-top:10px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto;border-top:1px solid rgba(255,255,255,0.02);padding-top:8px}
.per-opp-row{height:44px;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);box-sizing:border-box}
.per-opp-left{font-size:0.9em;color:var(--muted);font-weight:700}
.outgoing-cmd-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.outgoing-cmd-item{font-size:0.95rem;color:var(--text);display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
.infect-block{margin-top:8px;display:flex;align-items:center;gap:8px}
.infect-label{font-size:0.85rem;color:var(--muted)}
.infect-value{font-weight:800;color:#bfe6a8;min-width:36px;text-align:center}
.small-btn{padding:6px 8px;font-size:0.85rem;min-width:36px;border-radius:6px}
#chat-log{height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,0.03);padding:10px;margin-bottom:10px;border-radius:8px;background:#0f1113;font-size:.95em}
.chat-message{margin-bottom:6px;display:flex;gap:8px;align-items:center}
.chat-sender{font-weight:800;color:#74b9ff;margin-right:6px}
.chat-sender.system{color:#ffd166;font-weight:900}
.chat-card{display:inline-block;position:relative;cursor:pointer;color:var(--text);text-decoration:underline dotted rgba(255,255,255,0.08)}
#chat-card-preview{position:fixed;top:50%;right:20px;transform:translateY(-50%);width:300px;max-width:40vw;border:3px solid var(--accent);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.7);background:#0b0d0f;z-index:1500;display:none;padding:8px}
#chat-card-preview img{display:block;width:100%;border-radius:6px}
#chat-card-preview .card-title{margin-top:8px;font-weight:800;color:var(--text);text-align:center}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:2000}
.modal-content{background:#16181a;color:var(--text);padding:20px;border-radius:10px;width:92%;max-width:520px;box-shadow:0 12px 40px rgba(0,0,0,.7);position:relative}
.suggestions-list{position:absolute;width:100%;background:var(--input-bg);border:1px solid var(--dark-border);border-top:none;max-height:150px;overflow-y:auto;z-index:100;border-radius:0 0 8px 8px;box-shadow:0 6px 18px rgba(0,0,0,.6);margin-top:-10px}
.suggestion-item{padding:8px 12px;cursor:pointer;color:var(--text)}
.suggestion-item:hover{background:rgba(41,128,185,.08)}
#lobby-card-preview{position:fixed;top:50%;left:20px;transform:translateY(-50%);width:260px;border:3px solid var(--accent);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.8);z-index:999;display:none;background:#0b0d0f}
#lobby-card-preview img{display:block;width:100%;border-radius:6px}
#room-footer{margin-top:14px;color:var(--muted);font-size:.9rem;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.muted{color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}
@media(max-width:720px){header.app-header{flex-direction:column;align-items:flex-start;gap:8px}#lobby-card-preview{display:none!important}#chat-card-preview{display:none!important}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="brand">
      <h1 class="app-title">Cardboard Bonfire</h1>
      <div class="app-subtitle">Life tracker for keeping life and bringing people together.</div>
    </div>
    <nav class="site-nav" role="navigation" aria-label="Main">
      <button id="nav-home" class="nav-btn">Home</button>
      <button id="nav-changes" class="nav-btn">Changes</button>
      <button id="nav-contact" class="nav-btn">Contact</button>
    </nav>
  </header>

  <main id="app-container" role="main"></main>

  <div id="lobby-card-preview" aria-hidden="true"><img id="preview-img" alt="Commander Preview"></div>
  <div id="chat-card-preview" aria-hidden="true"><img id="chat-preview-img" alt="Card Preview"><div class="card-title" id="chat-preview-title"></div></div>
  <p id="status-message" class="muted">Initializing...</p>

  <div id="card-search-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 style="margin-top:0">Card Search (Scryfall)</h3>
      <input type="text" id="modal-card-name" placeholder="Enter card name" autocomplete="off">
      <div id="modal-suggestions-list" class="suggestions-list"></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="modal-search-btn" class="btn-primary">Search & Post</button>
        <button id="modal-close-btn" class="btn-secondary">Close</button>
      </div>
      <div id="search-results" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="edit-commander-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 style="margin-top:0">Edit Commander</h3>
      <input type="text" id="edit-commander-name" placeholder="Commander name">
      <div id="edit-commander-suggestions" class="suggestions-list"></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="edit-commander-save" class="btn-primary">Save</button>
        <button id="edit-commander-cancel" class="btn-secondary">Cancel</button>
      </div>
      <div id="edit-commander-result" style="margin-top:12px"></div>
    </div>
  </div>

  <script type="module">
    // ---------------- CONFIG ----------------
    const USER_FIREBASE_CONFIG = {
      apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E",
      authDomain: "mtg-life-tool.firebaseapp.com",
      projectId: "mtg-life-tool",
      storageBucket: "mtg-life-tool.appspot.com",
      messagingSenderId: "36730058988",
      appId: "1:36730058988:web:757e2d9620593b4f65022a"
    };
    const TIMEOUT_MINUTES = 20;
    const SCRYFALL_API = "https://api.scryfall.com/cards/named?exact=";
    const SCRYFALL_AUTOCOMPLETE_API = "https://api.scryfall.com/cards/autocomplete?q=";
    const AUTOCOMPLETE_DEBOUNCE_MS = 100;
    const ROOM_COLLECTION = "mtg_rooms";
    const DELETE_ALL_PWD = "DeleteAllRooms";

    // ---------------- IMPORTS ----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp,
      arrayUnion, deleteDoc, collection, getDocs, query, limit, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------------- INIT ----------------
    const app = initializeApp(USER_FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userId = null, roomId = null, unsubscribe = null, autocompleteTimeout = null;
    const openCmdControls = new Set();

    // ---------------- HELPERS ----------------
    const $ = id => document.getElementById(id);
    const hashPassword = p => CryptoJS.SHA256(p||"").toString(CryptoJS.enc.Hex);
    const getStartingLife = () => 40;
    const now = () => Date.now();

    async function validateCommander(name){
      if(!name) return null;
      try{
        const r = await fetch(`${SCRYFALL_API}${encodeURIComponent(name)}`);
        const d = await r.json();
        if(r.ok){
          const imageUrl = d.image_uris?.normal || d.card_faces?.[0]?.image_uris?.normal;
          if(imageUrl) return { validatedName: d.name, imageUrl };
        }
      }catch(e){ console.error("Scryfall validation error:", e); }
      return null;
    }

    async function fetchAutocompleteSuggestions(q, listId, inputId){
      const list = $(listId), input = $(inputId);
      if(!list || !input) return;
      list.innerHTML = '';
      if((q||'').length < 2) return;
      try{
        const r = await fetch(`${SCRYFALL_AUTOCOMPLETE_API}${encodeURIComponent(q)}`);
        const d = await r.json();
        if(r.ok && d.data?.length){
          d.data.slice(0,5).forEach(s=>{
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = s;
            item.onclick = ()=>{ input.value = s; list.innerHTML = ''; };
            list.appendChild(item);
          });
        }
      }catch(e){ console.error("Autocomplete error:", e); }
    }

    function computeOutgoingCmdDamage(roomData, sourcePlayerId){
      const players = roomData.players || {};
      const order = Array.isArray(roomData.playersOrder) && roomData.playersOrder.length ? roomData.playersOrder : Object.keys(players||{});
      return order.filter(pid=>pid!==sourcePlayerId).map(pid=>({
        oppId: pid,
        oppName: players[pid]?.name || 'Player',
        dmg: (players[sourcePlayerId]?.commanderDamage || {})[pid] || 0
      }));
    }
    function computeOutgoingTotal(roomData, sourcePlayerId){
      const dmgMap = (roomData.players?.[sourcePlayerId]?.commanderDamage) || {};
      return Object.keys(dmgMap).reduce((s,k)=> s + (parseInt(dmgMap[k])||0), 0);
    }
    function computeIncomingCmdDamage(roomData, targetPlayerId){
      let total = 0;
      const players = roomData.players || {};
      Object.keys(players).forEach(pid=>{
        total += (players[pid]?.commanderDamage || {})[targetPlayerId] || 0;
      });
      return total;
    }

    // ---------------- NAV & ROUTES ----------------
    const navButtons = { home: $('nav-home'), changes: $('nav-changes'), contact: $('nav-contact') };
    function setActiveNav(page){ Object.values(navButtons).forEach(b=>b.classList.remove('active')); if(navButtons[page]) navButtons[page].classList.add('active'); }
    function navigateTo(page){ if(location.hash !== `#${page}`) history.pushState(null,'',`#${page}`); setActiveNav(page); if(page === 'home') renderSetupView(); else if(page === 'changes') renderChanges(); else renderContact(); }
    Object.entries(navButtons).forEach(([k,btn])=>btn.addEventListener('click', ()=>navigateTo(k)));
    window.addEventListener('popstate', ()=>{ const page = (location.hash || '#home').replace('#','') || 'home'; setActiveNav(page); if(page === 'home') renderSetupView(); else if(page === 'changes') renderChanges(); else renderContact(); });

    const CHANGELOG = [
      { version: "0.9.8", date: "2025-12-08", notes: "Show CMD labels, persist lobby on refresh, 20-minute timeout based on life changes, lobby timestamps." },
      { version: "0.9.7", date: "2025-12-07", notes: "Show CMD DMG to/from on each panel; incoming editor updates opponent's outgoing." }
    ];

    function renderChanges(){
      const app = $('app-container');
      app.innerHTML = `<h2 style="margin-top:0;color:var(--text)">Changes</h2><div style="display:flex;flex-direction:column;gap:12px">${CHANGELOG.map(e=>`<div style="background:#121416;padding:12px;border-radius:8px;border:1px solid var(--dark-border)"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700;color:var(--text)">${e.version}</div><div class="muted">${e.date}</div></div><div style="margin-top:8px;color:var(--text)">${e.notes}</div></div>`).join('')}</div>`;
    }

    function renderContact(){
      const app = $('app-container');
      app.innerHTML = `
        <h2 style="margin-top:0;color:var(--text)">Contact</h2>
        <p class="muted">To contact me, please use your email client. Click the button below to open a new message addressed to <strong>CardboardBonfire@gmail.com</strong>.</p>
        <div style="max-width:640px">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="contact-mailto" class="btn-primary">Email CardboardBonfire@gmail.com</button>
            <button id="contact-copy" class="btn-secondary">Copy Email</button>
          </div>
          <p id="contact-status" class="muted" style="margin-top:8px"></p>
        </div>
      `;
      $('contact-mailto').addEventListener('click', ()=>{ const subject = encodeURIComponent("Contact from MTG Life Tracker"); const body = encodeURIComponent("Hi,\n\nI'd like to get in touch regarding..."); window.location.href = `mailto:CardboardBonfire@gmail.com?subject=${subject}&body=${body}`; });
      $('contact-copy').addEventListener('click', async ()=>{ const status = $('contact-status'); try{ await navigator.clipboard.writeText('CardboardBonfire@gmail.com'); status.textContent = 'Email address copied to clipboard.'; } catch(e){ console.error(e); status.textContent = 'Unable to copy automatically — please copy: CardboardBonfire@gmail.com'; } });
    }

    // ---------------- SETUP VIEW ----------------
    function formatTimeLeft(minutesLeft){
      if(minutesLeft <= 0) return 'closing soon';
      if(minutesLeft < 60) return `${Math.ceil(minutesLeft)}m left`;
      const hrs = Math.floor(minutesLeft/60);
      const mins = Math.ceil(minutesLeft%60);
      return `${hrs}h ${mins}m left`;
    }

    async function renderSetupView(){
      roomId = null;
      $('lobby-card-preview').style.display = 'none';
      $('card-search-modal').style.display = 'none';
      $('status-message').textContent = "Browse rooms or create a new one.";
      $('status-message').style.color = "#9aa3ad";

      const app = $('app-container');
      app.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
          <div style="flex:1"><input type="text" id="search-input" placeholder="Enter Room ID to Create/Search"></div>
          <div style="width:160px"><button id="search-btn" class="btn-primary" style="width:100%">Find or Create Room</button></div>
        </div>
        <h3 style="color:var(--text);margin-top:0">Active Rooms</h3>
        <div id="room-list-container"><p style="color:var(--text)">Loading active rooms...</p></div>
        <div style="margin-top:12px"><button id="delete-all-rooms-btn" class="btn-danger">Delete All Rooms (Admin)</button></div>
      `;

      try{
        const q = query(collection(db, ROOM_COLLECTION), limit(30));
        const snap = await getDocs(q);
        const list = $('room-list-container');
        if(snap.empty) list.innerHTML = '<p style="color:var(--text)">No active rooms. Create one above!</p>';
        else{
          list.innerHTML = '';
          snap.forEach(docSnap=>{
            const rData = docSnap.data();
            const rId = docSnap.id;
            const pCount = Object.keys(rData.players || {}).length;
            const ownerPlayer = rData.players?.[rData.ownerId] || {};
            const ownerCmdName = ownerPlayer?.commanderName || ownerPlayer?.commander || 'N/A';
            let createdAtDate = null;
            if(rData.createdAt){
              if(typeof rData.createdAt.toDate === 'function') createdAtDate = rData.createdAt.toDate();
              else createdAtDate = new Date(rData.createdAt);
            }
            let baselineDate = null;
            if(rData.lastLifeChange){
              if(typeof rData.lastLifeChange.toDate === 'function') baselineDate = rData.lastLifeChange.toDate();
              else baselineDate = new Date(rData.lastLifeChange);
            } else baselineDate = createdAtDate;
            let timeLeftText = 'N/A';
            if(baselineDate){
              const elapsedMinutes = (Date.now() - baselineDate.getTime()) / (1000*60);
              const minutesLeft = Math.max(0, TIMEOUT_MINUTES - elapsedMinutes);
              timeLeftText = formatTimeLeft(minutesLeft);
            }

            const item = document.createElement('div');
            item.className = 'room-item';
            item.style.cssText = "display:flex;justify-content:space-between;align-items:center;background-color:#121416;padding:12px;margin-bottom:8px;border-radius:8px;border:1px solid var(--dark-border)";
            item.innerHTML = `
              <div class="room-info" style="flex:1">
                <div style="display:flex;align-items:center;gap:12px">
                  <div style="font-weight:800;color:var(--text);min-width:160px">${rId}</div>
                  <div style="font-size:.9em;color:var(--muted)">${pCount} Player(s) • Owner: ${ownerPlayer?.name || 'Owner'}</div>
                </div>
                <div style="font-size:.85em;color:var(--muted);margin-top:6px;display:flex;gap:12px;align-items:center">
                  <div>Commander: <strong style="color:var(--text)">${ownerCmdName}</strong></div>
                  <div>Created: <strong style="color:var(--text)">${createdAtDate ? createdAtDate.toLocaleString() : 'N/A'}</strong></div>
                  <div>Expires: <strong style="color:var(--text)">${timeLeftText}</strong></div>
                </div>
              </div>
              <div style="margin-left:12px"><button class="join-btn btn-secondary" data-rid="${rId}" style="width:auto">Join</button></div>
            `;
            list.appendChild(item);
          });
        }
      }catch(e){
        console.error("List error:",e);
        $('room-list-container').innerHTML = `<p style="color:#ff5555">Error loading rooms. Permissions might be initializing...</p>`;
      }

      $('search-btn').onclick = async ()=>{
        const val = ($('search-input').value||'').trim().toLowerCase();
        if(!val) return;
        const snap = await getDoc(doc(db, ROOM_COLLECTION, val));
        if(snap.exists()) promptPassword(val,'join'); else promptPassword(val,'create');
      };
      $('delete-all-rooms-btn').addEventListener('click', deleteAllRooms);
      document.querySelectorAll('.join-btn').forEach(btn=>btn.addEventListener('click', (e)=> promptPassword(e.target.dataset.rid, 'join')));
    }

    // ---------------- ROOM VIEW & CHAT ----------------
    function renderChat(chatLog, playerName){
      const chatLogDiv = $('chat-log');
      if(!chatLogDiv) return;
      chatLogDiv.innerHTML = '';
      (chatLog || []).slice(-500).forEach(msg=>{
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';
        const senderSpan = document.createElement('span');
        senderSpan.className = 'chat-sender';
        if(msg.senderName === 'System'){ senderSpan.classList.add('system'); senderSpan.textContent = 'System:'; }
        else senderSpan.textContent = `${msg.senderName}:`;
        messageDiv.appendChild(senderSpan);
        if(msg.cardImageUrl){
          const cardSpan = document.createElement('span');
          cardSpan.className = 'chat-card';
          cardSpan.textContent = ` ${msg.message} `;
          cardSpan.dataset.cardImageUrl = msg.cardImageUrl;
          cardSpan.dataset.cardName = msg.message;
          cardSpan.addEventListener('mouseenter', ()=>{ showChatCardPreview(cardSpan.dataset.cardImageUrl, cardSpan.dataset.cardName); });
          cardSpan.addEventListener('mouseleave', ()=>{ hideChatCardPreviewWithDelay(); });
          cardSpan.addEventListener('click', ()=>{ const preview = $('chat-card-preview'); if(preview.style.display === 'block') hideChatCardPreviewImmediate(); else showChatCardPreview(cardSpan.dataset.cardImageUrl, cardSpan.dataset.cardName); });
          messageDiv.appendChild(cardSpan);
        } else {
          messageDiv.appendChild(document.createTextNode(' ' + msg.message));
        }
        chatLogDiv.appendChild(messageDiv);
      });
      chatLogDiv.scrollTop = chatLogDiv.scrollHeight;
    }

    let chatPreviewHideTimer = null;
    function showChatCardPreview(imageUrl, title){
      if(chatPreviewHideTimer){ clearTimeout(chatPreviewHideTimer); chatPreviewHideTimer = null; }
      const preview = $('chat-card-preview'), img = $('chat-preview-img'), t = $('chat-preview-title');
      img.src = imageUrl; t.textContent = title; preview.style.display = 'block';
    }
    function hideChatCardPreviewWithDelay(){ if(chatPreviewHideTimer) clearTimeout(chatPreviewHideTimer); chatPreviewHideTimer = setTimeout(()=>{ hideChatCardPreviewImmediate(); }, 300); }
    function hideChatCardPreviewImmediate(){ const preview = $('chat-card-preview'); const img = $('chat-preview-img'); const t = $('chat-preview-title'); preview.style.display = 'none'; img.src = ''; t.textContent = ''; if(chatPreviewHideTimer){ clearTimeout(chatPreviewHideTimer); chatPreviewHideTimer = null; } }

    function renderRoomView(roomData){
      const app = $('app-container');
      if(!roomData){ renderSetupView(); return; }
      const players = roomData.players || {};
      const order = Array.isArray(roomData.playersOrder) && roomData.playersOrder.length ? roomData.playersOrder : Object.keys(players || {});
      const meId = userId;
      const meName = players[meId]?.name || 'You';

      // build players grid
      let html = `<div style="display:flex;justify-content:space-between;align-items:center;gap:12px"><div><h2 style="margin:0;color:var(--text)">${roomId}</h2><div class="muted">Owner: ${players[roomData.ownerId]?.name||'N/A'}</div></div><div id="room-actions" class="row"><button id="open-card-search" class="btn-secondary small-btn">Post Card</button><button id="edit-commander" class="btn-secondary small-btn">Edit Commander</button><button id="leave-room" class="btn-secondary small-btn">Leave</button></div></div>`;
      html += `<div class="player-grid">`;
      order.forEach(pid=>{
        const p = players[pid] || {};
        const isMe = pid === meId;
        const life = p.life ?? getStartingLife();
        const cmdName = p.commanderName || p.commander || '';
        const cmdImg = p.commanderImageUrl || '';
        const incoming = computeIncomingCmdDamage(roomData, pid);
        const outgoingTotal = computeOutgoingTotal(roomData, pid);
        html += `
          <div class="player-panel" data-pid="${pid}">
            <div class="player-header">
              <div>
                <div class="player-name">${p.name||'Player'}</div>
                <div class="player-sub">${cmdName ? `Commander: ${cmdName}` : ''}</div>
              </div>
              <div style="text-align:right">
                ${isMe ? '<div class="you-badge">YOU</div>' : ''}
                <div class="player-sub muted">Incoming: <strong style="color:var(--text)">${incoming}</strong></div>
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="life-big">${life}</div>
              <div class="controls">
                <button class="control-btn positive" data-action="+5" data-pid="${pid}">+5</button>
                <button class="control-btn positive" data-action="+1" data-pid="${pid}">+1</button>
                <button class="control-btn negative" data-action="-1" data-pid="${pid}">-1</button>
                <button class="control-btn negative" data-action="-5" data-pid="${pid}">-5</button>
              </div>
            </div>
            <div class="cmd-block">
              <div class="cmd-label">CMD DMG to others</div>
              <div class="cmd-value">${outgoingTotal}</div>
            </div>
            <div class="per-opp-container">
              ${computeOutgoingCmdDamage(roomData, pid).map(o=>`<div class="per-opp-row"><div class="per-opp-left">${o.oppName}</div><div class="per-opp-controls"><div style="font-weight:800">${o.dmg}</div></div></div>`).join('')}
            </div>
          </div>`;
      });
      html += `</div>`; // player-grid

      // chat
      html += `
        <div id="chat-container" style="width:100%;margin-top:18px">
          <h3 style="margin-top:0;color:var(--text)">Chat</h3>
          <div id="chat-log"></div>
          <div id="chat-controls" style="display:flex;gap:8px;align-items:center">
            <input id="chat-input" placeholder="Say something..." style="flex:1">
            <button id="chat-send" class="btn-primary">Send</button>
          </div>
        </div>
        <div id="room-footer"><div class="muted">Room active</div><div class="muted">Expires after inactivity</div></div>
      `;
      app.innerHTML = html;

      // attach commander preview hover
      document.querySelectorAll('.player-panel').forEach(panel=>{
        const pid = panel.dataset.pid;
        const img = players[pid]?.commanderImageUrl;
        const sub = panel.querySelector('.player-sub');
        if(img && sub){
          sub.addEventListener('mouseenter', ()=>{ $('preview-img').src = img; $('lobby-card-preview').style.display = 'block'; });
          sub.addEventListener('mouseleave', ()=>{ $('lobby-card-preview').style.display = 'none'; $('preview-img').src = ''; });
        }
      });

      // life controls
      document.querySelectorAll('.control-btn').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const pid = e.currentTarget.dataset.pid, action = e.currentTarget.dataset.action;
          await applyLifeChange(pid, action);
        });
      });

      // room actions
      $('open-card-search').addEventListener('click', ()=>{ $('card-search-modal').style.display = 'flex'; $('card-search-modal').setAttribute('aria-hidden','false'); });
      $('edit-commander').addEventListener('click', ()=>{ $('edit-commander-modal').style.display = 'flex'; $('edit-commander-modal').setAttribute('aria-hidden','false'); });
      $('leave-room').addEventListener('click', leaveRoom);
      $('chat-send').addEventListener('click', sendChat);
      $('chat-input').addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter') sendChat(); });

      renderChat(roomData.chat || [], meName);
    }

    // ---------------- ROOM ACTIONS ----------------
    async function applyLifeChange(pid, action){
      if(!roomId) return;
      const delta = parseInt(action.replace('+','')) * (action.startsWith('-') ? -1 : 1);
      const ref = doc(db, ROOM_COLLECTION, roomId);
      try{
        const snap = await getDoc(ref);
        if(!snap.exists()) return;
        const data = snap.data();
        const players = data.players || {};
        players[pid] = players[pid] || { name: 'Player', life: getStartingLife() };
        players[pid].life = (parseInt(players[pid].life)||getStartingLife()) + delta;
        await updateDoc(ref, { players, lastLifeChange: serverTimestamp() });
      }catch(e){ console.error("life change error", e); }
    }

    async function sendChat(){
      const input = $('chat-input');
      const text = (input.value||'').trim();
      if(!text || !roomId) return;
      const ref = doc(db, ROOM_COLLECTION, roomId);
      try{
        const snap = await getDoc(ref);
        if(!snap.exists()) return;
        const data = snap.data();
        let cardImage = null;
        try{
          const r = await fetch(`${SCRYFALL_API}${encodeURIComponent(text)}`);
          const d = await r.json();
          if(r.ok) cardImage = d.image_uris?.normal || d.card_faces?.[0]?.image_uris?.normal || null;
        }catch(e){}
        const chat = data.chat || [];
        chat.push({ senderId: userId, senderName: data.players?.[userId]?.name || 'You', message: text, cardImageUrl: cardImage, ts: serverTimestamp() });
        await updateDoc(ref, { chat });
        input.value = '';
      }catch(e){ console.error("chat send error", e); }
    }

    // ---------------- JOIN / CREATE / LEAVE ----------------
    async function promptPassword(rid, mode){
      const pwd = prompt(`${mode==='create' ? 'Create' : 'Join'} room "${rid}". Enter a password (optional):`);
      if(pwd === null) return;
      if(mode === 'create') await createRoom(rid, pwd); else await joinRoom(rid, pwd);
    }

    async function createRoom(rid, pwd){
      try{
        const ref = doc(db, ROOM_COLLECTION, rid);
        const snap = await getDoc(ref);
        if(snap.exists()){ alert('Room already exists.'); return; }
        const ownerId = userId || `anon_${Math.random().toString(36).slice(2,8)}`;
        const players = {};
        players[ownerId] = { name: 'Host', life: getStartingLife(), commanderName: '', commanderImageUrl: '' };
        await setDoc(ref, { ownerId, players, playersOrder: [ownerId], createdAt: serverTimestamp(), lastLifeChange: serverTimestamp(), passwordHash: pwd ? hashPassword(pwd) : null, chat: [] });
        await joinRoom(rid, pwd);
      }catch(e){ console.error("create room error", e); }
    }

    async function joinRoom(rid, pwd){
      try{
        const ref = doc(db, ROOM_COLLECTION, rid);
        const snap = await getDoc(ref);
        if(!snap.exists()){ alert('Room not found'); return; }
        const data = snap.data();
        if(data.passwordHash && data.passwordHash !== hashPassword(pwd||'')){ alert('Incorrect password'); return; }
        const pid = userId || `anon_${Math.random().toString(36).slice(2,8)}`;
        const players = data.players || {};
        if(!players[pid]) players[pid] = { name: `Player ${Object.keys(players).length+1}`, life: getStartingLife(), commanderName: '', commanderImageUrl: '' };
        const order = Array.isArray(data.playersOrder) ? [...new Set([...(data.playersOrder||[]), pid])] : Object.keys(players);
        await updateDoc(ref, { players, playersOrder: order, lastLifeChange: serverTimestamp() });
        enterRoom(rid);
      }catch(e){ console.error("join room error", e); }
    }

    function enterRoom(rid){
      if(unsubscribe) unsubscribe();
      roomId = rid;
      const ref = doc(db, ROOM_COLLECTION, rid);
      unsubscribe = onSnapshot(ref, snap=>{
        if(!snap.exists()){ alert('Room closed'); if(unsubscribe){ unsubscribe(); unsubscribe = null; } renderSetupView(); return; }
        renderRoomView(snap.data());
      });
      history.pushState(null,'',`#room-${rid}`);
      $('status-message').textContent = `In room ${rid}`;
    }

    function leaveRoom(){
      if(unsubscribe){ unsubscribe(); unsubscribe = null; }
      roomId = null;
      renderSetupView();
    }

    // ---------------- ADMIN ----------------
    async function deleteAllRooms(){
      if(!confirm('Delete all rooms? This is irreversible.')) return;
      try{
        const q = query(collection(db, ROOM_COLLECTION), limit(200));
        const snap = await getDocs(q);
        const ops = [];
        snap.forEach(s => ops.push(deleteDoc(doc(db, ROOM_COLLECTION, s.id))));
        await Promise.all(ops);
        alert('Deleted rooms (up to 200).');
        renderSetupView();
      }catch(e){ console.error("delete all error", e); alert('Error deleting rooms'); }
    }

    // ---------------- MODALS & AUTOCOMPLETE ----------------
    $('modal-close-btn').addEventListener('click', ()=>{ $('card-search-modal').style.display = 'none'; $('card-search-modal').setAttribute('aria-hidden','true'); });
    $('modal-search-btn').addEventListener('click', async ()=>{
      const name = ($('modal-card-name').value||'').trim();
      if(!name) return;
      const v = await validateCommander(name);
      if(!v){ $('search-results').textContent = 'Card not found.'; return; }
      if(!roomId){ alert('Join a room first.'); return; }
      const ref = doc(db, ROOM_COLLECTION, roomId);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const data = snap.data();
      const chat = data.chat || [];
      chat.push({ senderId: userId, senderName: data.players?.[userId]?.name || 'You', message: v.validatedName, cardImageUrl: v.imageUrl, ts: serverTimestamp() });
      await updateDoc(ref, { chat });
      $('card-search-modal').style.display = 'none';
      $('modal-card-name').value = '';
      $('modal-suggestions-list').innerHTML = '';
    });

    $('modal-card-name').addEventListener('input', (e)=>{
      clearTimeout(autocompleteTimeout);
      autocompleteTimeout = setTimeout(()=> fetchAutocompleteSuggestions(e.target.value, 'modal-suggestions-list', 'modal-card-name'), AUTOCOMPLETE_DEBOUNCE_MS);
    });

    $('edit-commander-cancel').addEventListener('click', ()=>{ $('edit-commander-modal').style.display = 'none'; $('edit-commander-modal').setAttribute('aria-hidden','true'); });
    $('edit-commander-save').addEventListener('click', async ()=>{
      const name = ($('edit-commander-name').value||'').trim();
      if(!name || !roomId) return;
      const v = await validateCommander(name);
      if(!v){ $('edit-commander-result').textContent = 'Commander not found.'; return; }
      const ref = doc(db, ROOM_COLLECTION, roomId);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const data = snap.data();
      const players = data.players || {};
      if(players[userId]){ players[userId].commanderName = v.validatedName; players[userId].commanderImageUrl = v.imageUrl; await updateDoc(ref, { players }); }
      $('edit-commander-modal').style.display = 'none';
      $('edit-commander-name').value = '';
      $('edit-commander-result').textContent = '';
    });

    // ---------------- CHAT PREVIEW ----------------
    let chatPreviewTimer = null;
    function showChatCardPreview(imageUrl, title){
      if(chatPreviewTimer){ clearTimeout(chatPreviewTimer); chatPreviewTimer = null; }
      $('chat-preview-img').src = imageUrl; $('chat-preview-title').textContent = title; $('chat-card-preview').style.display = 'block';
    }
    function hideChatCardPreviewWithDelay(){ if(chatPreviewTimer) clearTimeout(chatPreviewTimer); chatPreviewTimer = setTimeout(()=>{ hideChatCardPreviewImmediate(); }, 300); }
    function hideChatCardPreviewImmediate(){ $('chat-card-preview').style.display = 'none'; $('chat-preview-img').src = ''; $('chat-preview-title').textContent = ''; if(chatPreviewTimer){ clearTimeout(chatPreviewTimer); chatPreviewTimer = null; } }

    // ---------------- AUTH ----------------
    onAuthStateChanged(auth, user=>{
      if(user){ userId = user.uid; $('status-message').textContent = 'Signed in'; const page = (location.hash||'#home').replace('#','') || 'home'; if(page.startsWith('room-')) enterRoom(page.replace('room-','')); else navigateTo(page); }
      else signInAnonymously(auth).catch(e=>console.error(e));
    });
    signInAnonymously(auth).catch(()=>{ /* ignore */ });

    // ---------------- BOOT ----------------
    navigateTo((location.hash||'#home').replace('#','') || 'home');
  </script>
</body>
</html>
