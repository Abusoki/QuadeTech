<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MTG Life Tracker</title>
    <style>
        /* --- DARK MODE BASE STYLES --- */
        :root {
            --bg: #0f1113;
            --card: #16181a;
            --muted: #9aa3ad;
            --text: #e6eef6;
            --accent: #2980b9;
            --accent-strong: #1f6fa8;
            --green: #27ae60;
            --red: #c0392b;
            --dark-border: #22272a;
            --input-bg: #1f2326;
            --panel-bg: #111315;
            --panel-elev: rgba(255,255,255,0.02);
        }

        html,body { height:100%; margin:0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display:flex;
            flex-direction:column;
            align-items:center;
            padding:20px;
            background-color:var(--bg);
            color:var(--text);
            min-height:100vh;
            box-sizing:border-box;
        }

        /* --- Top Navigation (persistent) --- */
        header.app-header {
            width:100%;
            max-width:1100px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:18px;
            gap:12px;
        }
        .brand { display:flex; flex-direction:column; gap:2px; }
        .brand .app-title { color:var(--text); margin:0; font-size:1.25rem; line-height:1; }
        .brand .app-subtitle { color:var(--muted); margin:0; font-size:0.8rem; font-style:italic; }

        nav.site-nav { display:flex; gap:8px; align-items:center; }
        nav.site-nav button {
            background:transparent;
            color:var(--text);
            border:1px solid transparent;
            padding:8px 12px;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
        }
        nav.site-nav button.active {
            background: rgba(41,128,185,0.10);
            border-color: var(--accent);
        }

        /* --- Main container --- */
        #app-container {
            width:100%;
            max-width:1100px;
            background-color:var(--card);
            padding:20px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.6);
            border-radius:12px;
            position:relative;
            box-sizing:border-box;
        }

        /* --- Form elements --- */
        input, textarea, select {
            width:100%;
            padding:12px;
            margin-bottom:10px;
            border:1px solid var(--dark-border);
            border-radius:8px;
            box-sizing:border-box;
            background-color:var(--input-bg);
            color:var(--text);
            font-size:1rem;
        }
        textarea { min-height:120px; resize:vertical; }

        /* Remove platform-specific appearance and tap highlight */
        input, button, textarea, select {
            -webkit-appearance:none;
            appearance:none;
            -webkit-tap-highlight-color:transparent;
        }

        /* Hard-disable outlines */
        *:focus, *:focus-visible, *:focus-within {
            outline:none !important;
            box-shadow:none !important;
            -webkit-box-shadow:none !important;
        }
        input:focus, button:focus, textarea:focus { border-color:var(--dark-border) !important; background-color:inherit !important; }

        /* Buttons */
        button {
            cursor:pointer;
            border:none;
            border-radius:8px;
            font-weight:700;
            transition: transform 0.08s ease, opacity 0.12s ease;
            padding:10px 12px;
            color:var(--text);
            background:var(--accent);
        }
        button:active, .tapped { transform:scale(0.96); }
        .btn-primary { background: linear-gradient(180deg,var(--green), #1f8a4a); color:white; }
        .btn-danger { background: linear-gradient(180deg,var(--red), #9b2b24); color:white; }
        .btn-secondary { background: linear-gradient(180deg,#3a3a3a,#2f2f2f); color:white; }

        /* --- Player grid / panels (new stylized room view) --- */
        .player-grid {
            display:grid;
            grid-template-columns: repeat(2, 1fr);
            gap:16px;
            margin-top:12px;
        }
        @media (max-width:900px) {
            .player-grid { grid-template-columns: repeat(1, 1fr); }
        }

        .player-panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
            border:1px solid var(--dark-border);
            border-radius:12px;
            padding:14px;
            display:flex;
            flex-direction:column;
            gap:10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
            position:relative;
        }

        .player-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:8px;
        }
        .player-name {
            font-weight:800;
            font-size:1rem;
            color:var(--text);
        }
        .player-sub {
            font-size:0.85rem;
            color:var(--muted);
        }

        .life-big {
            font-size:3.2rem;
            font-weight:900;
            color:var(--text);
            letter-spacing: -1px;
        }

        .panel-row {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
        }

        .controls {
            display:flex;
            gap:8px;
            flex-wrap:wrap;
        }

        .control-btn {
            padding:8px 12px;
            border-radius:8px;
            font-weight:800;
            min-width:56px;
            text-align:center;
            cursor:pointer;
            border:1px solid rgba(255,255,255,0.03);
            background: linear-gradient(180deg,#2b2b2b,#232323);
            color:var(--text);
        }
        .control-btn.positive { background: linear-gradient(180deg,#2ecc71,#27ae60); color:#04260a; }
        .control-btn.negative { background: linear-gradient(180deg,#ff6b6b,#c0392b); color:#2b0706; }
        .control-btn:disabled { opacity:0.45; cursor:not-allowed; filter:grayscale(0.2); }

        .cmd-block {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:8px;
            background: rgba(255,255,255,0.02);
            padding:8px;
            border-radius:8px;
            border:1px solid rgba(255,255,255,0.02);
        }
        .cmd-label { font-size:0.9rem; color:var(--muted); }
        .cmd-value { font-weight:800; color:#ffb3b3; }

        /* small badge for YOU */
        .you-badge {
            background: linear-gradient(90deg,var(--accent),var(--accent-strong));
            color:white;
            padding:6px 8px;
            border-radius:999px;
            font-weight:800;
            font-size:0.8rem;
        }

        /* room tools and footer */
        #lobby-features { margin-top:18px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        #room-footer { margin-top:14px; color:var(--muted); font-size:0.9rem; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }

        /* suggestions list (keeps previous fixes) */
        .suggestions-list {
            position:absolute;
            width:100%;
            background-color:var(--input-bg);
            border:1px solid var(--dark-border);
            border-top:none;
            max-height:150px;
            overflow-y:auto;
            z-index:100;
            border-radius:0 0 8px 8px;
            box-shadow:0 6px 18px rgba(0,0,0,0.6);
            margin-top:-10px;
        }
        .suggestions-list:empty { display:none !important; border:none !important; box-shadow:none !important; margin-top:0 !important; }
        .suggestion-item { padding:8px 12px; cursor:pointer; color:var(--text); }
        .suggestion-item:hover { background: rgba(41,128,185,0.08); }

        /* lobby preview fixed left */
        #lobby-card-preview {
            position:fixed;
            top:50%;
            left:20px;
            transform:translateY(-50%);
            width:260px;
            border:3px solid var(--accent);
            border-radius:10px;
            box-shadow:0 8px 30px rgba(0,0,0,0.8);
            z-index:999;
            display:none;
            background:#0b0d0f;
        }
        #lobby-card-preview img { display:block; width:100%; border-radius:6px; }

        /* chat */
        #chat-log { height:150px; overflow-y:auto; border:1px solid rgba(255,255,255,0.03); padding:10px; margin-bottom:10px; border-radius:8px; background:#0f1113; font-size:0.9em; }

        /* small helpers */
        .muted { color:var(--muted); }
        .row { display:flex; gap:8px; align-items:center; }
        .col { display:flex; flex-direction:column; gap:8px; }

        @media (max-width:720px) {
            header.app-header { flex-direction:column; align-items:flex-start; gap:8px; }
            #lobby-card-preview { display:none !important; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body>
    <!-- Persistent header with navigation -->
    <header class="app-header" role="banner">
        <div class="brand">
            <h1 class="app-title">Cardboard Bonfire</h1>
            <div class="app-subtitle">Life tracker for keeping life and bringing people together.</div>
        </div>

        <nav class="site-nav" role="navigation" aria-label="Main">
            <button id="nav-home" class="nav-btn">Home</button>
            <button id="nav-changes" class="nav-btn">Changes</button>
            <button id="nav-contact" class="nav-btn">Contact</button>
        </nav>
    </header>

    <main id="app-container" role="main"></main>

    <div id="lobby-card-preview" aria-hidden="true">
        <img id="preview-img" alt="Commander Preview">
    </div>

    <p id="status-message" class="muted">Initializing...</p>

    <!-- Card search modal (kept) -->
    <div id="card-search-modal" class="modal" style="display:none; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:#16181a; color:var(--text); padding:20px; border-radius:8px; width:90%; max-width:420px;">
            <h3>Card Search (Scryfall)</h3>
            <input type="text" id="modal-card-name" placeholder="Enter card name" autocomplete="off">
            <div id="modal-suggestions-list" class="suggestions-list"></div>
            <button id="modal-search-btn" class="btn-primary">Search</button>
            <div id="search-results"></div>
            <button id="modal-close-btn" class="btn-danger">Close</button>
        </div>
    </div>

    <script type="module">
        // ----------------------------------------------------------------------
        // 1. CONFIGURATION
        // ----------------------------------------------------------------------
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E",
            authDomain: "mtg-life-tool.firebaseapp.com",
            projectId: "mtg-life-tool",
            storageBucket: "mtg-life-tool.appspot.com",
            messagingSenderId: "36730058988",
            appId: "1:36730058988:web:757e2d9620593b4f65022a"
        };
        const SCRYFALL_API = "https://api.scryfall.com/cards/named?exact=";
        const SCRYFALL_AUTOCOMPLETE_API = "https://api.scryfall.com/cards/autocomplete?q=";
        const TIMEOUT_MINUTES = 25;
        const DELETE_ALL_PWD = "DeleteAllRooms";
        const AUTOCOMPLETE_DEBOUNCE_MS = 100;

        // ----------------------------------------------------------------------
        // 2. IMPORTS
        // ----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp,
            arrayUnion, deleteDoc, collection, getDocs, query, limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----------------------------------------------------------------------
        // 3. GLOBALS
        // ----------------------------------------------------------------------
        const app = initializeApp(USER_FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let roomId = null;
        let unsubscribe = null;
        let autocompleteTimeout = null;
        const ROOM_COLLECTION = "mtg_rooms";

        // ----------------------------------------------------------------------
        // 4. HELPERS
        // ----------------------------------------------------------------------
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
        }

        async function checkAndDeleteIfExpired(id, roomData) {
            const lastActive = roomData.lastActive?.toDate?.();
            if (lastActive) {
                const elapsed = (new Date() - lastActive) / (1000 * 60);
                if (elapsed > TIMEOUT_MINUTES) {
                    try { await deleteDoc(doc(db, ROOM_COLLECTION, id)); } catch (e) {}
                    return true;
                }
            }
            return false;
        }

        function getStartingLife() { return 40; }

        async function validateCommander(name) {
            if (!name) return null;
            try {
                const response = await fetch(`${SCRYFALL_API}${encodeURIComponent(name)}`);
                const data = await response.json();
                if (response.ok) {
                    const imageUrl = data.image_uris?.normal || data.card_faces?.[0]?.image_uris?.normal;
                    if (imageUrl) return { validatedName: data.name, imageUrl };
                }
                return null;
            } catch (e) {
                console.error("Scryfall validation error:", e);
                return null;
            }
        }

        async function fetchAutocompleteSuggestions(query, listId, inputId) {
            const suggestionsList = document.getElementById(listId);
            const inputField = document.getElementById(inputId);
            if (!suggestionsList || !inputField) return;
            suggestionsList.innerHTML = '';
            if (query.length < 2) return;
            try {
                const response = await fetch(`${SCRYFALL_AUTOCOMPLETE_API}${encodeURIComponent(query)}`);
                const data = await response.json();
                if (response.ok && data.data && data.data.length > 0) {
                    data.data.slice(0, 5).forEach(suggestion => {
                        const item = document.createElement('div');
                        item.classList.add('suggestion-item');
                        item.textContent = suggestion;
                        item.onclick = () => {
                            inputField.value = suggestion;
                            suggestionsList.innerHTML = '';
                        };
                        suggestionsList.appendChild(item);
                    });
                }
            } catch (e) { console.error("Autocomplete error:", e); }
        }

        // ----------------------------------------------------------------------
        // 5. ROUTING & PAGES
        // ----------------------------------------------------------------------
        const navButtons = {
            home: document.getElementById('nav-home'),
            changes: document.getElementById('nav-changes'),
            contact: document.getElementById('nav-contact')
        };

        function setActiveNav(page) {
            Object.values(navButtons).forEach(btn => btn.classList.remove('active'));
            if (navButtons[page]) navButtons[page].classList.add('active');
        }

        function navigateTo(page) {
            if (location.hash !== `#${page}`) history.pushState(null, '', `#${page}`);
            setActiveNav(page);
            if (page === 'home') renderHome();
            else if (page === 'changes') renderChanges();
            else if (page === 'contact') renderContact();
        }

        // Attach nav listeners
        navButtons.home.addEventListener('click', () => navigateTo('home'));
        navButtons.changes.addEventListener('click', () => navigateTo('changes'));
        navButtons.contact.addEventListener('click', () => navigateTo('contact'));

        // On back/forward navigation
        window.addEventListener('popstate', () => {
            const page = (location.hash || '#home').replace('#', '') || 'home';
            setActiveNav(page);
            if (page === 'home') renderHome();
            else if (page === 'changes') renderChanges();
            else if (page === 'contact') renderContact();
        });

        // --- Page: Home (keeps your existing setup view) ---
        async function renderHome() { await renderSetupView(); }

        // --- Page: Changes (simple changelog viewer) ---
        const CHANGELOG = [
            { version: "0.9.2", date: "2025-11-30", notes: "Fixed hover preview and removed stray focus outlines; improved suggestions styling." },
            { version: "0.9.0", date: "2025-10-12", notes: "Initial public beta: room creation, chat, commander validation via Scryfall." }
        ];

        function renderChanges() {
            const appContainer = document.getElementById('app-container');
            let html = `<h2 style="margin-top:0; color:var(--text);">Changes</h2>`;
            html += `<div style="display:flex; flex-direction:column; gap:12px;">`;
            CHANGELOG.forEach(entry => {
                html += `
                    <div style="background:#121416; padding:12px; border-radius:8px; border:1px solid var(--dark-border);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="font-weight:700; color:var(--text);">${entry.version}</div>
                            <div class="muted">${entry.date}</div>
                        </div>
                        <div style="margin-top:8px; color:var(--text);">${entry.notes}</div>
                    </div>
                `;
            });
            html += `</div>`;
            appContainer.innerHTML = html;
        }

        // --- Page: Contact (EMAIL ONLY) ---
        function renderContact() {
            const appContainer = document.getElementById('app-container');
            appContainer.innerHTML = `
                <h2 style="margin-top:0; color:var(--text);">Contact</h2>
                <p class="muted">To contact me, please use your email client. Click the button below to open a new message addressed to <strong>CardboardBonfire@gmail.com</strong>.</p>
                <div style="max-width:640px;">
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button id="contact-mailto" class="btn-primary">Email CardboardBonfire@gmail.com</button>
                        <button id="contact-copy" class="btn-secondary">Copy Email</button>
                    </div>
                    <p id="contact-status" class="muted" style="margin-top:8px;"></p>
                </div>
            `;

            document.getElementById('contact-mailto').addEventListener('click', () => {
                const subject = encodeURIComponent("Contact from MTG Life Tracker");
                const body = encodeURIComponent("Hi,\n\nI'd like to get in touch regarding...");
                window.location.href = `mailto:CardboardBonfire@gmail.com?subject=${subject}&body=${body}`;
            });

            document.getElementById('contact-copy').addEventListener('click', async () => {
                const status = document.getElementById('contact-status');
                try {
                    await navigator.clipboard.writeText('CardboardBonfire@gmail.com');
                    status.textContent = 'Email address copied to clipboard.';
                } catch (e) {
                    console.error('Copy failed', e);
                    status.textContent = 'Unable to copy automatically — please select and copy: CardboardBonfire@gmail.com';
                }
            });
        }

        // ----------------------------------------------------------------------
        // 6. EXISTING APP: Setup View, Room List, Room View (stylized), etc.
        // ----------------------------------------------------------------------

        async function renderSetupView() {
            const appContainer = document.getElementById("app-container");
            const statusMessage = document.getElementById("status-message");
            roomId = null;

            // Hide preview card and modal when changing views
            const previewCard = document.getElementById('lobby-card-preview');
            const previewImg = document.getElementById('preview-img');
            previewCard.style.display = 'none';
            document.getElementById('card-search-modal').style.display = 'none';

            statusMessage.textContent = "Browse rooms or create a new one.";
            statusMessage.style.color = "#9aa3ad";

            let listHtml = '<p style="color:var(--text);">Loading active rooms...</p>';
            appContainer.innerHTML = `
                <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                    <div style="flex:1;">
                        <input type="text" id="search-input" placeholder="Enter Room ID to Create/Search">
                    </div>
                    <div style="width:160px;">
                        <button id="search-btn" class="btn-primary" style="width:100%;">Find or Create Room</button>
                    </div>
                </div>
                <h3 style="color:var(--text); margin-top:0;">Active Rooms</h3>
                <div id="room-list-container">${listHtml}</div>
                <div style="margin-top:12px;">
                    <button id="delete-all-rooms-btn" class="btn-danger">Delete All Rooms (Admin)</button>
                </div>
            `;

            try {
                const q = query(collection(db, ROOM_COLLECTION), limit(15));
                const snap = await getDocs(q);
                if (snap.empty) {
                    listHtml = '<p style="color:var(--text);">No active rooms. Create one above!</p>';
                } else {
                    listHtml = '';
                    snap.forEach(docSnap => {
                        const rData = docSnap.data();
                        const rId = docSnap.id;
                        const pCount = Object.keys(rData.players || {}).length;
                        const ownerPlayer = rData.players[rData.ownerId];
                        const ownerCmdName = ownerPlayer?.commanderName || ownerPlayer?.commander || 'N/A';
                        const ownerCmdImage = ownerPlayer?.commanderImageUrl || '';
                        const ownerName = ownerPlayer?.name || 'Owner';

                        listHtml += `
                            <div class="room-item" style="display:flex; justify-content:space-between; align-items:center; background-color:#121416; padding: 12px; margin-bottom: 8px; border-radius: 8px; border:1px solid var(--dark-border);">
                                <div class="room-info">
                                    <div style="font-weight:800; color:var(--text);">${rId}</div>
                                    <div style="font-size:0.9em; color:var(--muted); margin-top:6px;">
                                        ${pCount} Player(s) • Owner: ${ownerName}
                                        <span class="lobby-cmd-name" data-img-url="${ownerCmdImage}" style="cursor:help; margin-left:8px; color:var(--muted);">[${ownerCmdName}]</span>
                                    </div>
                                </div>
                                <div>
                                    <button class="join-btn btn-secondary" data-rid="${rId}" style="width:auto;">Join</button>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (e) {
                console.error("List error:", e);
                listHtml = `<p style="color:#ff5555;">Error loading rooms. Permissions might be initializing...</p>`;
            }

            const listContainer = document.getElementById("room-list-container");
            if (listContainer) listContainer.innerHTML = listHtml;

            // Attach listeners
            if (listContainer) {
                listContainer.querySelectorAll('.join-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        promptPassword(e.target.dataset.rid, 'join');
                    });
                });

                const previewCardEl = document.getElementById('lobby-card-preview');
                const previewImgEl = document.getElementById('preview-img');

                listContainer.querySelectorAll('.lobby-cmd-name').forEach(cmdSpan => {
                    const imageUrl = cmdSpan.dataset.imgUrl;
                    cmdSpan.addEventListener('mouseenter', () => {
                        if (imageUrl && previewCardEl && previewImgEl) {
                            previewImgEl.src = imageUrl;
                            previewCardEl.style.display = 'block';
                        }
                    });

                    cmdSpan.addEventListener('mouseleave', () => {
                        if (previewCardEl) {
                            previewCardEl.style.display = 'none';
                            previewImgEl.src = '';
                        }
                    });
                });
            }

            document.getElementById("search-btn").onclick = async () => {
                const val = document.getElementById("search-input").value.trim().toLowerCase();
                if (!val) return;
                const snap = await getDoc(doc(db, ROOM_COLLECTION, val));
                if (snap.exists()) promptPassword(val, 'join');
                else promptPassword(val, 'create');
            };

            document.getElementById("delete-all-rooms-btn").addEventListener('click', deleteAllRooms);
        }

        // --- Stylized Room view rendering ---
        function renderChat(chatLog, playerName) {
            const chatLogDiv = document.getElementById('chat-log');
            if (!chatLogDiv) return;
            chatLogDiv.innerHTML = '';
            const displayLog = (chatLog || []).slice(-20);
            displayLog.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message');
                const senderSpan = document.createElement('span');
                senderSpan.classList.add('chat-sender');
                senderSpan.textContent = `${msg.senderName}:`;
                if (msg.senderName === playerName) senderSpan.style.color = '#74b9ff';
                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(document.createTextNode(' ' + msg.message));
                chatLogDiv.appendChild(messageDiv);
            });
            chatLogDiv.scrollTop = chatLogDiv.scrollHeight;
        }

        function renderRoomView(roomData) {
            const appContainer = document.getElementById("app-container");
            const statusMessage = document.getElementById("status-message");
            document.getElementById('lobby-card-preview').style.display = 'none';
            document.getElementById('card-search-modal').style.display = 'none';

            const currentPlayerName = roomData.players[userId]?.name || 'You';
            statusMessage.innerHTML = `Connected as: <strong>${currentPlayerName}</strong>`;

            // Header and controls
            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
                    <div>
                        <h2 style="margin:0; color:var(--text);">Room: ${roomId}</h2>
                        <div style="color:var(--muted); font-size:0.9rem; margin-top:6px;">Players: ${Object.keys(roomData.players).length}</div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button id="card-search-btn" class="btn-secondary">Card Search</button>
                        <button id="share-invite-btn" class="btn-secondary">Share Invite</button>
                        <button id="leave-room-btn" class="btn-danger">Leave Room</button>
                    </div>
                </div>
            `;

            // Player grid
            const playerIds = Object.keys(roomData.players);
            // sort so current user appears first
            playerIds.sort((a,b) => (a === userId ? -1 : b === userId ? 1 : 0));

            html += `<div class="player-grid">`;

            playerIds.forEach(playerId => {
                const player = roomData.players[playerId];
                const isMe = playerId === userId;
                const life = player.life ?? getStartingLife();
                const cmdDamageMap = player.commanderDamage || {};
                // compute total commander damage taken from others (sum of incoming damage)
                // For display we will show per-opponent damage only when viewing a player's panel (kept simple)
                const commanderName = player.commanderName || player.commander || 'N/A';

                html += `
                    <div class="player-panel" data-player-id="${playerId}">
                        <div class="player-header">
                            <div>
                                <div class="player-name">${isMe ? 'YOU' : (player.name || 'Player')}</div>
                                <div class="player-sub">Commander: ${commanderName}</div>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                                ${isMe ? `<div class="you-badge">YOU</div>` : `<div class="player-sub">ID: ${playerId.slice(0,6)}</div>`}
                                <div class="player-sub" style="font-size:0.85rem;">Life</div>
                            </div>
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                            <div>
                                <div class="life-big" id="life-display-${playerId}">${life}</div>
                                <div style="margin-top:8px;">
                                    <div class="cmd-block">
                                        <div>
                                            <div class="cmd-label">CMD DMG</div>
                                            <div class="cmd-value" id="cmd-total-${playerId}">${computeIncomingCmdDamage(roomData, playerId)}</div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div class="player-sub">Commander</div>
                                            <div style="font-weight:700; color:var(--muted); font-size:0.85rem;">${commanderName}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="min-width:160px; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                                <div class="controls" style="flex-direction:column; width:100%;">
                                    <div style="display:flex; gap:8px; width:100%;">
                                        <button class="control-btn negative" data-action="life" data-player="${playerId}" data-delta="-5" ${isMe ? '' : 'disabled'}>-5</button>
                                        <button class="control-btn negative" data-action="life" data-player="${playerId}" data-delta="-1" ${isMe ? '' : 'disabled'}>-1</button>
                                        <button class="control-btn positive" data-action="life" data-player="${playerId}" data-delta="+1" ${isMe ? '' : 'disabled'}>+1</button>
                                        <button class="control-btn positive" data-action="life" data-player="${playerId}" data-delta="+5" ${isMe ? '' : 'disabled'}>+5</button>
                                    </div>
                                    <div style="display:flex; gap:8px; width:100%;">
                                        <button class="control-btn" data-action="cmd-toggle" data-player="${playerId}" ${isMe ? '' : 'disabled'}>CMD DMG</button>
                                        <button class="control-btn" data-action="show-commander" data-player="${playerId}">Preview</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="cmd-controls" id="cmd-controls-${playerId}" style="display:none; margin-top:10px;">
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input type="number" id="cmd-input-${playerId}" placeholder="Enter damage" style="width:120px; padding:8px; border-radius:8px; border:1px solid var(--dark-border); background:var(--input-bg); color:var(--text);">
                                <button class="control-btn negative" data-action="cmd-set" data-player="${playerId}" ${isMe ? '' : 'disabled'}>Set</button>
                                <button class="control-btn negative" data-action="cmd-add" data-player="${playerId}" ${isMe ? '' : 'disabled'}>+1</button>
                                <button class="control-btn negative" data-action="cmd-sub" data-player="${playerId}" ${isMe ? '' : 'disabled'}>-1</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`; // end player-grid

            // Chat and tools
            html += `
                <div id="lobby-features">
                    <div style="flex:1; min-width:260px;">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button id="roll-dice-btn" class="btn-secondary">Roll D20</button>
                            <div id="roll-result" style="font-weight:800; color:var(--text); margin-left:8px;">-</div>
                        </div>
                    </div>
                    <div style="min-width:320px;">
                        <div id="chat-container">
                            <div style="font-weight:700; color:var(--text); margin-bottom:8px;">Game Chat</div>
                            <div id="chat-log"></div>
                            <form id="chat-input-form" style="display:flex; gap:8px; margin-top:8px;">
                                <input type="text" id="chat-message-input" placeholder="Type message..." maxlength="150" required>
                                <button type="submit" class="btn-primary">Send</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="room-footer">
                    <div class="muted">This view is styled for quick tabletop play. Your state is saved to the room in Firebase.</div>
                    <div class="muted">Tip: Hover commander names to preview cards.</div>
                </div>
            `;

            appContainer.innerHTML = html;

            // render chat
            renderChat(roomData.chatLog || [], currentPlayerName);

            // Attach listeners for panel controls
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = btn.dataset.action;
                    const targetPlayer = btn.dataset.player;
                    const delta = parseInt(btn.dataset.delta || '0');

                    // life adjustments: only allowed for current player (isMe)
                    if (action === 'life') {
                        if (targetPlayer === userId) {
                            updateLife(delta);
                        } else {
                            // disabled by attribute; do nothing
                        }
                    } else if (action === 'cmd-toggle') {
                        const controls = document.getElementById(`cmd-controls-${targetPlayer}`);
                        if (controls) controls.style.display = (controls.style.display === 'none') ? 'block' : 'none';
                    } else if (action === 'show-commander') {
                        // show preview in fixed left preview if image exists
                        const imgUrl = roomData.players[targetPlayer]?.commanderImageUrl;
                        const previewCard = document.getElementById('lobby-card-preview');
                        const previewImg = document.getElementById('preview-img');
                        if (imgUrl && previewCard && previewImg) {
                            previewImg.src = imgUrl;
                            previewCard.style.display = 'block';
                            setTimeout(() => { previewCard.style.display = 'none'; previewImg.src = ''; }, 3500);
                        }
                    } else if (action === 'cmd-set') {
                        const input = document.getElementById(`cmd-input-${targetPlayer}`);
                        if (input) {
                            const val = parseInt(input.value) || 0;
                            // set incoming damage from current user to targetPlayer
                            // updateCmdDamageDirectly expects oppId and newValue for current user
                            // Here we treat oppId as the opponent (targetPlayer) for the current player's commanderDamage map
                            updateCmdDamageDirectly(targetPlayer, val);
                        }
                    } else if (action === 'cmd-add') {
                        // increment by 1
                        updateCmdDamage(targetPlayer, +1);
                    } else if (action === 'cmd-sub') {
                        updateCmdDamage(targetPlayer, -1);
                    }
                });
            });

            // chat submit
            const chatForm = document.getElementById('chat-input-form');
            if (chatForm) {
                chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = document.getElementById('chat-message-input');
                    const message = input.value.trim();
                    if (message) {
                        sendChatMessage(message, currentPlayerName);
                        input.value = '';
                    }
                });
            }

            // roll dice
            document.getElementById('roll-dice-btn').addEventListener('click', () => {
                const roll = Math.floor(Math.random() * 20) + 1;
                document.getElementById('roll-result').textContent = roll;
            });

            // card search modal
            document.getElementById('card-search-btn').addEventListener('click', () => {
                document.getElementById('card-search-modal').style.display = 'flex';
                document.getElementById('modal-card-name').value = '';
                document.getElementById('search-results').innerHTML = '';
            });

            // share invite
            document.getElementById('share-invite-btn').addEventListener('click', () => {
                const roomUrl = `${window.location.origin}${window.location.pathname}?roomID=${roomId}`;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(roomUrl).then(() => alert(`Invite link copied to clipboard: ${roomUrl}`)).catch(err => console.error(err));
                } else {
                    prompt(`Invite link (Copy Manually):`, roomUrl);
                }
            });

            // leave room
            document.getElementById('leave-room-btn').addEventListener('click', () => {
                if (unsubscribe) unsubscribe();
                roomId = null;
                window.history.pushState({}, document.title, window.location.pathname);
                navigateTo('home');
            });

            // delete / refresh buttons (kept if present)
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) refreshBtn.addEventListener('click', () => { if (roomId) listenToRoom(roomId); });

            const deleteBtn = document.getElementById('delete-room-btn');
            if (deleteBtn) deleteBtn.addEventListener('click', () => {
                if (confirm("Are you sure you want to delete this room for ALL players?")) deleteRoom(roomId);
            });

            // commander hover preview wiring (for panels)
            playerIds.forEach(playerId => {
                const panel = document.querySelector(`.player-panel[data-player-id="${playerId}"]`);
                if (panel) {
                    const previewCard = document.getElementById('lobby-card-preview');
                    const previewImg = document.getElementById('preview-img');
                    panel.querySelectorAll('.player-sub').forEach(el => {
                        // no-op; preview handled by "Preview" button
                    });
                }
            });

            // expose direct update helpers globally
            window.updateCmdDamageDirectly = updateCmdDamageDirectly;
            window.updateLifeDirectly = updateLifeDirectly;
        }

        // helper to compute incoming commander damage for display (sum of all players' commanderDamage maps where target is playerId)
        function computeIncomingCmdDamage(roomData, targetPlayerId) {
            let total = 0;
            const players = roomData.players || {};
            Object.keys(players).forEach(pid => {
                const dmgMap = players[pid]?.commanderDamage || {};
                const val = dmgMap[targetPlayerId] || 0;
                total += val;
            });
            return total;
        }

        // --- Chat & data helpers (kept) ---
        async function sendChatMessage(message, senderName) {
            if (!roomId || !userId) return;
            const ref = doc(db, ROOM_COLLECTION, roomId);
            const chatMessage = { senderId: userId, senderName, message, timestamp: Date.now() };
            try {
                await setDoc(ref, { chatLog: arrayUnion(chatMessage), lastActive: serverTimestamp() }, { merge: true });
            } catch (e) { console.error("Error sending chat message:", e); }
        }

        async function updateLifeDirectly(newValue) {
            if (!roomId || !userId) return;
            const ref = doc(db, ROOM_COLLECTION, roomId);
            const newLife = parseInt(newValue) || 0;
            try {
                const snap = await getDoc(ref);
                if (!snap.exists()) return;
                await setDoc(ref, { players: { [userId]: { life: newLife } }, lastActive: serverTimestamp() }, { merge: true });
            } catch (e) { console.error("Error setting life total directly:", e); }
        }

        async function updateLife(delta) {
            if (!roomId || !userId) return;
            const ref = doc(db, ROOM_COLLECTION, roomId);
            try {
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data();
                    const cur = data.players[userId]?.life ?? getStartingLife();
                    await updateLifeDirectly(cur + delta);
                }
            } catch (e) { console.error(e); }
        }

        async function updateCmdDamage(oppId, delta) {
            if (!roomId || !userId) return;
            const ref = doc(db, ROOM_COLLECTION, roomId);
            try {
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data();
                    const currentPlayer = data.players[userId];
                    if (!currentPlayer) return;
                    const currentDamageMap = currentPlayer.commanderDamage || {};
                    const currentDamage = currentDamageMap[oppId] || 0;
                    const newDamage = Math.max(0, currentDamage + delta);
                    await updateCmdDamageDirectly(oppId, newDamage);
                }
            } catch (e) { console.error("Error updating commander damage:", e); }
        }

        async function updateCmdDamageDirectly(oppId, newValue) {
            if (!roomId || !userId) return;
            const ref = doc(db, ROOM_COLLECTION, roomId);
            const newDamage = Math.max(0, parseInt(newValue) || 0);
            try {
                const snap = await getDoc(ref);
                if (!snap.exists()) return;
                const data = snap.data();
                const currentPlayer = data.players[userId];
                if (!currentPlayer) return;
                const currentDamageMap = currentPlayer.commanderDamage || {};
                currentDamageMap[oppId] = newDamage;
                await setDoc(ref, {
                    players: {
                        [userId]: {
                            ...currentPlayer,
                            commanderDamage: currentDamageMap
                        }
                    },
                    lastActive: serverTimestamp()
                }, { merge: true });
            } catch (e) { console.error("Error setting commander damage directly:", e); }
        }

        // --- Room creation / join flows (kept) ---
        function promptPassword(rid, mode) {
            const appContainer = document.getElementById("app-container");
            const title = mode === 'join' ? `Join Room: ${rid}` : `Create Room: ${rid}`;
            const btnText = mode === 'join' ? "Enter Game" : "Create Room";
            document.getElementById('lobby-card-preview').style.display = 'none';
            document.getElementById('card-search-modal').style.display = 'none';

            appContainer.innerHTML = `
                <h2 style="color:var(--text); margin-top:0;">${title}</h2>
                <input type="text" id="player-name-input" placeholder="Your Player Name">
                <div style="position:relative;">
                    <input type="text" id="commander-input" placeholder="Your Commander's Name (Required)" autocomplete="off">
                    <div id="suggestions-list" class="suggestions-list"></div>
                </div>
                <input type="password" id="pwd-input" placeholder="Room Password">
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button id="action-btn" class="btn-primary">${btnText}</button>
                    <button id="cancel-btn" class="btn-danger">Cancel</button>
                </div>
                <p id="err-msg" style="color:#ff5555;"></p>
            `;

            const commanderInput = document.getElementById('commander-input');
            const suggestionsList = document.getElementById('suggestions-list');

            commanderInput.addEventListener('input', () => {
                const query = commanderInput.value.trim();
                if (autocompleteTimeout) clearTimeout(autocompleteTimeout);
                if (query.length >= 2) {
                    autocompleteTimeout = setTimeout(() => fetchAutocompleteSuggestions(query, 'suggestions-list', 'commander-input'), AUTOCOMPLETE_DEBOUNCE_MS);
                } else suggestionsList.innerHTML = '';
            });

            document.addEventListener('click', (e) => {
                if (suggestionsList && !commanderInput.contains(e.target) && !suggestionsList.contains(e.target)) suggestionsList.innerHTML = '';
            });

            document.getElementById("cancel-btn").onclick = () => {
                window.history.pushState({}, document.title, window.location.pathname);
                navigateTo('home');
            };

            document.getElementById("action-btn").onclick = async () => {
                const name = document.getElementById("player-name-input").value.trim();
                const commander = document.getElementById("commander-input").value.trim();
                const pwd = document.getElementById("pwd-input").value;
                const errMsg = document.getElementById("err-msg");
                if (!name || !pwd || !commander) { errMsg.textContent = "Player Name, Commander, and Password are required."; return; }
                errMsg.textContent = "Verifying commander and joining...";
                document.getElementById("action-btn").disabled = true;
                const validationResult = await validateCommander(commander);
                if (!validationResult) {
                    errMsg.textContent = `Commander "${commander}" not found on Scryfall. Please check spelling or use the Card Search tool.`;
                    document.getElementById("action-btn").disabled = false;
                    return;
                }
                const { validatedName, imageUrl } = validationResult;
                if (mode === 'join') {
                    const ref = doc(db, ROOM_COLLECTION, rid);
                    const snap = await getDoc(ref);
                    if (snap.exists()) {
                        const data = snap.data();
                        if (await checkAndDeleteIfExpired(rid, data)) {
                            errMsg.textContent = "Room expired and was deleted.";
                            setTimeout(() => navigateTo('home'), 2000);
                            return;
                        }
                        if (data.passwordHash === hashPassword(pwd)) {
                            listenToRoom(rid, name, validatedName, imageUrl);
                        } else {
                            errMsg.textContent = "Wrong password.";
                            document.getElementById("action-btn").disabled = false;
                        }
                    } else {
                        errMsg.textContent = "Room no longer exists.";
                        document.getElementById("action-btn").disabled = false;
                    }
                } else {
                    if (pwd.length < 3) {
                        errMsg.textContent = "Password too short.";
                        document.getElementById("action-btn").disabled = false;
                        return;
                    }
                    createRoom(rid, pwd, name, validatedName, imageUrl);
                }
            };
        }

        async function createRoom(rid, pwd, name, commanderName, commanderImageUrl) {
            if (!userId) return;
            const ref = doc(db, ROOM_COLLECTION, rid);
            try {
                await setDoc(ref, {
                    ownerId: userId,
                    passwordHash: hashPassword(pwd),
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                    chatLog: [],
                    players: {
                        [userId]: {
                            life: getStartingLife(),
                            commanderDamage: {},
                            name,
                            commanderName,
                            commanderImageUrl
                        }
                    }
                });
                listenToRoom(rid);
            } catch (e) { console.error(e); }
        }

        function listenToRoom(rid, newName = null, newCommanderName = null, newCommanderImageUrl = null) {
            if (unsubscribe) unsubscribe();
            const ref = doc(db, ROOM_COLLECTION, rid);
            unsubscribe = onSnapshot(ref, (snap) => {
                if (snap.exists()) {
                    roomId = rid;
                    const data = snap.data();
                    if (!data.players[userId]) {
                        if (newName && newCommanderName && newCommanderImageUrl) {
                            setDoc(ref, {
                                players: {
                                    [userId]: {
                                        life: getStartingLife(),
                                        commanderDamage: {},
                                        name: newName,
                                        commanderName: newCommanderName,
                                        commanderImageUrl: newCommanderImageUrl
                                    }
                                },
                                lastActive: serverTimestamp()
                            }, { merge: true });
                        } else {
                            renderSetupView();
                            return;
                        }
                    }
                    renderRoomView(data);
                } else {
                    renderSetupView();
                }
            });
        }

        // --- Admin / misc helpers ---
        async function deleteAllRooms() {
            const password = prompt("Enter the global deletion password to confirm this action:");
            if (password !== DELETE_ALL_PWD) { alert("Incorrect password. All rooms were NOT deleted."); return; }
            if (!confirm("LAST WARNING: Are you absolutely sure you want to delete ALL rooms? This cannot be undone.")) return;
            document.getElementById("status-message").textContent = "Deleting all rooms...";
            const roomsRef = collection(db, ROOM_COLLECTION);
            try {
                const snapshot = await getDocs(roomsRef);
                let deleteCount = 0;
                for (const docSnapshot of snapshot.docs) {
                    await deleteDoc(doc(db, ROOM_COLLECTION, docSnapshot.id));
                    deleteCount++;
                }
                alert(`Success! Deleted ${deleteCount} room(s).`);
                renderSetupView();
            } catch (e) {
                console.error("Failed to delete all rooms:", e);
                alert("An error occurred during bulk deletion. Check the console.");
            }
        }

        function determineTurnOrder(players) {
            const playerNames = Object.values(players).map(p => p.name || 'Unknown Player');
            if (playerNames.length < 2) { alert("Need at least two players to determine turn order."); return; }
            for (let i = playerNames.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [playerNames[i], playerNames[j]] = [playerNames[j], playerNames[i]];
            }
            const orderText = `Turn Order:\n1. ${playerNames[0]}\n2. ${playerNames[1]}${playerNames[2] ? `\n3. ${playerNames[2]}` : ''}\n...`;
            alert(orderText);
        }

        async function deleteRoom(id) {
            if (!id) return;
            try {
                await deleteDoc(doc(db, ROOM_COLLECTION, id));
                if (unsubscribe) unsubscribe();
                roomId = null;
                renderSetupView();
            } catch (e) {
                alert("Failed to delete room. Check console for details.");
                console.error("Delete room failed:", e);
            }
        }

        // ----------------------------------------------------------------------
        // 7. Modal & autocomplete wiring (kept)
        // ----------------------------------------------------------------------
        const modalCardNameInput = document.getElementById('modal-card-name');
        const modalSuggestionsList = document.getElementById('modal-suggestions-list');
        let modalAutocompleteTimeout = null;

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('card-search-modal').style.display = 'none';
        });

        modalCardNameInput.addEventListener('input', () => {
            const query = modalCardNameInput.value.trim();
            if (modalAutocompleteTimeout) clearTimeout(modalAutocompleteTimeout);
            if (query.length >= 2) {
                modalAutocompleteTimeout = setTimeout(() => fetchAutocompleteSuggestions(query, 'modal-suggestions-list', 'modal-card-name'), AUTOCOMPLETE_DEBOUNCE_MS);
            } else modalSuggestionsList.innerHTML = '';
        });

        document.getElementById('modal-search-btn').addEventListener('click', () => {
            modalSuggestionsList.innerHTML = '';
            const cardName = modalCardNameInput.value.trim();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<p style="color:var(--text);">Searching...</p>';
            if (!cardName) { resultsDiv.innerHTML = '<p style="color:var(--text);">Please enter a card name.</p>'; return; }
            validateCommander(cardName).then(result => {
                if (result) {
                    resultsDiv.innerHTML = `<h4 style="color:var(--text);">${result.validatedName}</h4><img src="${result.imageUrl}" alt="${result.validatedName}">`;
                } else {
                    resultsDiv.innerHTML = `<p style="color:var(--text);">Card not found. Check spelling.</p>`;
                }
            }).catch(e => {
                resultsDiv.innerHTML = `<p style="color:var(--text);">Error connecting to Scryfall.</p>`;
                console.error(e);
            });
        });

        // ----------------------------------------------------------------------
        // 8. INIT: Auth + initial route
        // ----------------------------------------------------------------------
        function initialRoute() {
            const params = new URLSearchParams(window.location.search);
            const idFromURL = params.get('roomID');
            if (idFromURL) {
                promptPassword(idFromURL, 'join');
                setActiveNav('home');
                return;
            }
            const page = (location.hash || '#home').replace('#', '') || 'home';
            setActiveNav(page);
            if (page === 'home') renderHome();
            else if (page === 'changes') renderChanges();
            else if (page === 'contact') renderContact();
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                initialRoute();
            } else {
                signInAnonymously(auth).catch(e => {
                    document.getElementById("status-message").textContent = "Auth Error: " + e.message;
                });
            }
        });

    </script>
</body>
</html>
